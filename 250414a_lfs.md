# Linux From Scratch

主要涵盖[LFS](https://www.linuxfromscratch.org/lfs/)和[BLFS](https://www.linuxfromscratch.org/blfs/)，BLFS仅挑选部分内容实现

V12.3

构建平台 x86_64 Intel CoffeeLake ASRock Z390M-PRO4 AlpineLinux v3.21

目标平台 x86_64 Intel Haswell-R ASRock H81M-HDS

## 目录

+ [**1**](#1-lfs准备工作) LFS：准备工作
    + [**1.1**](#11-标准解读lsb30需要的包) 标准解读：LSB3.0需要的包
        + [**1.1.1**](#111-lsb-core) LSB Core
        + [**1.1.2**](#112-lsb-desktop) LSB Desktop
        + [**1.1.3**](#113-lsb-languages) LSB Languages
        + [**1.1.4**](#114-lsb-imaging) LSB Imaging
    + [**1.2**](#12-lfs源码准备) LFS源码准备
    + [**1.3**](#13-lfs补丁准备) LFS补丁准备
    + [**1.4**](#14-lfs目录创建) LFS目录创建
    + [**1.5**](#15-环境) 环境
+ [**2**](#2-lfs构建交叉工具链与基础组件) LFS：构建交叉工具链与基础组件
    + [**2.1**](#21-基本概念) 基本概念
        + [**2.1.1**](#211-triplet名) triplet名
        + [**2.1.2**](#212-动态链接器) 动态链接器
        + [**2.1.3**](#213-canadian-cross) Canadian Cross
        + [**2.1.4**](#214-libgcc) libgcc
    + [**2.2**](#22-构建交叉工具链1) 构建交叉工具链1
        + [**2.2.1**](#221-构建顺序) 构建顺序
        + [**2.2.2**](#222-binutils) binutils
        + [**2.2.3**](#223-gcc) gcc
        + [**2.2.4**](#224-linux-headers) linux-headers
        + [**2.2.5**](#225-glibc) glibc
        + [**2.2.4**](#224-libstdc) libstdc++
    + [**2.3**](#23-交叉构建基础组件) 交叉构建基础组件
        + [**2.3.1**](#231-m4) m4
        + [**2.3.2**](#232-ncurses) ncurses
        + [**2.3.3**](#233-bash) bash
        + [**2.3.4**](#234-coreutils) coreutils
        + [**2.3.5**](#235-diffutils) diffutils
        + [**2.3.6**](#236-file) file
        + [**2.3.7**](#237-findutils) findutils
        + [**2.3.8**](#238-gawk) gawk
        + [**2.3.9**](#239-grep) grep
        + [**2.3.10**](#2310-gzip) gzip
        + [**2.3.11**](#2311-make) make
        + [**2.3.12**](#2312-patch) patch
        + [**2.3.13**](#2313-sed) sed
        + [**2.3.14**](#2314-tar) tar
        + [**2.3.15**](#2315-xz) xz
        + [**2.3.16**](#2316-binutils) binutils
        + [**2.3.17**](#2317-gcc) gcc
    + [**2.4**](#24-chroot后续构建) chroot后续构建
        + [**2.4.1**](#241-准备工作) 准备工作
        + [**2.4.2**](#242-chroot) chroot
        + [**2.4.3**](#243-gettext) gettext
        + [**2.4.4**](#244-bison) bison
        + [**2.4.5**](#245-perl) perl
        + [**2.4.6**](#246-python) python
        + [**2.4.7**](#247-texinfo) texinfo
        + [**2.4.8**](#248-util-linux) util-linux
        + [**2.4.9**](#249-清理并备份lfs目录) 清理并备份LFS目录
+ [**3**](#3-lfs构建系统剩余部分) LFS：构建系统剩余部分
    + [**3.1**](#31-简介) 简介
    + [**3.2**](#32-包管理) 包管理
    + [**3.3**](#33-剩余部分构建) 剩余部分构建
        + [**3.3.1**](#331-man-pages) man-pages
        + [**3.3.2**](#332-iana-etc) iana-etc
        + [**3.3.3**](#333-glibc) glibc
        + [**3.3.4**](#334-zlib) zlib
        + [**3.3.5**](#335-bzip2) bzip2
        + [**3.3.6**](#336-xz) xz
        + [**3.3.7**](#337-lz4) lz4
        + [**3.3.8**](#338-zstd) zstd
        + [**3.3.9**](#339-file) file
        + [**3.3.10**](#3310-readline) readline
        + [**3.3.11**](#3311-m4) m4
        + [**3.3.12**](#3312-bc) bc
        + [**3.3.13**](#3313-flex) flex
        + [**3.3.14**](#3314-tcl) tcl
        + [**3.3.15**](#3315-expect) expect
        + [**3.3.16**](#3316-dejagnu) dejagnu
        + [**3.3.17**](#3317-pkgconf) pkgconf
        + [**3.3.18**](#3318-binutils) binutils
        + [**3.3.19**](#3319-gmp) gmp
        + [**3.3.20**](#3320-mpfr) mpfr
        + [**3.3.21**](#3321-mpc) mpc
        + [**3.3.22**](#3322-attr) attr
        + [**3.3.23**](#3323-acl) acl
        + [**3.3.24**](#3324-libcap) libcap
        + [**3.3.25**](#3325-libxcrypt) libxcrypt
        + [**3.3.26**](#3326-shadow) shadow
        + [**3.3.27**](#3327-gcc) gcc
        + [**3.3.28**](#3328-ncurses) ncurses
        + [**3.3.29**](#3329-sed) sed
        + [**3.3.30**](#3330-psmisc) psmisc
        + [**3.3.31**](#3331-gettext) gettext
        + [**3.3.32**](#3332-bison) bison
        + [**3.3.33**](#3333-grep) grep
        + [**3.3.34**](#3334-bash) bash
        + [**3.3.35**](#3335-libtool) libtool
        + [**3.3.36**](#3336-gdbm) gdbm
        + [**3.3.37**](#3337-gperf) gperf
        + [**3.3.38**](#3338-expat) expat
        + [**3.3.39**](#3339-inetutils) inetutils
        + [**3.3.40**](#3340-less) less
        + [**3.3.41**](#3341-perl) perl
        + [**3.3.42**](#3342-xmlparser) xml::parser
        + [**3.3.43**](#3343-intltool) intltool
        + [**3.3.44**](#3344-autoconf) autoconf
        + [**3.3.45**](#3345-automake) automake
        + [**3.3.46**](#3346-openssl) openssl
        + [**3.3.47**](#3347-libelf) libelf
        + [**3.3.48**](#3348-libffi) libffi
        + [**3.3.49**](#3349-python) python
        + [**3.3.50**](#3350-flit-core) flit-core
        + [**3.3.51**](#3351-wheel) wheel
        + [**3.3.52**](#3352-setuptools) setuptools
        + [**3.3.53**](#3353-ninja) ninja
        + [**3.3.54**](#3354-meson) meson
        + [**3.3.55**](#3355-kmod) kmod
        + [**3.3.56**](#3356-coreutils) coreutils
        + [**3.3.57**](#3357-check) check
        + [**3.3.58**](#3358-diffutils) diffutils
        + [**3.3.59**](#3359-gawk) gawk
        + [**3.3.60**](#3360-findutils) findutils
        + [**3.3.61**](#3361-groff) groff
        + [**3.3.62**](#3362-grub) grub
        + [**3.3.63**](#3363-gzip) gzip
        + [**3.3.64**](#3364-iproute2) iproute2
        + [**3.3.65**](#3365-kbd) kbd
        + [**3.3.66**](#3366-libpipeline) libpipeline
        + [**3.3.67**](#3367-make) make
        + [**3.3.68**](#3368-patch) patch
        + [**3.3.69**](#3369-tar) tar
        + [**3.3.70**](#3370-texinfo) texinfo
        + [**3.3.71**](#3371-vim) vim
        + [**3.3.72**](#3372-markupsafe) markupsafe
        + [**3.3.73**](#3373-jinja2) jinja2
        + [**3.3.74**](#3374-udev) udev
        + [**3.3.75**](#3375-man-db) man-db
        + [**3.3.76**](#3376-procps-ng) procps-ng
        + [**3.3.77**](#3377-util-linux) util-linux
        + [**3.3.78**](#3378-e2fsprogs) e2fsprogs
        + [**3.3.79**](#3379-sysklogd) sysklogd
        + [**3.3.80**](#3380-sysvinit) sysvinit
    + [**3.4**](#34-删除调试符号) 删除调试符号
    + [**3.5**](#35-清理临时文件) 清理临时文件
+ [**4**](#4-lfs系统配置) LFS：系统配置
    + [**4.1**](#41-sysvinit) sysvinit
        + [**4.1.1**](#411-安装启动脚本) 安装启动脚本
    + [**4.2**](#42-udev) udev
        + [**4.2.1**](#421-基本概念) 基本概念
        + [**4.2.2**](#422-设备管理) 设备管理
    + [**4.3**](#43-网络管理) 网络管理
        + [**4.3.1**](#431-接口配置文件) 接口配置文件
        + [**4.3.2**](#432-dns) DNS
        + [**4.3.3**](#433-主机名) 主机名
        + [**4.3.4**](#434-hosts) hosts
    + [**4.4**](#44-sysvinit配置与使用) sysvinit配置与使用
        + [**4.4.1**](#441-runlevel) runlevel
        + [**4.4.2**](#442-inittab) inittab
        + [**4.4.3**](#443-切换runlevel) 切换runlevel
        + [**4.4.4**](#444-udev启动脚本) udev启动脚本
        + [**4.4.5**](#445-系统时钟) 系统时钟
        + [**4.4.6**](#446-终端配置) 终端配置
        + [**4.4.7**](#447-启动时创建文件) 启动时创建文件
        + [**4.4.8**](#448-配置sysklogd) 配置sysklogd
        + [**4.4.9**](#449-rcsite配置) rc.site配置
        + [**4.4.10**](#4410-启动加速) 启动加速
    + [**4.5**](#45-locale配置) locale配置
    + [**4.6**](#46-inputrc) inputrc
    + [**4.7**](#47-shell) shell
+ [**5**](#5-lfs内核编译与uefi启动引导) LFS：内核编译与UEFI启动引导
    + [**5.1**](#51-fstab) fstab
+ [**6**](#6-blfs和其他杂项) BLFS和其他杂项

## 1 LFS：准备工作

## 1.1 标准解读：LSB3.0需要的包

LSB（Linux Standard Base）Version 3.0

LSB只是一个推荐的标准，仅供参考，实际上不一定要完全按照LSB的来，有些包可以省略或自己选替代，也可以另外加想要的包和功能

### 1.1.1 LSB Core

LFS提供

```
bash bc binutils coreutils diffutils file findutils gawk gcc gettext glibc grep gzip m4 man-db procps psmisc sed shadow sysvinit tar util-linux zlib
```

BLFS提供

```
at batch blfs-bash-startup-files cpio ed fcrontab lsb-tools nspr nss linux-pam pax sendmail/postfix/exim time
```

其他

```
install_initd libxcrypt(libcrypt.so.1) ncurses(libncurses.so.5 libncursesw.so.6) 
```

> LSB 3.0要求提供`libncursesw.so.5`

### 1.1.2 LSB Desktop

BLFS提供

```
alsa atk cairo desktop-file-utils freetype fontconfig gdk-pixbuf glib2 glu icon-naming-utils libjpeg-turbo libxml2 mesa pango xdg-utils xorg
```

其他

```
gtk+3(libgdk-3.so libgtk-3.so) gtk4(libgtk-4.so) libpng(libpng16.so) qt6(libQt6*.so.6) libtiff(libtiff.so.6) libpng(libpng16.so)
```

> LSB 3.0要求提供`libgdk-x11-2.0.so libgtk-x11-2.0.so libpng12.so libQt*.so.4 libtiff.so.4 libpng15.so`

### 1.1.3 LSB Languages

LFS提供

```
perl
```

BLFS提供

```
libxml2 libxslt
```

其他

```
python(python3)
```

> LSB 3.0要求提供`python2`

### 1.1.4 LSB Imaging

BLFS提供

```
cups cups-filters ghostscript sane
```

## 1.2 LFS源码准备

共87个包

尽量使用`tarball`而不是克隆仓库

记得下载完成以后把所有包和补丁放到`$LFS/sources`再解压，并且最好是构建每个包之前再解压，否则容易遇到时间戳导致的怪问题

| 包名 | 版本 | 项目主页 | release tarball下载地址 | 仓库地址 |
| :- | :- | :- | :- | :- |
| `acl` | `2.3.2` | [nongnu.org](https://savannah.nongnu.org/projects/acl) | [下载](http://download.savannah.nongnu.org/releases/acl/acl-2.3.2.tar.gz) | [nongnu.org](https://git.savannah.nongnu.org/git/acl.git) |
| `attr` | `2.5.2` | [nongnu.org](https://savannah.nongnu.org/projects/attr) | [下载](http://download.savannah.nongnu.org/releases/attr/attr-2.5.2.tar.gz) | [nongnu.org](https://git.savannah.nongnu.org/git/attr.git) |
| `autoconf` | `2.72` | [gnu.org](https://www.gnu.org/software/autoconf/) | [下载](https://ftp.gnu.org/gnu/autoconf/autoconf-2.72.tar.xz) | [gnu.org](https://git.sv.gnu.org/r/autoconf.git) |
| `automake` | `1.17` | [gnu.org](https://www.gnu.org/software/automake/) | [下载](https://ftp.gnu.org/gnu/automake/automake-1.17.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/automake.git) |
| `bash` | `5.2.37` | [gnu.org](https://www.gnu.org/software/bash/) | [下载](https://ftp.gnu.org/gnu/bash/bash-5.2.37.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/bash.git) |
| `bc` | `7.0.3` | [github.com](https://github.com/gavinhoward/bc) | [下载](https://github.com/gavinhoward/bc/releases/download/7.0.3/bc-7.0.3.tar.xz) | [github.com](https://github.com/gavinhoward/bc.git) |
| `binutils` | `2.44` | [gnu.org](https://www.gnu.org/software/binutils/) | [下载](https://sourceware.org/pub/binutils/releases/binutils-2.44.tar.xz) | [sourceware.org](https://sourceware.org/git/binutils-gdb.git) |
| `bison` | `3.8.2` | [gnu.org](https://www.gnu.org/software/bison/) | [下载](https://ftp.gnu.org/gnu/bison/bison-3.8.2.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/bison.git) |
| `bzip2` | `1.0.8` | [sourceware.org](https://sourceware.org/bzip2/) | [下载](http://www.sourceware.org/pub/bzip2/bzip2-1.0.8.tar.gz) | [sourceware.org](https://sourceware.org/git/bzip2.git) |
| `check` | `0.15.2` | [github.io](https://libcheck.github.io/check/) | [下载](https://github.com/libcheck/check/releases/download/0.15.2/check-0.15.2.tar.gz) | [github.com](https://github.com/libcheck/check.git) |
| `coreutils` | `9.6` | [gnu.org](https://www.gnu.org/software/coreutils/) | [下载](https://ftp.gnu.org/gnu/coreutils/coreutils-9.6.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/coreutils.git) |
| `dejagnu` | `1.6.3` | [gnu.org](https://www.gnu.org/software/dejagnu/) | [下载](https://ftp.gnu.org/gnu/dejagnu/dejagnu-1.6.3.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/dejagnu.git) |
| `diffutils` | `3.11` | [gnu.org](https://www.gnu.org/software/diffutils/) | [下载](https://ftp.gnu.org/gnu/diffutils/diffutils-3.11.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/diffutils.git) |
| `e2fsprogs` | `1.47.2` | [sourceforge.net](https://e2fsprogs.sourceforge.net/) | [下载](https://mirrors.edge.kernel.org/pub/linux/kernel/people/tytso/e2fsprogs/v1.47.2/e2fsprogs-1.47.2.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/fs/ext2/e2fsprogs.git) |
| `elfutils` | `0.192` | [sourceware.org](https://sourceware.org/elfutils/) | [下载](https://sourceware.org/elfutils/ftp/0.192/elfutils-0.192.tar.bz2) | [sourceware.org](https://sourceware.org/git/elfutils.git) |
| `expat` | `2.6.4` | [github.io](https://libexpat.github.io/) | [下载](https://github.com/libexpat/libexpat/releases/download/R_2_6_4/expat-2.6.4.tar.xz) | [github.com](https://github.com/libexpat/libexpat.git) |
| `expect` | `5.45.4` | [tcl-lang.org](https://core.tcl-lang.org/expect/index) | [下载](https://prdownloads.sourceforge.net/expect/expect5.45.4.tar.gz) | [tcl-lang.org (fossil)](https://core.tcl-lang.org/expect) |
| `file` | `5.46` | [darwinsys.com](https://www.darwinsys.com/file/) | [下载](http://astron.com/pub/file/file-5.46.tar.gz) | [github.com](https://github.com/file/file.git) |
| `findutils` | `4.10.0` | [gnu.org](https://www.gnu.org/software/findutils/) | [下载](https://ftp.gnu.org/gnu/findutils/findutils-4.10.0.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/findutils.git) |
| `flex` | `2.6.4` | [github.com](https://github.com/westes/flex) | [下载](https://github.com/westes/flex/releases/download/v2.6.4/flex-2.6.4.tar.gz) | [github.com](https://github.com/westes/flex.git) |
| `flit-core` | `3.11.0` | [pypi.org](https://pypi.org/project/flit-core/) | [下载](https://files.pythonhosted.org/packages/source/f/flit-core/flit_core-3.11.0.tar.gz) | [github.com](https://github.com/pypa/flit.git) |
| `gawk` | `5.3.1` | [gnu.org](https://www.gnu.org/software/gawk/) | [下载](https://ftp.gnu.org/gnu/gawk/gawk-5.3.1.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/gawk.git) |
| `gcc` | `14.2.0` | [gnu.org](https://gcc.gnu.org/) | [下载](https://ftp.gnu.org/gnu/gcc/gcc-14.2.0/gcc-14.2.0.tar.xz) | [gnu.org](https://gcc.gnu.org/git/gcc.git) |
| `gdbm` | `1.24` | [gnu.org](https://www.gnu.org/software/gdbm/) | [下载](https://ftp.gnu.org/gnu/gdbm/gdbm-1.24.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/gdbm.git) |
| `gettext` | `0.24` | [gnu.org](https://www.gnu.org/software/gettext/) | [下载](https://ftp.gnu.org/pub/gnu/gettext/gettext-0.24.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/gettext.git) |
| `glibc` | `2.41` | [gnu.org](https://www.gnu.org/software/libc/) | [下载](https://ftp.gnu.org/pub/gnu/glibc/glibc-2.41.tar.xz) | [sourceware.org](https://sourceware.org/git/glibc.git) |
| `gmp` | `6.3.0` | [gmplib.org](https://gmplib.org/) | [下载](https://gmplib.org/download/gmp/gmp-6.3.0.tar.xz) | [gmplib.org (mercurial)](https://gmplib.org/repo/gmp/) |
| `gperf` | `3.1` | [gnu.org](https://www.gnu.org/software/gperf/) | [下载](https://ftp.gnu.org/pub/gnu/gperf/gperf-3.1.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/gperf.git) |
| `grep` | `3.11` | [gnu.org](https://www.gnu.org/software/grep/) | [下载](https://ftp.gnu.org/pub/gnu/grep/grep-3.11.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/grep.git) |
| `groff` | `1.23.0` | [gnu.org](https://www.gnu.org/software/groff/) | [下载](https://ftp.gnu.org/pub/gnu/groff/groff-1.23.0.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/groff.git) |
| `grub` | `2.12` | [gnu.org](https://www.gnu.org/software/grub/) | [下载](https://ftp.gnu.org/pub/gnu/grub/grub-2.12.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/grub.git) |
| `gzip` | `1.13` | [gnu.org](https://www.gnu.org/software/gzip/) | [下载](https://ftp.gnu.org/gnu/gzip/gzip-1.13.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/gzip.git) |
| `iana-etc` | `20250123` | [github.com](https://github.com/Mic92/iana-etc) | [下载](https://github.com/Mic92/iana-etc/releases/download/20250123/iana-etc-20250123.tar.gz) | [github.com](https://github.com/Mic92/iana-etc.git) |
| `inetutils` | `2.6` | [gnu.org](https://www.gnu.org/software/inetutils/) | [下载](https://ftp.gnu.org/gnu/inetutils/inetutils-2.6.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/inetutils.git) |
| `intltool` | `0.51.0` | [freedesktop.org](https://freedesktop.org/wiki/Software/intltool/) | [下载](https://launchpad.net/intltool/trunk/0.51.0/+download/intltool-0.51.0.tar.gz) | [launchpad.net (bazaar)](https://bazaar.launchpad.net/~intltool/intltool/trunk/files) |
| `iproute2` | `6.13.0` | [kernel.org](https://mirrors.edge.kernel.org/pub/linux/utils/net/iproute2/) | [下载](https://mirrors.edge.kernel.org/pub/linux/utils/net/iproute2/iproute2-6.13.0.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/network/iproute2/iproute2.git) |
| `jinja2` | `3.1.5` | [palletsprojects.com](https://jinja.palletsprojects.com/en/stable/) [github.com](https://github.com/pallets/jinja/) | [下载](https://pypi.org/packages/source/J/Jinja2/jinja2-3.1.5.tar.gz) | [github.com](https://github.com/pallets/jinja.git) |
| `kbd` | `2.7.1` | [kbd-project.org](https://kbd-project.org/) | [下载](https://www.kernel.org/pub/linux/utils/kbd/kbd-2.7.1.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/linux/kernel/git/legion/kbd.git) |
| `kmod` | `34` | [github.com](https://github.com/kmod-project/kmod) | [下载](https://www.kernel.org/pub/linux/utils/kernel/kmod/kmod-34.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/utils/kernel/kmod/kmod.git) |
| `less` | `668` | [greenwoodsoftware.com](http://greenwoodsoftware.com/less) | [下载](https://www.greenwoodsoftware.com/less/less-668.tar.gz) | [github.com](https://github.com/gwsw/less.git) |
| `lfs-bootscripts` | `20240825` |  | [下载](https://www.linuxfromscratch.org/lfs/downloads/12.3/lfs-bootscripts-20240825.tar.xz) |  |
| `libcap` | `2.73` | [google.com/site/fullycapable](https://sites.google.com/site/fullycapable/) | [下载](https://www.kernel.org/pub/linux/libs/security/linux-privs/libcap2/libcap-2.73.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/libs/libcap/libcap.git) |
| `libffi` | `3.4.7` | [sourceware.org](https://sourceware.org/libffi/) | [下载](https://github.com/libffi/libffi/releases/download/v3.4.7/libffi-3.4.7.tar.gz) | [github.com](https://github.com/libffi/libffi.git) |
| `libpipeline` | `1.5.8` | [nongnu.org](https://libpipeline.nongnu.org/) | [下载]( https://download.savannah.gnu.org/releases/libpipeline/libpipeline-1.5.8.tar.gz) | [nongnu.org](https://git.savannah.nongnu.org/git/libpipeline.git) |
| `libtool` | `2.5.4` | [gnu.org](https://www.gnu.org/software/libtool/) | [下载](https://ftp.gnu.org/gnu/libtool/libtool-2.5.4.tar.xz) | [gnu.org](https://git.savannah.gnu.org/libtool.git) |
| `libxcrypt` | `4.4.38` | [github.com](https://github.com/besser82/libxcrypt/) | [下载]( https://github.com/besser82/libxcrypt/releases/download/v4.4.38/libxcrypt-4.4.38.tar.xz) | [github.com](https://github.com/besser82/libxcrypt.git) |
| `linux` | `6.13.4` | [kernel.org](https://www.kernel.org/) | [下载](https://www.kernel.org/pub/linux/kernel/v6.x/linux-6.13.4.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git) |
| `lz4` | `1.10.0` | [lz4.org](https://lz4.org/) | [下载]( https://github.com/lz4/lz4/releases/download/v1.10.0/lz4-1.10.0.tar.gz) | [github.com](https://github.com/lz4/lz4.git) |
| `m4` | `1.4.19` | [gnu.org](https://www.gnu.org/software/m4/) | [下载](https://ftp.gnu.org/gnu/m4/m4-1.4.19.tar.xz) | [gnu.org](https://git.savannah.gnu.org/r/m4.git) |
| `make` | `4.4.1` | [gnu.org](https://www.gnu.org/software/make/) | [下载](https://ftp.gnu.org/gnu/make/make-4.4.1.tar.gz) | [gnu.org](https://git.savannah.gnu.org/r/make.git) |
| `man-db` | `2.13.0` | [nongnu.org](https://www.nongnu.org/man-db/) | [下载](https://download.savannah.gnu.org/releases/man-db/man-db-2.13.0.tar.xz) | [gitlab.com](https://gitlab.com/man-db/man-db.git) |
| `man-pages` | `6.12` | [kernel.org](https://www.kernel.org/doc/man-pages/) | [下载](https://www.kernel.org/pub/linux/docs/man-pages/man-pages-6.12.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/docs/man-pages/man-pages.git) |
| `markupsafe` | `3.0.2` | [palletsprojects.com](https://palletsprojects.com/p/markupsafe/) | [下载](https://pypi.org/packages/source/M/MarkupSafe/markupsafe-3.0.2.tar.gz) | [github.com](https://github.com/pallets/markupsafe.git) |
| `meson` | `1.7.0` | [mesonbuild.com](https://mesonbuild.com) | [下载](https://github.com/mesonbuild/meson/releases/download/1.7.0/meson-1.7.0.tar.gz) | [github.com](https://github.com/mesonbuild/meson.git) |
| `mpc` | `1.3.1` | [multiprecision.org](https://www.multiprecision.org/) | [下载](https://ftp.gnu.org/gnu/mpc/mpc-1.3.1.tar.gz) | [gitlab.inria.fr](https://gitlab.inria.fr/mpc/mpc.git) |
| `mpfr` | `4.2.1` | [mpfr.org](https://www.mpfr.org/) | [下载](https://ftp.gnu.org/gnu/mpfr/mpfr-4.2.1.tar.xz) | [gitlab.inria.fr](https://gitlab.inria.fr/mpfr/mpfr.git) |
| `ncurses` | `6.5` | [invisible-island.net](https://invisible-island.net/ncurses/) | [下载](https://invisible-mirror.net/archives/ncurses/ncurses-6.5.tar.gz) | [invisible-island.net (patch only)](https://invisible-island.net/archives/ncurses/6.4/) |
| `ninja` | `1.12.1` | [ninja-build.org](https://ninja-build.org/) | [下载](https://github.com/ninja-build/ninja/archive/v1.12.1/ninja-1.12.1.tar.gz) | [github.com](https://github.com/ninja-build/ninja.git) |
| `openssl` | `3.4.1` | [openssl-library.org](https://www.openssl-library.org/) | [下载](https://github.com/openssl/openssl/releases/download/openssl-3.4.1/openssl-3.4.1.tar.gz) | [github.com](https://github.com/openssl/openssl.git) |
| `patch` | `2.7.6` | [gnu.org](https://savannah.gnu.org/projects/patch/) | [下载](https://ftp.gnu.org/gnu/patch/patch-2.7.6.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/patch.git) |
| `perl` | `5.40.1` | [perl.org](https://www.perl.org/) | [下载](https://www.cpan.org/src/5.0/perl-5.40.1.tar.xz) | [github.com](https://github.com/Perl/perl5.git) |
| `pkgconf` | `2.3.0` | [github.com](https://github.com/pkgconf/pkgconf) | [下载]( https://distfiles.ariadne.space/pkgconf/pkgconf-2.3.0.tar.xz) | [github.com](https://github.com/pkgconf/pkgconf.git) |
| `procps` | `4.0.5` | [gitlab.com](https://gitlab.com/procps-ng/procps/) | [下载]( https://sourceforge.net/projects/procps-ng/files/Production/procps-ng-4.0.5.tar.xz) | [gitlab.com](https://gitlab.com/procps-ng/procps.git) |
| `psmisc` | `23.7` | [gitlab.com](https://gitlab.com/psmisc/psmisc) | [下载](https://sourceforge.net/projects/psmisc/files/psmisc/psmisc-23.7.tar.xz) | [gitlab.com](https://gitlab.com/psmisc/psmisc.git) |
| `python` | `3.13.2` | [python.org](https://www.python.org/) | [下载](https://www.python.org/ftp/python/3.13.2/Python-3.13.2.tar.xz) | [github.com](https://github.com/python/cpython.git) |
| `python-docs` | `3.13.2` | [python.org](https://www.python.org/) | [下载](https://www.python.org/ftp/python/doc/3.13.2/python-3.13.2-docs-html.tar.bz2) | [github.com](https://github.com/python/cpython.git) |
| `readline` | `8.2.13` | [tiswww.case.edu](https://tiswww.case.edu/php/chet/readline/rltop.html) | [下载](https://ftp.gnu.org/gnu/readline/readline-8.2.13.tar.gz) | [gnu.org](http://git.savannah.gnu.org/cgit/readline.git) |
| `sed` | `4.9` | [gnu.org](https://www.gnu.org/software/sed/) | [下载](https://ftp.gnu.org/gnu/sed/sed-4.9.tar.xz) | [gnu.org](https://git.sv.gnu.org/sed) |
| `setuptools` | `75.8.1` | [pypi.org](https://pypi.org/project/setuptools/) | [下载](https://pypi.org/packages/source/s/setuptools/setuptools-75.8.1.tar.gz) | [github.com](https://github.com/pypa/setuptools.git) |
| `shadow` | `4.17.3` | [github.com](https://github.com/shadow-maint/shadow/) | [下载](https://github.com/shadow-maint/shadow/releases/download/4.17.3/shadow-4.17.3.tar.xz) | [github.com](https://github.com/shadow-maint/shadow.git) |
| `sysklogd` | `2.7.0` | [infodrom.org](https://www.infodrom.org/projects/sysklogd/) | [下载](https://github.com/troglobit/sysklogd/releases/download/v2.7.0/sysklogd-2.7.0.tar.gz) | [infodrom.org](git://git.infodrom.org/infodrom/sysklogd) [github.com](https://github.com/troglobit/sysklogd.git) |
| `systemd` | `257.3` | [freedesktop.org](https://www.freedesktop.org/wiki/Software/systemd/) | [下载](https://github.com/systemd/systemd/archive/v257.3/systemd-257.3.tar.gz) | [github.com](https://github.com/systemd/systemd.git) |
| `systemd-man-pages` | `257.3` | [freedesktop.org](https://www.freedesktop.org/wiki/Software/systemd/) | [下载](https://anduin.linuxfromscratch.org/LFS/systemd-man-pages-257.3.tar.xz) | [github.com](https://github.com/systemd/systemd.git) |
| `sysvinit` | `3.14` | [nongnu.org](https://savannah.nongnu.org/projects/sysvinit) | [下载](https://github.com/slicer69/sysvinit/releases/download/3.14/sysvinit-3.14.tar.xz) | [github.com](https://github.com/slicer69/sysvinit.git) |
| `tar` | `1.35` | [gnu.org](https://www.gnu.org/software/tar/) | [下载](https://ftp.gnu.org/gnu/tar/tar-1.35.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/tar.git) |
| `tcl` | `8.6.16` | [sourceforge.net](https://tcl.sourceforge.net/) | [下载](https://downloads.sourceforge.net/tcl/tcl8.6.16-src.tar.gz) | [tcl-lang.org (fossil)](https://core.tcl-lang.org/tcl) |
| `tcl-docs` | `8.6.16` | [sourceforge.net](https://tcl.sourceforge.net/) | [下载](https://downloads.sourceforge.net/tcl/tcl8.6.16-html.tar.gz) | [tcl-lang.org (fossil)](https://core.tcl-lang.org/tcl) |
| `texinfo` | `7.2` | [gnu.org](https://www.gnu.org/software/texinfo/) | [下载](https://ftp.gnu.org/gnu/texinfo/texinfo-7.2.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/texinfo.git) |
| `timezonedata` | `2025a` | [iana.org](https://www.iana.org/time-zones) | [下载](https://www.iana.org/time-zones/repository/releases/tzdata2025a.tar.gz) | [iana.org (tarballs only)](https://data.iana.org/time-zones/releases/) |
| `udev-lfs` | `udev-lfs-20230818` |  | [下载](https://anduin.linuxfromscratch.org/LFS/udev-lfs-20230818.tar.xz) |  |
| `util-linux` | `2.40.4` | [kernel.org](https://git.kernel.org/pub/scm/utils/util-linux/util-linux.git/about/) | [下载](https://www.kernel.org/pub/linux/utils/util-linux/v2.40/util-linux-2.40.4.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/utils/util-linux/util-linux.git) |
| `vim` | `9.1.1166` | [vim.org](https://www.vim.org) | [下载](https://github.com/vim/vim/archive/v9.1.1166/vim-9.1.1166.tar.gz) | [github.com](https://github.com/vim/vim.git) |
| `wheel` | `0.45.1` | [pypi.org](https://pypi.org/project/wheel/) | [下载](https://pypi.org/packages/source/w/wheel/wheel-0.45.1.tar.gz) | [github.com](https://github.com/pypa/wheel.git) |
| `xml::parser` | `2.47` | [github.com](https://github.com/chorny/XML-Parser) | [下载](https://cpan.metacpan.org/authors/id/T/TO/TODDR/XML-Parser-2.47.tar.gz) | [github.com](https://github.com/chorny/XML-Parser.git) |
| `xz` | `5.6.4` | [tukaani.org](https://tukaani.org/xz) | [下载](https://github.com//tukaani-project/xz/releases/download/v5.6.4/xz-5.6.4.tar.xz) | [github.com](https://github.com/tukaani-project/xz.git) |
| `zlib` | `1.3.1` | [zlib.net](https://zlib.net/) | [下载](https://zlib.net/fossils/zlib-1.3.1.tar.gz) | [github.com](https://github.com/madler/zlib.git) |
| `zstd` | `1.5.7` | [github.com](https://facebook.github.io/zstd/) | [下载](https://github.com/facebook/zstd/releases/download/v1.5.7/zstd-1.5.7.tar.gz) | [github.com](https://github.com/facebook/zstd.git) |

## 1.3 LFS补丁准备

| 补丁 | tarball下载 |
| :- | :- |
| bzip2 documentation | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/bzip2-1.0.8-install_docs-1.patch) |
| coreutils internationalization fixes (i18n) | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/coreutils-9.6-i18n-1.patch) |
| expect gcc14 | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/expect-5.45.4-gcc14-1.patch) |
| glibc fhs | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/glibc-2.41-fhs-1.patch) |
| kbd backspace/delete fix | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/kbd-2.7.1-backspace-1.patch) |
| sysvinit consolidated | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/sysvinit-3.14-consolidated-1.patch) |

## 1.4 LFS目录创建

使用普通用户身份创建一个新目录，用于LFS的根目录。确保权限为`755`（可以设定`umask 022`）

后续该目录以及所有子目录要`chown root:root`，保证UID和GID都为`0`。这里先保持为普通用户

```
$ umask 022
$ mkdir -p lfs/etc lfs/var
$ mkdir -p lfs/usr/bin lfs/usr/sbin lfs/usr/lib
$ ln -s usr/bin lfs/bin
$ ln -s usr/sbin lfs/sbin
$ ln -s usr/lib lfs/lib
$ mkdir lfs/tools
$ mkdir lfs/sources
$ mkdir lfs/lib64
$ ls lfs/
bin     etc     lib     lib64   sbin    sources     tools   usr     var
```

> `tools`用于存放交叉工具链1。注意刚刚下载的源码和补丁尽量放到`sources`再解压缩，不要解压缩后中途复制，否则时间戳问题容易会对构建过程造成影响

## 1.5 环境

使用普通用户身份新开一个`bash`，隔离可能会有影响的环境变量，设定一些常用变量，仅继承少量无关紧要的变量。可以写成shell脚本

```
$ export LFS=/absolute/path/to/lfs
$ exec env -i HOME="$HOME" \
> TERM="$TERM" \
> PS1="$PS1" \
> PATH=/bin:/usr/bin:$LFS/tools/bin \
> LFS=$LFS \
> LC_ALL=POSIX \
> LFS_TGT=x86_64-lfs-linux-gnu \
> CONFIG_SITE=$LFS/usr/share/config.site /bin/bash
```

> 设置`CONFIG_SITE`是防止`configure`脚本读主机的`config.site`

进入新shell后检查一下

```
$ env
```

在新`bash`实例下执行以下命令

```
$ set +h
$ umask 022
```

> `set +h`关闭`bash`的哈希功能，强制`bash`每次都去`$PATH`找可执行文件而不是使用缓存的路径

也可以提前设定一下`make`线程数，后面可以直接调这个环境变量

```
$ export MAKEFLAGS=-j$(nproc)
```

## 2 LFS：构建交叉工具链与基础组件

## 2.1 基本概念

### 2.1.1 triplet名

工具链名称是一个triplet，已经给出`LFS_TGT=x86_64-lfs-linux-gnu`（target）。这是`autoconf`要求的格式，格式为`cpu-vendor-kernel-os`，其中`vendor`可以省略（默认不写为`unknown`）。可以通过`binutils`包中的`config.guess`脚本获取这个名称

> 当前系统使用的工具链triplet名可以通过`gcc -dumpmachine`获得

### 2.1.2 动态链接器

`glibc`提供了一个动态链接器`ld-linux-x86-64.so.2`。其他的替代品有`mold`等（[github](https://github.com/rui314/mold)）

> 当前系统使用的动态链接器可以使用`readelf -l /any/elf/file | grep interpreter`获取

### 2.1.3 Canadian Cross

工具链是制造软件的软件，正如机床是工业母机。工具链当然可以用来编译工具链

工具链有3个属性：**build**，**host**，**target**

**build**指这个工具链本身在什么平台被生产编译出来

**host**指这个工具链本身在什么平台运行

**target**指这个工具链生产出来的代码在什么平台运行

也就是说当前机器运行的工具链不一定是在本机生产的，它编译出的代码也不一定是在本机运行的

之所以叫Canadian Cross原因如下

> The term Canadian Cross was coined because at the time that these issues were all being hashed out, Canada had three national political parties - [by crosstool-ng](https://crosstool-ng.github.io/docs/toolchain-types/)

假设我们想要在平台A构建在平台B上运行的工具链，而这个工具链编译出的程序在平台C上执行，至少需要编译3次

| Pass | build | host | target |
| :- | :- | :- | :- |
| 交叉工具链1 | A | A | B |
| 交叉工具链2 | A | B | C |
| 工具链3 | B | C | C |

后续就可以实现C平台完全自举（同时可以测试检查用）

| Pass | build | host | target |
| :- | :- | :- | :- |
| 工具链4 | C | C | C |

> 第1次在平台A构建出在A上执行的生成平台B程序的工具链
>
> 第2次将第1次构建出的工具链放到平台B上执行，用这个工具链构建出生成平台C程序的工具链
>
> 第3次将第2次构建出的工具链放到平台C上执行，这样C平台就有了可以在本机执行的、生成本机代码的工具链，实现自举
>
> 只有第1次和第2次的工具链算交叉工具链，因为它们的host和target不同

上述场景的前提是A性能较低，且B没有可用的工具链。而LFS中实际上我们只需要Cross一次（B有可用的工具链且性能足够，无需再有A->B），所以至少编译2次即可

| Pass | build | host | target |
| :- | :- | :- | :- |
| 交叉工具链1 | B | B | C |
| 工具链2 | B | C | C |

保证C平台完全自举

| Pass | build | host | target |
| :- | :- | :- | :- |
| 工具链3 | C | C | C |

我们要生产工具链，所以当前主机必须要有至少一个可以直接运行的工具链，才有可能造出新的工具链

AlpineLinux安装

```
$ apk add gcc musl-dev make bison flex texinfo automake patch gawk gperf
```

> 实际上最后还是要在C平台重新编译出整个工具链3，因为工具链2是在B平台交叉编译出来的，可能会缺少一些可选的依赖，并且在B平台由于是交叉编译环境`autoconf`可能无法侦测到一些feature。还有一个原因是可能需要本地运行testsuite检验功能是否完整。这不仅对于工具链本身成立，对于其他软件也是成立的
>
> 交叉工具链1会被放到`$LFS/tools`

### 2.1.4 libgcc

GNU工具链本身需要依赖`libgcc`才能运行，而`libgcc`又链接了`libc`和`libstdc++`

在本文的环境里，构建B平台运行（目标为C平台）的交叉工具链1时，编译它的`libgcc`时会避免去使用到`libc`以及`libstdc++`的功能，从而避免链接到主机的`libc`库，这个交叉工具链1是一个degraded的工具链，缺少一些功能和特性，主要是**它本身**无法调用操作系统的线程库以及异常处理等功能，用它构建目标机代码在某些场景下可能会遇到一些问题。而在C平台运行的工具链2会依赖交叉工具链1编译出来的`glibc`和`libstdc++`运行，具备相对更完整的功能，因为用交叉工具链1构建出来的适用于C平台的`glibc`功能是完备的

## 2.2 构建交叉工具链1

### 2.2.1 构建顺序

构建与安装顺序按照`binutils` `gcc` `linux-headers` `glibc` `libstdc++`

> 这里的`gcc`是一个degraded的交叉工具链。后面的`glibc` `libstdc++`以及新的工具链2由这个交叉工具链1编译出来
>
> 从使用方法来看，交叉工具链和非交叉工具链的一大区别就是会有triplet前缀，例如`arm-none-gnueabihf-gcc` `x86_64-lfs-linux-gnu-gcc` `X86_64-none-linux-musl-gcc`，而本机平台的非交叉工具链不会有triplet前缀，triplet要通过`gcc -dumpmachine`才能看到

**binutils和gcc**

把`binutils`放在最开始编译是因为无论`gcc`还是`glibc`的`configure`脚本都需要检查平台已有的汇编器和链接器的特性，来判断开启/关闭哪些特性与功能

`binutils`会安装到`$LFS/tools/bin`和`$LFS/tools/$LFS_TGT/bin`，两个目录里的文件是硬链接的关系

后续运行`gcc`的`configure`脚本时会看到它使用了`$LFS/tools/$LFS_TGT/bin`下的`as`和`ld`。而在后续实际执行时并不一定使用这两个`as`和`ld`，实际使用的汇编器和链接器可以在`gcc`被编译出来以后使用`$LFS_TGT-gcc -print-prog-name=ld`获取。而在已经启动的本地系统上可以使用`gcc -print-prog-name=ld`

`ld`链接器扫描库文件目录也是有顺序的。在编译完成`binutils`后可以通过`$LFS_TGT-ld --verbose | grep SEARCH`获取搜寻顺序，而在已经启动的本地系统上可以使用`ld --verbose | grep SEARCH`

> 使用`gcc -v somecode.c`试编译代码也可以看到上述这类信息

**linux-headers**

把`linux-headers`安装放在`glibc`之前是因为`glibc`需要调用`linux`提供的接口

**glibc**

编译`glibc`前，`configure`脚本通过`--host`参数判定使用`$LFS_TGT-gcc`和`$LFS_TGT-ld`等工具。建议`configure`完先检查一下`build`目录下的`config.make`是否有异样

**libstdc++**

`libstdc++`依赖`glibc`所以把`glibc`放在前

### 2.2.2 binutils

编译前最后再检查一下AlpineLinux下是否有`/usr/bin/awk`和`/usr/bin/yacc`，`sh`软链接到`bash`，`yacc`软链接到`bison`，且当前默认使用的shell为`bash`

进入到`$LFS/sources`下解压后的`binutils-2.44`目录，创建一个`build`目录

```
$ mkdir build
$ cd build
```

执行`../configure`，参数含义见下

```
$ ../configure --prefix=$LFS/tools  \ # make install安装的路径前缀
> --with-sysroot=$LFS               \ # 该交叉工具链1需要搜寻的库所在路径
> --target=$LFS_TGT                 \ # 告诉binutil的构建系统构建一个交叉链接器，强制覆盖config.guess的返回结果
> --disable-nls                     \ # 关i18n国际化支持，交叉工具链暂不需要
> --enable-gprofng=no               \ # 不构建gprofng，交叉工具链不需要
> --disable-werror                  \ # 编译出现warning时不停止
> --enable-new-dtags                \ # 让ld在编译出来的可执行文件/动态库中使用runpath而非rpath记录搜寻目录，方便调试
> --enable-default-hash-style=gnu     # hash table被动态链接器用于搜寻符号，由于后续使用glibc所以只保留gnu style的hash table，速度更快，丢弃classic style的hash table
```

构建与安装

```
$ make -j16
$ make install
```

> 第一次构建可能很容易发现系统AlpineLinux环境缺少的组件例如`flex` `texinfo`等从而导致构建失败。这时候先安装好这些组件，`make clean`后可以先重新`configure`再重新`make`，直到构建通过
>
> `make install`以后应当在`../../../tools`下看到新安装的内容

### 2.2.3 gcc

> 注意这里解压tar包尽量按顺序来，先解压`gcc`再依次解压`mpfr` `gmp` `mpc`，也不要修改这些目录下的内容导致时间戳被改变。时间戳的改变会导致`configure`异常或`build`失败。如果发生了一些奇怪的error，可以重新解压一遍重新build

需要使用到`mpfr gmp mpc`，把它们都放到`gcc-14.2.0`下并依次解压重命名，这些包主要是计算功能

```
$ cp ../mpfr-4.2.1.tar.xz .
$ tar -axvf mpfr-4.2.1.tar.xz
$ mv mpfr-4.2.1 mpfr
$ cp ../gmp-6.3.0.tar.xz .
$ tar -axvf gmp-6.3.0.tar.xz
$ mv gmp-6.3.0 gmp
$ cp ../mpc-1.3.1.tar.gz .
$ tar -axvf mpc-1.3.1.tar.gz
$ mv mpc-1.3.1 mpc
```

修改`gcc-14.2.0`下`gcc/config/i386/t-linux64`，将`lib64`改为`lib`（因为是`x86_64`平台）

```
...
MULTILIB_OSDIRNAMES = m64=../lib$(call if_multiarch,:x86_64-linux-gnu)
...
```

创建`build`再`configure`

```
$ mkdir build
$ cd build
$ ../configure              \
> --target=$LFS_TGT         \
> --prefix=$LFS/tools       \
> --with-glibc-version=2.41 \ # 该交叉工具链搭配使用的glibc版本
> --with-sysroot=$LFS       \
> --with-newlib             \ # 保证编译libgcc时inhibit_libc常量被定义，避免这个交叉工具链的libgcc依赖任何libc
> --without-headers         \ # 无需强制要求目标平台的标准头文件
> --enable-default-pie      \ # 安全特性，尽量接近后面的最终版工具链
> --enable-default-ssp      \ # 安全特性
> --disable-nls             \
> --disable-shared          \ # 指示静态链接gcc的库而非动态，如果动态是需要glibc的，此时还没有
> --disable-multilib        \ # x86_64禁用multilib
> --disable-threads         \ # 关threads库防止构建失败。交叉工具链1无需该特性
> --disable-libatomic       \ # 关libatomic
> --disable-libgomp         \ # 关libgomp
> --disable-libquadmath     \ # 关libquadmath
> --disable-libssp          \ # 关libssp
> --disable-libvtv          \ # 关libvtv
> --disable-libstdcxx       \ # 关libstdc++
> --enable-languages=c,c++
```

构建

```
$ make -j16
$ make install
```

上述安装会安装一些系统头文件。`limits.h`会`include`系统的`$LFS/usr/include/limits.h`，但是此时该文件还不存在。这对于构建`glibc`暂时不影响，但是后续会用到。使用以下命令创建该头文件的完整版

```
cd ..
cat gcc/limitx.h gcc/glimits.h gcc/limity.h > \
  `dirname $($LFS_TGT-gcc -print-libgcc-file-name)`/include/limits.h
```

> 上述命令将`gcc`目录下的`limitx.h` `glimits.h` `limity.h`三个文件拼起来放到`$LFS/tools/lib/gcc/x86_64-lfs-linux-gnu/14.2.0/include/limits.h`

### 2.2.4 linux-headers

解压`linux-6.13.4.tar.xz`后进入

先确定没有过时文件

```
$ make mrproper
```

仅提取头文件，放在`usr/include`下

```
$ make headers
```

删除所有非`.h`后缀的文件

```
$ find usr/include -type f ! -name '*.h' -delete
```

把头文件复制到`$LFS/usr`，注意不是放到`$LFS/tools`下

```
$ cp -r usr/include $LFS/usr
```

> 这些头文件主要包含`asm`头文件，`asm-generic`头文件，`drm`用于DRM的头文件，`linux`系统常用功能头文件，`misc`杂项头文件，`mtd`头文件，`rdma`头文件，`scsi`子系统头文件，`sound`子系统头文件，`video`子系统头文件，`xen`头文件等

### 2.2.5 glibc

`glibc`包含了一个动态链接器`ld-linux-x86-64.so.2`。先为动态链接器预先创建符号链接，因为此时还未编译安装，这两个符号链接是死链接

```
$ ln -sf ../lib/ld-linux-x86-64.so.2 $LFS/lib64/ld-linux-x86-64.so.2
$ ln -sf ../lib/ld-linux-x86-64.so.2 $LFS/lib64/ld-lsb-x86-64.so.3
```

有些`glibc`程序会把运行时的数据丢到`/var/db`，这不符合FHS。需要打前文所述[补丁](https://www.linuxfromscratch.org/patches/lfs/12.3/glibc-2.41-fhs-1.patch)

```
$ cd glibc-2.41
$ patch -Np1 -i ../glibc-2.41-fhs-1.patch
```

> `-N`表示`--forward`仅向前`patch`，忽略已经应用的`patch`以及可能的反向`patch`；`-p1`表示在文件名前面减去1个`/`

创建`build`目录

```
$ mkdir build
$ cd build
```

在`build`下创建一个文件，确保新编译出来的`ldconfig`和`sln`安装会放到`/usr/sbin`

```
$ echo "rootsbindir=/usr/sbin" > configparms
```

执行`configure`

```
$ ../configure  \
> --prefix=/usr                       \
> --host=$LFS_TGT                     \ # 使用交叉工具链
> --build=$(../scripts/config.guess)  \ # 使用交叉工具链
> --enable-kernel=5.4                 \ # 兼容linux5.4及之后的内核，不开启旧内核的workaround
> --with-headers=$LFS/usr/include     \ # 使用刚才安装的linux-headers
> --disable-nscd                      \ # 不要编译name service cache daemon，这是以前nss用来缓存域名查询记录的服务，已经弃用
> libc_cv_slibdir=/usr/lib              # 强制在64位机器上安装到/usr/lib
```

> 这里的`prefix`是相对`$LFS`而言的，安装到`$LFS/usr`，而`$LFS/usr/bin` `$LFS/usr/sbin` `$LFS/usr/lib`又分别软链接到`$LFS/bin` `$LFS/sbin` `$LFS/lib`

构建`glibc`。如果出错尝试`make -j1`（概率很小）

```
$ make -j16
$ make DESTDIR=$LFS install
```

修改一下`$LFS/usr/bin/ldd`脚本中的动态链接器路径，把`/usr`前缀都删了

```
RTLDLIST="/lib64/ld-linux-x86-64.so.2 /lib/ld-linux.so.2 /libx32/ld-linux-x32.so.2"
```

**检查工具链功能**

到`source`目录下尝试编译一下

```
$ cd ../../
$ echo "int main(){}" | $LFS_TGT-gcc -xc -
$ readelf -l a.out | grep ld-linux
      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]
```

此时`$LFS/lib64`下应当有该符号链接。删除编译出来的`a.out`

```
$ rm a.out
```

### 2.2.4 libstdc++

`libstdc++`在`gcc`源码里

```
$ cd gcc-14.2.0
```

另创一个`build`目录给`libstdc++`

```
$ mkdir build-libstdcxx
$ cd build-libstdcxx
```

运行`configure`

```
$ ../libstdc++-v3/configure       \
> --host=$LFS_TGT                 \ # 交叉编译
> --build=$(../config.guess)      \
> --prefix=/usr                   \
> --disable-multilib              \ # 纯64位
> --disable-nls                   \
> --disable-libstdcxx-pch         \ # 不安装预编译的include文件
> --with-gxx-include-dir=/tools/$LFS_TGT/include/c++/14.2.0 # 实际上是$LFS/tools/$LFS_TGT/include/c++/14.2.0，$LFS前缀是从前面编译gcc时设定的--with-sysroot参数得来，指定libstdc++ include文件的安装路径，这个路径会被g++查找
```

> 这里的`prefix`同样是相对`$LFS`而言的

构建安装`libstdc++`

```
$ make -j16
$ make DESTDIR=$LFS install
```

删除libtool archive（后缀`.la`）文件

```
$ cd $LFS/usr/lib/
$ rm *.la
```

正常应该会删除`libstdc++.la` `libstdc++exp.la` `libstdc++fs.la` `libsupc++.la`共计4个文件

到这里为止交叉工具链1就构建完成了，接下来可以开始构建其他组件

## 2.3 交叉构建基础组件

这里开始的所有基础组件是使用`$LFS/tools`下的交叉工具链1构建的，最终是直接安装在`$LFS`下，并且放在`target`机器上运行

### 2.3.1 m4

可以不创建`build`直接运行`configure`

```
$ ./configure --prefix=/usr \
> --host=$LFS_TGT           \
> --build=$(build-aux/config.guess)
```

构建

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.2 ncurses

先构建`tic`

```
$ mkdir build
$ cd build
$ ../configure AWK=gawk
$ make -C include
$ make -j16 -C progs tic
```

回到源码根目录直接运行`configure`

```
$ ./configure --prefix=/usr              \
>           --host=$LFS_TGT              \
>           --build=$(./config.guess)    \
>           --mandir=/usr/share/man      \
>           --with-manpage-format=normal \ # 不要给manpage压缩
>           --with-shared                \ # 使用动态C库
>           --without-normal             \ # 不要使用静态C库
>           --with-cxx-shared            \ # 不要包含C++ bindings
>           --without-debug              \ # 不要包含调试库
>           --without-ada                \ # 不包含ada支持
>           --disable-stripping          \ # 不要调用主机的strip命令
>           AWK=gawk
```

构建

```
$ make -j16
```

安装

```
$ make DESTDIR=$LFS TIC_PATH=$(pwd)/build/progs/tic install
$ ln -s libncursesw.so $LFS/usr/lib/libncurses.so
```

编辑`$LFS/usr/include/curses.h`，找到

```c
#if defined(_XOPEN_SOURCE_EXTENDED) || (defined(_XOPEN_SOURCE) && (_XOPEN_SOURCE - 0 >= 500))
```

改为

```c
#if 1
```

强制开`#define NCURSES_WIDECHAR 1`

> 显式指定`tic`是为了成功创建terminal database
>
> 因为我们编译出来的是wide char版本而非单char版本，所以没有名字叫`libncurses.so`的库，创建`$LFS/usr/lib/libncurses.so`为了防止后续一些build步骤找不到
>
> 编辑`$LFS/usr/include/curses.h`同样是为了支持wide char，强制开启wide char兼容的结构体

### 2.3.3 bash

直接运行`configure`

```
$ ./configure
> --prefix=/usr                         \
> --build=$(sh support/config.guess)    \
> --host=$LFS_TGT                       \
> --without-bash-malloc                   # 关闭bash自带的malloc防止segfault，调用glibc的malloc
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
$ ln -s bash $LFS/bin/sh
```

### 2.3.4 coreutils

先不要打`i18n`补丁影响时间戳否则`automake`版本会出错

直接运行`configure`

```
$ ./configure --prefix=/usr                 \
> --host=$LFS_TGT                           \
> --build=$(build-aux/config.guess)         \
> --enable-install-program=hostname         \ # 构建hostname程序，Perl测试需要用到
> --enable-no-install-program=kill,uptime     # 不构建kill和uptime程序
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

移动`chroot`，修改manpage里面所有`"1"`改为`"8"`

```
$ mv $LFS/usr/bin/chroot                    $LFS/usr/sbin
$ mkdir -p $LFS/usr/share/man/man8
$ mv $LFS/usr/share/man/man1/chroot.1       $LFS/usr/share/man/man8/chroot.8
$ sed -i 's/"1"/"8"/'                       $LFS/usr/share/man/man8/chroot.8
```

### 2.3.5 diffutils

直接运行`configure`

```
$ ./configure --prefix=/usr \
> --host=$LFS_TGT           \
> --build=$(./build-aux/config.guess)
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.6 file

被构建的`file`需要和主机上的`file`版本相同，以创建签名。创建`build`目录再`configure`，先编译一个临时的`file`

```
$ mkdir build
$ cd build
$ ../configure --disable-bzlib  \ # 都是为了防止去链接一些库
> --disable-libseccomp          \
> --disable-xzlib               \ 
> --disable-zlib 
```

回退到父目录，再次运行`configure`

```
$ cd ..
$ ./configure --prefix=/usr --host=$LFS_TGT --build=$(./config.guess)
```

构建并安装

```
$ make -j16 FILE_COMPILE=$(pwd)/build/src/file
$ make DESTDIR=$LFS install
```

删除`.la`

```
$ rm $LFS/usr/lib/libmagic.la
```

### 2.3.7 findutils

直接运行`configure`

```
$ ./configure --prefix=/usr         \
> --localstatedir=/var/lib/locate   \
> --host=$LFS_TGT                   \
> --build=$(build-aux/config.guess)
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.8 gawk

把`Makefile.in`里面所有的`extras`字符串删除，防止安装多余文件

```
$ sed -i 's/extras//' Makefile.in
```

直接运行`configure`

```
$ ./configure --prefix=/usr         \
> --host=$LFS_TGT                   \
> --build=$(build-aux/config.guess)
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.9 grep

直接运行`configure`

```
$ ./configure --prefix=/usr         \
> --host=$LFS_TGT                   \
> --build=$(./build-aux/config.guess)
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.10 gzip

直接运行`configure`

```
$ ./configure --prefix=/usr         \
> --host=$LFS_TGT
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.11 make

直接运行`configure`

```
$ ./configure --prefix=/usr     \
> --without-guile               \ # 防止使用guile
> --host=$LFS_TGT               \
> --build=$(build-aux/config.guess)
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.12 patch

直接运行`configure`

```
$ ./configure --prefix=/usr         \
> --host=$LFS_TGT                   \
> --build=$(build-aux/config.guess)
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.13 sed

直接运行`configure`

```
$ ./configure --prefix=/usr         \
> --host=$LFS_TGT                   \
> --build=$(./build-aux/config.guess)
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.14 tar

直接运行`configure`

```
$ ./configure --prefix=/usr         \
> --host=$LFS_TGT                   \
> --build=$(build-aux/config.guess)
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.15 xz

直接运行`configure`

```
$ ./configure --prefix=/usr         \
> --host=$LFS_TGT                   \
> --build=$(build-aux/config.guess) \
> --disable-static                  \
> --docdir=/usr/share/doc/xz-5.6.4
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

删除`.la`文件

```
$ rm $LFS/usr/lib/liblzma.la
```

### 2.3.16 binutils

Pass 2第2遍编译，目标机可以直接执行的`binutils`。注意这里的`prefix`参数变为了`/usr`

建议重新解压一下

修改`ltmain.sh`，找到`6031`行，删掉`$add_dir`

```
add_dir=" -L$inst_prefix_dir$libdir"
```

> 这是为了防止编译出的文件被错误地和主机的库进行链接。包里提供了一个`libtool`来链接内部静态库，但是包里的`libiberty`和`zlib`又不使用`libtool`

创建`build`目录再`configure`

```
$ mkdir build
$ cd build
```

```
$ ../configure                  \
> --prefix=/usr                 \
> --build=$(../config.guess)    \
> --host=$LFS_TGT               \
> --disable-nls                 \
> --enable-shared               \ # 以共享库形式构建libbfd
> --enable-gprofng=no           \
> --disable-werror              \
> --enable-64-bit-bfd           \ # 在32位平台开启64位支持。64位平台不开也行
> --enable-new-dtags            \
> --enable-default-hash-style=gnu
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

删除一些`libtool`相关文件与多余的静态库

```
$ cd $LFS/usr/lib
$ rm lib{bfd,ctf,ctf-nobfd,opcodes,sframe}.{a,la}
```

### 2.3.17 gcc

Pass 2第2遍编译，目标机可以直接执行的`gcc`。注意这里的`prefix`参数变为了`/usr`

这次是用交叉工具链1编译工具链2，而不是用主机的工具链来编译。因为前面已经编译并安装了`glibc`和`libstdc++`所以这里构建出来的工具链2具备更加完整的功能，例如支持线程

> 注意这里往后一直到目标机本地重新构建检验之前，不会再构建一遍`glibc` `libstdc++`，因为[前面](#22-构建交叉工具链1)用交叉工具链1构建出的`glibc` `libstdc++`不但可以给这个工具链2本身使用，也可以给这个工具链2的目标代码使用

建议重新解压一下。不要忘记重命名`mpfr gmp mpc`目录

修改`gcc-14.2.0`下`gcc/config/i386/t-linux64`，将`lib64`改为`lib`

```
...
MULTILIB_OSDIRNAMES = m64=../lib$(call if_multiarch,:x86_64-linux-gnu)
...
```

修改`libgcc/Makefile.in` `libstdc++-v3/include/Makefile.in`，开启`libgcc`和`libstdc++`的POSIX线程支持

在两个文件中找到`thread_header =`，替换掉`@`括起来的内容

```
thread_header = gthr-posix.h
```

创建`build`目录

```
$ mkdir build
$ cd build
```

执行`configure`

```
$ ../configure                                  \
> --build=$(../config.guess)                    \
> --host=$LFS_TGT                               \
> --target=$LFS_TGT                             \ # 因为是交叉编译，所以无法立即执行工具链2来编译libgcc和libstdc++。如果不指定该参数，默认会使用主机的工具链来编译而不是交叉工具链1。该参数保证使用交叉工具链1编译libgcc和libstdc++
> LDFLAGS_FOR_TARGET=-L$PWD/$LFS_TGT/libgcc     \ # 允许libstdc++使用本轮构建的libgcc而不是之前构建的版本，之前构建的版本无法支持C++异常处理特性，因为没有libc支持
> --prefix=/usr                                 \
> --with-build-sysroot=$LFS                     \ # host指定的路径只是指明用交叉编译器去编译，这个编译器知道应该去哪里找头文件和库，但是其他工具不知道。所以要指定一下
> --enable-default-pie                          \
> --enable-default-ssp                          \
> --disable-nls                                 \
> --disable-multilib                            \
> --disable-libatomic                           \
> --disable-libgomp                             \
> --disable-libquadmath                         \
> --disable-libsanitizer                        \ # 禁用gcc sanitizer运行时库，因为临时安装用不到。之前是通过--disable-libstdcxx连带禁用的
> --disable-libssp                              \
> --disable-libvtv                              \
> --enable-languages=c,c++
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

创建`cc`符号链接

```
$ ln -s gcc $LFS/usr/bin/cc
```

## 2.4 chroot后续构建

接下来可以在主机上`chroot`继续剩余的构建流程。到这里为止大部分棘手的循环依赖问题已经解决，并且构建机和目标机都是x86_64，所以直接利用`chroot`进行接下来的工作，使用功能更为完备的工具链2编译可以省去一些麻烦。而交叉工具链1不会再使用

但如果构建机和目标机不是相同架构，例如目标机是arm，情况就大不一样了。这种情况下，工具链2无法直接在构建机上执行，接下来的部分依旧只能使用之前的交叉工具链1构建，直到构建出Linux内核并成功在目标机上跑起来（没有物理设备当然也可以使用`qemu`）。当然在这种情况下在构建机上无法运行testsuite

> `chroot`用工具链2继续构建可以让构建前配置更简单，更加不容易出错，还能执行test看看构建出来的包功能是否正常

### 2.4.1 准备工作

先`su root`

首先修改`$LFS`下所有子目录的属主，改为`root`（`username`为原来的普通用户名）

```
# cd $LFS
# chown -R root:root *
```

创建虚拟文件系统`dev` `proc` `sys` `run`

```
# mkdir dev proc sys run
```

LFS启动时应当会自动在`dev`挂载`devtmpfs`以创建设备节点。这里先把主机的`/dev`挂过来

> 建议这里这些挂载操作写成脚本方便使用，把脚本放在`lfs`同级目录下，加上`lfs`前缀相对路径

```
# mount --bind /dev dev
```

再依次挂`devpts` `proc` `sysfs` `tmpfs`

```
# mount -t devpts devpts -o gid=5,mode=0620 dev/pts
# mount -t proc proc proc
# mount -t sysfs sysfs sys
# mount -t tmpfs tmpfs run
```

> `devpts`的`gid=5`是因为后面`tty`GID就是`5`，`mode=0620`表示属主可读写，组成员可写，这个权限设定是因为`grantpt()`，这样就没必要使用`glibc`的`pt_chown`

AlpineLinux下默认`/dev/shm`挂了一个`tmpfs`，所以也要挂一个`tmpfs`

```
# mount -t tmpfs -o nosuid,nodev tmpfs dev/shm
```

其他有些发行版里面`/dev/shm`可能是一个到`/run/shm`的软链接。这时候直接创建一个`dev/shm`即可

```
# install -d -m 1777 dev/shm
```

### 2.4.2 chroot

AlpineLinux的`chroot`在`/usr/sbin/chroot`，所以要改一下`PATH`

```
# export PATH=/usr/sbin:$PATH
```

可以写成脚本

```
# chroot lfs /usr/bin/env -i    \
> HOME=/root                    \
> TERM="$TERM"                  \
> PS1="(lfs chroot) \u:\w\$ "   \
> PATH=/usr/bin:/usr/sbin       \
> MAKEFLAG="-j16"               \
> TESTSUITEFLAGS="-j16"         \
> /bin/bash --login
```

> 有些包例如`autoconf` `libtool` `tar`不使用`MAKEFLAGS`而是`TESTSUITEFLAGS`
>
> `env -i`是为了防止当前环境变量被带入到`chroot`

另外此时还没有创建`etc/passwd`，所以`chroot`进去以后用户名显示`I have no name!`，不影响

**创建目录**

```
# mkdir boot home mnt opt srv
# mkdir -p /etc/{opt,sysconfig}
# mkdir -p /lib/firmware
# mkdir -p /media/{floppy,cdrom}
# mkdir -p /usr/{,local/}{include,src}
# mkdir -p /usr/lib/locale
# mkdir -p /usr/local/{bin,lib,sbin}
# mkdir -p /usr/{,local/}share/{color,dict,doc,info,locale,man,misc,terminfo,zoneinfo}
# mkdir -p /usr/{,local/}share/man/man{1..8}
# mkdir -p /var/{cache,local,log,mail,opt,spool}
# mkdir -p /var/lib/{color,misc,locate}
# ln -sf /run /var/run
# ln -sf /run/lock /var/lock
# install -d -m 0750 /root
# install -d -m 1777 /tmp /var/tmp
```

> 上述目录树定义在[FHS](https://refspecs.linuxfoundation.org/fhs.shtml)。可以按需自己创建目录，但是注意不要创建目录`/usr/lib64`

**创建文件，软链接和账户**

当前的`mount`列表。该文件以前在`/etc/mtab`，为兼容性需要创建符号链接

```
# ln -s /proc/self/mounts /etc/mtab
```

创建`/etc/hosts`，自己命名主机名。当前没有可用的编辑器，可以使用`cat > /etc/hosts << EOF`的方法

```
127.0.0.1   localhost   lfs-host
::1         localhost
```

创建`/etc/passwd`和`/etc/group`

```
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/dev/null:/usr/bin/false
daemon:x:6:6:Daemon User:/dev/null:/usr/bin/false
messagebus:x:18:18:D-Bus Message Daemon User:/run/dbus:/usr/bin/false
uuidd:x:80:80:UUID Generation Daemon User:/dev/null:/usr/bin/false
nobody:x:65534:65534:Unprivileged User:/dev/null:/usr/bin/false
```

```
root:x:0:
bin:x:1:daemon
sys:x:2:
kmem:x:3:
tape:x:4:
tty:x:5:
daemon:x:6:
floppy:x:7:
disk:x:8:
lp:x:9:
dialout:x:10:
audio:x:11:
video:x:12:
utmp:x:13:
cdrom:x:15:
adm:x:16:
messagebus:x:18:
input:x:24:
mail:x:34:
kvm:x:61:
uuidd:x:80:
wheel:x:97:
users:x:999:
nogroup:x:65534:
```

> 上述这些用户和组部分是因为`udev`。LSB规定要有`GID 0`的`root`，以及`GID 1`的`bin`。`GID 5`用于`tty`
>
> Linux内核中`ID 65534`会用于NFS等，在本机上没有的用户或组

创建一个测试用户和对应的组，后面要删掉

```
tester:x:101:101::/home/tester:/bin/bash
```

```
tester:x:101:
```

创建家目录

```
# install -o tester -g tester -d /home/tester
```

此时重新开一个`bash`，不会再有`I have no name!`

```
# exec /usr/bin/bash --login
```

创建一些日志文件

```
# touch /var/log/{btmp,lastlog,faillog,wtmp}
# chgrp utmp /var/log/lastlog
# chmod 664 /var/log/lastlog
# chmod 600 /var/log/btmp
```

> `wtmp`记录所有的登入和登出操作。`lastlog`记录每个用户最后一次登入时间。`faillog`和`btmp`记录登入失败操作，区别是一个用于`faillog`命令，一个用于`lastb`命令。`/run/utmp`在init期间自动创建，记录当前登入的用户。然而这些日志文件其中的时间戳有2038问题，目前已经逐步淘汰，部分软件不再使用它们

### 2.4.3 gettext

直接运行`configure`

```
# ./configure --disable-shared  # 不构建共享库
```

构建安装

```
# make -j16
# cp gettext-tools/src/{msgfmt,msgmerge,xgettext} /usr/bin
```

> 只安装`msgfmt` `msgmerge` `xgettext`

### 2.4.4 bison

直接运行`configure`

```
# ./configure --prefix=/usr --docdir=/usr/share/doc/bison-3.8.2
```

构建安装

```
# make -j16
# make install
```

### 2.4.5 perl

运行配置

```
# sh Configure -des                                 \ # 所有配置项默认，且保证所有任务完成，不print不重要的输出
> -D prefix=/usr                                    \
> -D vendorprefix=/usr                              \ # Perl安装包时模块安装的位置
> -D useshrplib                                     \ # 将libperl构建为动态库
> -D privlib=/usr/lib/perl5/5.40/core_perl          \ # Perl查找已安装模块的位置
> -D archlib=/usr/lib/perl5/5.40/core_perl          \
> -D sitelib=/usr/lib/perl5/5.40/site_perl          \
> -D sitearch=/usr/lib/perl5/5.40/site_perl         \
> -D vendorlib=/usr/lib/perl5/5.40/vendor_perl      \
> -D vendorarch=/usr/lib/perl5/5.40/vendor_perl
```

构建安装

```
# make -j16
# make install
```

### 2.4.6 python

直接运行`configure`

```
# ./configure --prefix=/usr     \
> --enable-shared               \ # 使用动态库而不是静态库
> --without-ensurepip             # 不使用pip包管理，现阶段用不上
```

构建安装

```
# make -j16
# make install
```

### 2.4.7 texinfo

直接运行`configure`

```
# ./configure --prefix=/usr
```

构建安装

```
# make -j16
# make install
```

### 2.4.8 util-linux

创建目录用来放`adjtime`文件

```
# mkdir -p /var/lib/hwclock
```

运行`configure`

```
# ./configure --libdir=/usr/lib             \ # 保证.so文件的软接直接通过相对路径指向/usr/lib下的库
> --runstatedir=/run                        \ # 指定libuuid和uuidd使用的socket位置
> --disable-chfn-chsh                       \ # 防止报warning，因为此时有些依赖还没有安装
> --disable-login                           \
> --disable-nologin                         \
> --disable-su                              \
> --disable-setpriv                         \
> --disable-runuser                         \
> --disable-pylibmount                      \
> --disable-static                          \
> --disable-liblastlog2                     \
> --without-python                          \ # 不构建python bindings
> ADJTIME_PATH=/var/lib/hwclock/adjtime     \ # 用来记CMOS时钟信息的文件，这里添加这个定义是为了防止创建不会被自动删除的多余文件
> --docdir=/usr/share/doc/util-linux-2.40.4
```

构建安装

```
# make -j16
# make install
```

### 2.4.9 清理并备份LFS目录

到这里可以备份一下当前的LFS目录，因为将当前的LFS作为`chroot`的起始点已经足以支持后续的构建。当然也可以不备份，但是之后如果遇到问题想要回退到早一些的版本会比较麻烦。此外在这里也会去掉一些冗余的部分，减小LFS体积，这对后续的构建也是有益的

**清理**

删除`/usr/share/{info,man,doc}/*`下所有的已安装文档

```
# rm -rf /usr/share/{info,man,doc}/*
```

清理`/usr/lib`和`/usr/libexec`下的`.la`文件。现在`.la`文件只对`libltdl`有用，并且LFS中`libltdl`不会加载任何库。此外`.la`文件容易导致一些包的构建失败

```
# find /usr/{lib,libexec} -name \*.la -delete
```

现在可以删除`/tools`目录，也可以选择不删，留作备用，可以把`/tools`移动出来单独备份

```
# rm -rf /tools
```

**备份**

如果按照前文所述删除文件，备份通常需要小于2GB的磁盘空间。备份压缩可能需要耗费较长的CPU时间

首先必须退出`chroot`

退出后卸载`$LFS/dev/shm` `$LFS/dev/pts` `$LFS/{sys,proc,run,dev}`（前面[挂载操作](#241-准备工作)的反操作），保证`$LFS`下没有挂载vfs，可以写成脚本

```
# cd $LFS
# umount dev/shm
# umount dev/pts
# umount sys
# umount proc
# umount run
# umount dev
```

以`root`身份打包成`tar`

```
# cd $LFS
# tar -cJpf /path/to/backup/lfs-base.tar.xz .
```

> `-c`表示创建`tar`档，`-J`表示调用`xz`压缩，`-p`表示保留所有权限设定

打包完以后想要继续构建不要忘记重新挂载vfs

**恢复**

后续想要恢复，只需解压即可，再挂载vfs即可`chroot`从头开始

```
# cd $LFS
# rm -rf ./*
# tar -xpf /path/to/backup/lfs-base.tar.xz
```

## 3 LFS：构建系统剩余部分

## 3.1 简介

这里不建议过早开额外的优化参数，最好等所有包都构建通过并且功能确认无误，再考虑尝试从顶层包开始开优化参数重构建。况且大部分包的优化参数实际上在配置中默认已经被维护者打开了，很多包都会开`-O2`或`-O3`。有些基础包例如`gcc` `glibc`尤其不建议开优化参数

此外不要将库构建为静态库版本，尽可能全部构建为动态库

## 3.2 包管理

LFS没有包管理相关内容。从前面的构建流程其实已经可以感受到给包逐个做配置的繁琐，并且后面还要考虑到如何正确地卸载或更新一个包。此外包和包之间还有依赖问题需要解决。这些都是包管理系统需要做的事情

可以考虑的包管理工具（以及配套的构建系统）：ArchLinux的`pacman`，AlpineLinux的`apk`，Debian的`apt`，或者可以尝试NixOS的`nix`

> Linux内核和用户空间之间做了很好的解耦，所以更新Linux内核通常可以完全不动用户空间的任何程序，直接安装新内核重启就可以正常使用
>
> 动态库版本更新后通常文件名会更改，导致原来链接到该动态库的程序无法运行。所有这些直接相关的程序需要同步重构建
>
> 有时候降级动态库，其文件名中的版本号（一般是后缀）会变小。如果不把版本号大的文件删除，因为`ldconfig`会默认选择版本号大的库文件，这会导致其他程序依旧链接到原来的库
>
> 更新动态库后也必须重启所有链接到该动态库的程序
>
> 更新包时，如果有相关进程正在运行，最好先停止该进程，或者至少把原来的文件删除干净再安装新的文件。`install`命令和普通的复制命令不同，`install`命令就是会在安装前先删除原来的文件

## 3.3 剩余部分构建

### 3.3.1 man-pages

**构建与安装**

先删除2个`libxcrypt`的文档，后面`libxcrypt`会安装一个更好的版本

```
# rm man3/crypt*
```

构建并安装

```
# make -R GIT=false prefix=/usr install
```

> `-R`防止`make`设定内部变量，`GIT=false`防止调用`git`（目前不可用）

> Linux下将`man`分为几个section，每个section对应一种说明类型，同一个程序可能会提供多个section的说明。最常见的有`man1` `man3` `man8`等

| Section | 说明类型 |
| :- | :- |
| `man1` | Executable programs or shell commands，程序本身的命令行用法 |
| `man2` | System calls (functions provided by the kernel)，系统调用函数 |
| `man3` | Library calls (functions within program libraries)，库函数 |
| `man4` | Special files (usually found in /dev)，特殊文件说明 |
| `man5` | File formats and conventions, e.g. /etc/passwd，普通文件格式说明 |
| `man6` | Games，游戏说明 |
| `man7` | Miscellaneous (including macro packages and conventions), e.g. man(7), groff(7), man-pages(7)，杂项 |
| `man8` | System administration commands (usually only for root)，只有root身份可以执行的命令用法 |
| `man9` | Kernel routines [Non standard]，基本不使用 |

### 3.3.2 iana-etc

**安装**

直接复制

```
# cp services protocols /etc
```

### 3.3.3 glibc

**构建**

先打`i18n`补丁

```
# patch -Np1 -i ../glibc-2.41-fhs-1.patch
```

创建`build`

```
# mkdir build
# cd build
```

让`ldconfig`和`sln`安装到`/usr/sbin`

```
# echo "rootsbindir=/usr/sbin" > configparms
```

```
# ../configure --prefix=/usr            \
> --disable-werror                      \ # 后面要跑test suite，所以这里关-Werror参数
> --enable-kernel=5.4                   \
> --enable-stack-protector=strong       \ # 开栈溢出保护。虽然构建gcc时会开--enable-default-ssp，但是glibc默认不会遵从这个设定
> --disable-nscd                        \ # 不构建nscd名称服务守护进程
> libc_cv_slibdir=/usr/lib                # 指定正确的库文件目录，而不是使用lib64
```

**测试**

运行testsuite

```
# make check
```

可以忽略以下警告

+ `io/tst-lchmod`错误

+ 超时错误，可以通过`grep "Timed out" $(find -name \*.out)`找到，例如`nss/tst-nss-files-hosts-multi`和`nptl/tst-thread-affinity*`。遇到这类超时可以使用`make test`例如`TIMEOUTFACTOR=10 make test t=nss/tst-nss-files-hosts-multi`重跑单个测试

+ CPU较旧可能遇到`elf/tst-cpu-features-cpuinfo`失败，构建机内核版本可能导致`stdlib/tst-arc4random-thread`失败

**安装**

安装前可以创建一个`/etc/ld.so.conf`的空文件，否则可能报错

```
# touch /etc/ld.so.conf
```

修改`Makefile`，跳过完整性检查

找到有`test-installation`的行，把`$(PERL)`改成`echo not running`

```
echo not running
```

使用`sed`命令

```
# sed '/test-installation/s@$(PERL)@echo not running@' -i ../Makefile
```

安装

```
# make install
```

修改一下`/usr/bin/ldd`脚本中的动态链接器路径，把`/usr`前缀都删了

```
# sed '/RTLDLIST=/s@/usr@@g' -i /usr/bin/ldd
```

**安装locale**

安装部分`locale`。如果不安装`locale`可能会跳过一些重要的检查点。命令较多建议写成脚本运行

```
localedef -i C -f UTF-8 C.UTF-8
localedef -i cs_CZ -f UTF-8 cs_CZ.UTF-8
localedef -i de_DE -f ISO-8859-1 de_DE
localedef -i de_DE@euro -f ISO-8859-15 de_DE@euro
localedef -i de_DE -f UTF-8 de_DE.UTF-8
localedef -i el_GR -f ISO-8859-7 el_GR
localedef -i en_GB -f ISO-8859-1 en_GB
localedef -i en_GB -f UTF-8 en_GB.UTF-8
localedef -i en_HK -f ISO-8859-1 en_HK
localedef -i en_PH -f ISO-8859-1 en_PH
localedef -i en_US -f ISO-8859-1 en_US
localedef -i en_US -f UTF-8 en_US.UTF-8
localedef -i es_ES -f ISO-8859-15 es_ES@euro
localedef -i es_MX -f ISO-8859-1 es_MX
localedef -i fa_IR -f UTF-8 fa_IR
localedef -i fr_FR -f ISO-8859-1 fr_FR
localedef -i fr_FR@euro -f ISO-8859-15 fr_FR@euro
localedef -i fr_FR -f UTF-8 fr_FR.UTF-8
localedef -i is_IS -f ISO-8859-1 is_IS
localedef -i is_IS -f UTF-8 is_IS.UTF-8
localedef -i it_IT -f ISO-8859-1 it_IT
localedef -i it_IT -f ISO-8859-15 it_IT@euro
localedef -i it_IT -f UTF-8 it_IT.UTF-8
localedef -i ja_JP -f EUC-JP ja_JP
localedef -i ja_JP -f SHIFT_JIS ja_JP.SJIS 2> /dev/null || true
localedef -i ja_JP -f UTF-8 ja_JP.UTF-8
localedef -i nl_NL@euro -f ISO-8859-15 nl_NL@euro
localedef -i ru_RU -f KOI8-R ru_RU.KOI8-R
localedef -i ru_RU -f UTF-8 ru_RU.UTF-8
localedef -i se_NO -f UTF-8 se_NO.UTF-8
localedef -i ta_IN -f UTF-8 ta_IN.UTF-8
localedef -i tr_TR -f UTF-8 tr_TR.UTF-8
localedef -i zh_CN -f GB18030 zh_CN.GB18030
localedef -i zh_HK -f BIG5-HKSCS zh_HK.BIG5-HKSCS
localedef -i zh_TW -f UTF-8 zh_TW.UTF-8
```

如果想要安装全部`locale`（`glibc-2.41/localedata/SUPPORTED`里列出的）

```
# make localedata/install-locales
```

如果还想要安装遗漏的`locale`示例

```
# localedef -i C -f UTF-8 C.UTF-8
# localedef -i ja_JP -f SHIFT_JIS ja_JP.SJIS 2> /dev/null || true
```

**小版本升级**

以下步骤需要按顺序完成

+ 如果是从LFS12.0之前的版本升级，需要安装`libxcrypt`[3.3.25](#3325-libxcrypt)，用`libcrypt.so.1*`替换掉`libcrypt.so.1`

+ 如果是在LFS12.1前的系统，需要删除`/usr/sbin/nscd`

+ 如果用的是`5.4`之前的老内核，需要同时更新内核和内核头文件

+ 使用`DESTDIR`先把动态库安装到一个临时目录，再`install`到`/usr/lib`

```
# make DESTDIR=$PWD/dest install
# install -vm755 dest/usr/lib/*.so.* /usr/lib
```

+ 执行`make install`安装

+ 修改一下`/usr/bin/ldd`脚本中的动态链接器路径，把`/usr`前缀都删了

```
RTLDLIST="/lib64/ld-linux-x86-64.so.2 /lib/ld-linux.so.2 /libx32/ld-linux-x32.so.2"
```

+ 安装`locale`

+ 立即重启

+ 重启后如果是LFS12.0之前的版本，构建时没有使用`--disable-fixincludes`参数，需要将`/usr/lib/gcc/x86_64-lfs-linux-gnu/xx.x.x/include-fixed`下两个文件`limits.h`和`syslimits.h`移动到`/usr/lib/gcc/x86_64-lfs-linux-gnu/xx.x.x/include`下，同时删除`/usr/lib/gcc/x86_64-lfs-linux-gnu/xx.x.x/include-fixed`下其他所有文件。更新的版本不需要

**NSS配置**

`glibc`需要依赖于`/etc/nsswitch.conf`，否则网络功能不正常

```
passwd: files
group: files
shadow: files

hosts: files dns
networks: files

protocols: files
services: files
ethers: files
rpc: files
```

**时区配置**

解压`tzdata2025a.tar.gz`到当前目录

```
# tar -xf ../../tzdata2025a.tar.gz
```

创建目录（也可以不创建，后面也不用在里面创建时区，但是部分应用或testsuite可能会出错）

```
# mkdir /usr/share/zoneinfo/{posix,right}
```

依次创建`posix`时区，`right`时区（包含`leapseconds`）

```
for tz in etcetera southamerica northamerica europe africa antarctica \
    asia australasia backward; do
    zic -L /dev/null   -d $ZONEINFO       ${tz}
    zic -L /dev/null   -d $ZONEINFO/posix ${tz}
    zic -L leapseconds -d $ZONEINFO/right ${tz}
done
```

把`zone.tab` `zone1970.tab` `iso3166.tab`放到`/usr/share/zoneinfo`

```
# cp zone.tab zone1970.tab iso3166.tab /usr/share/zoneinfo
```

创建`posixrules`。因为POSIX规定夏令时以美国时间为准，所以这里选纽约时间

```
# zic -d /usr/share/zoneinfo -p America/New_York
# unset tz
```

查找时区名称

```
# tzselect
```

依照上述命令的结果设定时区，示例

```
ln -sf /usr/share/zoneinfo/Asia/Hong_Kong /etc/localtime
```

**动态链接器配置**

`/lib/ld-linux.so.2`默认只会从`/usr/lib`找动态库。需要在`/etc/ld.so.conf`添加额外路径

```
/usr/local/lib
/opt/lib
```

`/etc/ld.so.conf`还可以包含其他文件，添加以下行

```
include /etc/ld.so.conf.d/*.conf
```

创建目录

```
# mkdir -p /etc/ld.so.conf.d
```

### 3.3.4 zlib

**构建**

```
# ./configure --prefix=/usr
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

删除一个无用静态库

```
# rm -f /usr/lib/libz.a
```

### 3.3.5 bzip2

**构建**

先打文档补丁

```
# patch -Np1 -i ../bzip2-1.0.8-install_docs-1.patch
```

确保符号链接是相对路径，将所有`ln -s -f $(PREFIX)/bin/`前缀删除

```
# sed -i 's@\(ln -s -f \)$(PREFIX)/bin/@\1@' Makefile
```

确保man pages安装到正确位置，安装到`/usr/share/man`

```
# sed -i "s@(PREFIX)/man@(PREFIX)/share/man@g" Makefile
```

使用`Makefile-libbz2_so`构建，这样先构建出`libbz2.so`，后面其他程序动态链接到这个库

```
# make -j16 -f Makefile-libbz2_so
# make clean
```

再执行`make`

```
# make -j16
```

**安装**

```
# make PREFIX=/usr install
```

安装动态库

```
# cp -a libbz2.so.* /usr/lib
# ln -s libbz2.so.1.0.8 /usr/lib/libbz2.so
```

删除静态库

```
# rm /usr/lib/libbz2.a
```

安装共享库分离版`bzip2`

```
# cp bzip2-shared /usr/bin/bzip2
# ln -sf bzip2 /usr/bin/bzcat
# ln -sf bzip2 /usr/bin/bunzip2
```

### 3.3.6 xz

**构建**

```
# ./configure --prefix=/usr     \
> --disable-static              \
> --docdir=/usr/share/doc/xz-5.6.4
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.7 lz4

**构建**

```
# make -j16 BUILD_STATIC=no PREFIX=/usr
```

**测试**

```
# make -j1 check
```

**安装**

```
# make BUILD_STATIC=no PREFIX=/usr install
```

### 3.3.8 zstd

**构建**

```
# make -j16 prefix=/usr
```

**测试**

```
# make check
```

**安装**

```
# make prefix=/usr install
```

删除静态库

```
# rm /usr/lib/libzstd.a
```

### 3.3.9 file

**构建**

```
# ./configure --prefix=/usr
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.10 readline

**构建**

重新安装`readline`默认会把原来的库文件重命名为`.old`后缀。这可能导致`ldconfig`出错。修改一下`Makefile.in`和`support/shlib-install`，分别删除`MV.*old`操作，以及把`{OLDSUFF}`的行替换为`:`字符

```
# sed -i '/MV.*old/d' Makefile.in
# sed -i '/{OLDSUFF}/c:' support/shlib-install
```

从`support/shobj-conf`删除`rpath`库查找目录

```
# sed -i 's/-Wl,-rpath,[^ ]*//' support/shobj-conf
```

配置

```
# ./configure --prefix=/usr     \ 
> --disable-static              \
> --with-curses                 \ # 指示可以从curses库里找到termcap库的功能，没有单独的termcap库。这样可以生成正确的readline.pc
> --docdir=/usr/share/doc/readline-8.2.13
```

构建，强制链接`lncursesw`

```
# make -j16 SHLIB_LIBS="-lncursesw"
```

**安装**

```
# make install
```

安装文档

```
# install -v -m644 doc/*.{ps,pdf,html,dvi} /usr/share/doc/readline-8.2.13
```

### 3.3.11 m4

**构建**

```
# ./configure --prefix=/usr
# make -j16
```

**安装**

```
# make install
```

### 3.3.12 bc

**构建**

```
# CC=gcc ./configure --prefix=/usr -G -O3 -r # -G省略一些测试项，-r使用readline
# make -j16
```

**测试**

```
# make test
```

**安装**

```
# make install
```

### 3.3.13 flex

**构建**

```
# ./configure --prefix=/usr \
> --docdir=/usr/share/doc/flex-2.6.4 \
> --disable-static
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
# ln -s flex /usr/bin/lex
# ln -s flex.1 /usr/share/man/man1/lex.1
```

### 3.3.14 tcl

**构建**

```
# SRCDIR=$(pwd)
# cd unix
# ./configure --prefix=/usr     \
> --mandir=/usr/share/man       \
> --disable-rpath                 # 不要把库搜索路径硬编码进二进制文件里
```

```
# make -j16
```

修改一下配置脚本，把里面源码路径改为安装路径，这些配置脚本后面会被其他使用`tcl`的包用到

```
# sed -e "s|$SRCDIR/unix|/usr/lib|"     \
> -e "s|$SRCDIR|/usr/include|"          \
> -i tclConfig.sh

# sed -e "s|$SRCDIR/unix/pkgs/tdbc1.1.10|/usr/lib/tdbc1.1.10|"  \
> -e "s|$SRCDIR/pkgs/tdbc1.1.10/generic|/usr/include|"          \
> -e "s|$SRCDIR/pkgs/tdbc1.1.10/library|/usr/lib/tcl8.6|"       \
> -e "s|$SRCDIR/pkgs/tdbc1.1.10|/usr/include|"                  \
> -i pkgs/tdbc1.1.10/tdbcConfig.sh

# sed -e "s|$SRCDIR/unix/pkgs/itcl4.3.2|/usr/lib/itcl4.3.2|"    \
> -e "s|$SRCDIR/pkgs/itcl4.3.2/generic|/usr/include|"           \
> -e "s|$SRCDIR/pkgs/itcl4.3.2|/usr/include|"                   \
> -i pkgs/itcl4.3.2/itclConfig.sh
```

```
# unset SRCDIR
```

**测试**

```
# make test
```

**安装**

```
# make install
```

将库改为可写，后续可以删除调试符号

```
# chmod u+w /usr/lib/libtcl8.6.so
```

安装头文件

```
# make install-private-headers
```

符号链接

```
# ln -sf tclsh8.6 /usr/bin/tclsh
```

重命名和`perl`冲突的头文件

```
# mv /usr/share/man/man3/{Thread,Tcl_Thread}.3
```

安装文档

```
# cd ..
# tar -xf ../tcl8.6.16-html.tar.gz --strip-components=1
# mkdir -p /usr/share/doc/tcl-8.6.16
# cp -r  ./html/* /usr/share/doc/tcl-8.6.16
```

### 3.3.15 expect

**构建**

先检查一下PTY是否正常工作，应当返回`ok`，否则需要检查是不是vfs是否正确挂载

```
# python3 -c 'from pty import spawn; spawn(["echo", "ok"])'
```

打补丁

```
# patch -Np1 -i ../expect-5.45.4-gcc14-1.patch
```

```
# ./configure --prefix=/usr         \
> --with-tcl=/usr/lib               \ # tclConfig.sh所在位置
> --enable-shared                   \
> --disable-rpath                   \
> --mandir=/usr/share/man           \
> --with-tclinclude=/usr/include      # tcl头文件
```

```
# make -j16
```

**测试**

```
# make test
```

**安装**

```
# make install
# ln -sf expect5.45.4/libexpect5.45.4.so /usr/lib
```

### 3.3.16 dejagnu

**构建**

```
# mkdir build
# cd build
# ../configure --prefix=/usr
# makeinfo --html --no-split -o doc/dejagnu.html ../doc/dejagnu.texi
# makeinfo --plaintext       -o doc/dejagnu.txt  ../doc/dejagnu.texi
```

**测试**

```
# make check
```

**安装**

```
# make install
# install -dm755  /usr/share/doc/dejagnu-1.6.3
# install -m644   doc/dejagnu.{html,txt} /usr/share/doc/dejagnu-1.6.3
```

### 3.3.17 pkgconf

**构建**

```
# ./configure --prefix=/usr             \
> --disable-static                      \
> --docdir=/usr/share/doc/pkgconf-2.3.0
# make -j16
```

**安装**

```
# make install
# ln -s pkgconf   /usr/bin/pkg-config
# ln -s pkgconf.1 /usr/share/man/man1/pkg-config.1
```

### 3.3.18 binutils

**构建**

```
# mkdir build
# cd build
# ../configure --prefix=/usr    \
> --sysconfdir=/etc             \
> --enable-ld=default           \ # 构建默认bfd链接器，安装为ld和ld.bfd
> --enable-plugins              \ # 开启插件支持
> --enable-shared               \
> --disable-werror              \
> --enable-64-bit-bfd           \
> --enable-new-dtags            \
> --with-system-zlib            \ # 使用已安装的zlib
> --enable-default-hash-style=gnu
```

```
# make -j16 tooldir=/usr
```

> 设定`tooldir`是为了强制安装到`/usr`，防止安装到`/usr/x86_64-pc-linux-gnu`，这是交叉工具链才会安装的地方

**测试**

```
# make -k check
```

检查是否有失败项目

```
# grep '^FAIL:' $(find -name '*.log')
```

**安装**

```
# make tooldir=/usr install
```

删除一些没有用的静态库

```
# rm -rf /usr/lib/lib{bfd,ctf,ctf-nobfd,gprofng,opcodes,sframe}.a /usr/share/doc/gprofng/
```

### 3.3.19 gmp

**构建**

GMP默认会检测主机CPU的特性并开启相应优化支持，例如使用较新的指令集。如果目标机CPU比构建机更老，尤其在AVX/SSE/FMA等指令支持有所不同时，建议加上`--host=none-linux-gnu`参数来兼容

```
# ./configure --prefix=/usr         \
> --enable-cxx                      \ # 开C++支持
> --disable-static                  \
> --docdir=/usr/share/doc/gmp-6.3.0
```

```
# make -j16
# make html
```

**测试**

```
# make check 2>&1 | tee gmp-check-log
# awk '/# PASS:/{total+=$3} ; END{print total}' gmp-check-log
```

> 确保至少通过199项测试

**安装**

```
# make install
# make install-html
```

### 3.3.20 mpfr

**构建**

```
# ./configure --prefix=/usr         \
> --disable-static                  \
> --enable-thread-safe              \
> --docdir=/usr/share/doc/mpfr-4.2.1
```

```
# make -j16
# make html
```

**测试**

```
# make check
```

**安装**

```
# make install
# make install-html
```

### 3.3.21 mpc

**构建**

```
# ./configure --prefix=/usr         \
> --disable-static                  \
> --docdir=/usr/share/doc/mpc-1.3.1
```

```
# make -j16
# make html
```

**测试**

```
# make check
```

**安装**

```
# make install
# make install-html
```

### 3.3.22 attr

**构建**

```
# ./configure --prefix=/usr     \
> --disable-static              \
> --sysconfdir=/etc             \
> --docdir=/usr/share/doc/attr-2.5.2
```

```
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.23 acl

**构建**

```
# ./configure --prefix=/usr     \
> --disable-static              \
> --docdir=/usr/share/doc/acl-2.3.2
```

```
# make -j16
```

**测试**

```
# make check
```

> 这里`test/cp.test`会fail是正常的，因为`coreutils`还没有重新编译为支持`acl`的

**安装**

```
# make install
```

### 3.3.24 libcap

**构建**

防止安装静态库，删除`libcap/Makefile`里面`install -m.*STA`的行

```
# sed -i '/install -m.*STA/d' libcap/Makefile
```

```
# make -j16 prefix=/usr lib=lib
```

**测试**

```
# make test
```

**安装**

```
# make prefix=/usr lib=lib install
```

### 3.3.25 libxcrypt

**构建**

```
# ./configure --prefix=/usr             \
> --enable-hashes=strong,glibc          \ # 包括加强的哈希算法以及兼容glibc libcrypt的哈希算法
> --enable-obsolete-api=no              \ # 禁用旧接口
> --disable-static                      \
> --disable-failure-tokens                # 禁用failure token特性，因为这是glibc平台。failure token在部分平台提供旧有哈希库的兼容
```

```
# make -j16
```

> 如果有使用闭源软件的需求，并且该软件会链接到该库且要求ABI Version 1，可能会有开`obsolete api`的需求。这种情况在最后安装完以后需要再执行如下命令

```
# ./configure --prefix=/usr         \
> --enable-hashes=strong,glibc      \
> --enable-obsolete-api=glibc       \
> --disable-static                  \
> --disable-failure-tokens
# cp -a --remove-destination .libs/libcrypt.so.1* /usr/lib
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.26 shadow

如果想要使用`pam`强制使用强密码，在构建`shadow`之前需要先构建安装`pam`，之后再构建安装`shadow`。在BLFS阶段会有讲述

**构建**

禁止安装`groups`以及对应man pages，从Makefile中删除，因为前面`coreutils`已经包含了这些内容。加上禁止一些其他的man page的安装，前面在安装`man-pages`包的时候已经安装过了

```
# sed -i 's/groups$(EXEEXT) //' src/Makefile.in
# find man -name Makefile.in -exec sed -i 's/groups\.1 / /'   {} \;
# find man -name Makefile.in -exec sed -i 's/getspnam\.3 / /' {} \;
# find man -name Makefile.in -exec sed -i 's/passwd\.5 / /'   {} \;
```

`shadow`如果不配置默认会用`crypt`加密密码。需要配置成`YESCRYPT`以支持8字符以上的密码

```
# sed 's:#ENCRYPT_METHOD DES:ENCRYPT_METHOD YESCRYPT:' -i etc/login.defs
```

将邮件路径从`/var/spool/mail`改到`/var/mail`

```
# sed 's:/var/spool/mail:/var/mail:' -i etc/login.defs
```

禁止将`/bin`和`/sbin`添加到`PATH`

```
# sed '/PATH=/{s@/sbin:@@;s@/bin:@@}' -i etc/login.defs
```

执行`configure`

```
# touch /usr/bin/passwd
# ./configure --sysconfdir=/etc     \
> --disable-static                  \
> --with-{b,yes}crypt               \ # 使用libxcrypt的bcrypt和yescrypt哈希算法，比传统SHA算法具备更高的安全性，不易通过GPU暴力破解
> --without-libbsd                  \ # 不要使用libbsd的readpassphrase，使用内置函数读取
> --with-group-name-max-length=32     # 组名最长允许32字节。用户名最长默认允许32字节
```

> 先创建`/usr/bin/passwd`是为了防止安装到错误的路径

```
# make -j16
```

**安装**

```
# make exec_prefix=/usr install
# make -C man install-man
```

**配置**

`shadow`包含了很多用于管理账户的命令，常用的有`passwd` `chsh` `groupadd` `groupmod` `login` `su` `useradd` `usermod`等

如果使用了`shadow`，确保一些需要密码验证的应用兼容`shadow`以及其密码

开启shadowed passwords

```
# pwconv
```

开启shadowed用户组密码

```
# grpconv
```

最后可以按需设定用户密码

```
# passwd root
```

> 创建新用户和组默认从`1000`开始分配新的ID。如果默认配置可以满足需求，到这里为止就可以结束了
>
> 如果默认的创建用户行为不满足需求，可以通过`/etc/default/useradd`配置添加新用户的默认行为。该配置文件必须使用以下命令创建

```
# useradd -D --gid 999
```

> 上述命令创建`/etc/default/useradd`，其中有参数`GROUP=999`表示从`999`开始分配新的GID，`CREATE_MAIL_SPOOL=yes`为每个新用户创建一个邮件目录，目录属于`mail`用户组并且权限`0660`。如果不想创建邮件文件，改成`no`就行

### 3.3.27 gcc

第3遍构建

**构建**

和前面一样把`lib64`改为`lib`

```
# sed '/m64=/s/lib64/lib/' -i.orig gcc/config/i386/t-linux64
```

创建`build`目录并在其中构建

```
# mkdir build
# cd build
# ../configure --prefix=/usr    \
> LD=ld                         \ # 使用最近安装的ld，不要使用交叉工具链的
> --enable-languages=c,c++      \
> --enable-default-pie          \ # 位置无关可执行文件。如果不开启，ASLR只会对动态库有效；开启后对可执行文件也有效
> --enable-default-ssp          \ # 开启加强的栈溢出攻击防护
> --enable-host-pie             \
> --disable-multilib            \
> --disable-bootstrap           \
> --disable-fixincludes         \ # 禁止自行修正系统头文件
> --with-system-zlib              # 使用系统zlib库
```

```
# make -j16
```

**测试**

虽然默认不限制栈大小，还是建议显式设定一下栈限制

```
# ulimit -s -H unlimited
```

删除一些会失败的测试

```
# sed -e '/cpython/d' -i ../gcc/testsuite/gcc.dg/plugin/plugin.exp
# sed -e 's/no-pic /&-no-pie /' -i ../gcc/testsuite/gcc.target/i386/pr113689-1.c
# sed -e 's/300000/(1|300000)/' -i ../libgomp/testsuite/libgomp.c-c++-common/pr109062.c
# sed -e 's/{ target nonpic } //' \
> -e '/GOTPCREL/d' -i ../gcc/testsuite/gcc.target/i386/fentryname3.c
```

使用前面创建的`tester`用户身份执行测试

```
# chown -R tester .
# su tester -c "PATH=$PATH make -k -j16 check"
```

查看结果

```
# ../contrib/test_summary | grep -A7 Summ
```

> 可以和`https://gcc.gnu.org/ml/gcc-testresults/`对比。`tsan`测试可能会fail，不影响

**安装**

```
# make install
```

把`/usr/lib/gcc/x86_64-pc-linux-gnu/14.2.0/include{,-fixed}`属主从`tester`改回`root`

```
# chown -R root:root \
> /usr/lib/gcc/x86_64-pc-linux-gnu/14.2.0/include{,-fixed}
```

创建`/usr/lib`符号链接

```
# ln -sr /usr/bin/cpp /usr/lib
```

man page符号链接。而`gcc`本体对应`cc`前面已经创建过所以这里不再创建

```
# ln -s gcc.1 /usr/share/man/man1/cc.1
```

LTO（Link Time Optimization）符号链接

```
# ln -sf ../../libexec/gcc/x86_64-pc-linux-gnu/14.2.0/liblto_plugin.so \
> /usr/lib/bfd-plugins/
```

移动一下`/usr/lib/*gdb.py`

```
# mkdir -p /usr/share/gdb/auto-load/usr/lib
# mv /usr/lib/*gdb.py /usr/share/gdb/auto-load/usr/lib
```

**检验**

试编译一下，用`readelf`看一下动态链接器路径

```
# echo 'int main(){}' > dummy.c
# cc dummy.c -v -Wl,--verbose &> dummy.log
# readelf -l a.out
```

从`log`里看一下是否使用了正确的start文件

```
# grep -E -o '/usr/lib.*/S?crt[1in].*succeeded' dummy.log
```

应该输出大致如下示例，确认找到所有3个`crt*.o`就行

```
/usr/lib/gcc/x86_64-pc-linux-gnu/14.2.0/../../../../lib/Scrt1.o succeeded
/usr/lib/gcc/x86_64-pc-linux-gnu/14.2.0/../../../../lib/crti.o succeeded
/usr/lib/gcc/x86_64-pc-linux-gnu/14.2.0/../../../../lib/crtn.o succeeded
```

从`log`里看一下确认`gcc`查找了正确的头文件

```
# grep -B4 '^ /usr/include' dummy.log
```

输出应该大致如下

```
#include <...> search starts here:
 /usr/lib/gcc/x86_64-pc-linux-gnu/14.2.0/include
 /usr/local/include
 /usr/lib/gcc/x86_64-pc-linux-gnu/14.2.0/include-fixed
 /usr/include
```

从`log`里看一下链接器查找库的路径是否正确

```
# grep 'SEARCH.*/usr/lib' dummy.log |sed 's|; |\n|g'
```

输出应该大致如下

```
SEARCH_DIR("/usr/x86_64-pc-linux-gnu/lib64")
SEARCH_DIR("/usr/local/lib64")
SEARCH_DIR("/lib64")
SEARCH_DIR("/usr/lib64")
SEARCH_DIR("/usr/x86_64-pc-linux-gnu/lib")
SEARCH_DIR("/usr/local/lib")
SEARCH_DIR("/lib")
SEARCH_DIR("/usr/lib");
```

从`log`里看一下是否使用了正确的`libc`

```
# grep "/lib.*/libc.so.6 " dummy.log
```

输出结果

```
attempt to open /usr/lib/libc.so.6 succeeded
```

从`log`里看一下是否使用了正确的动态链接器

```
# grep found dummy.log
```

输出结果

```
found ld-linux-x86-64.so.2 at /usr/lib/ld-linux-x86-64.so.2
```

检查无误后删除

```
# rm dummy.c dummy.log a.out
```

### 3.3.28 ncurses

**构建**

```
# ./configure --prefix=/usr                     \
> --mandir=/usr/share/man                       \
> --with-shared                                 \ # 构建安装动态库
> --without-debug                               \ # 不构建调试库
> --without-normal                              \ # 不构建静态库
> --with-cxx-shared                             \ # 构建安装c++ bindind动态库，不构建静态库
> --enable-pc-files                             \ # 为pkg-config生成安装.pc文件
> --with-pkg-config-libdir=/usr/lib/pkgconfig
```

```
# make -j16
```

> 如果一定要非宽字符版的支持，最后安装完以后可以再通过以下命令构建安装

```
# make distclean
# ./configure --prefix=/usr     \
> --with-shared                 \
> --without-normal              \
> --without-debug               \
> --without-cxx-binding         \
> --with-abi-version=5
# make sources libs
# cp -av lib/lib*.so.5* /usr/lib
```

**安装**

先临时安装到`dest`，再把`libncursesw.so.6.5`通过`install`安装到`/usr/lib`，而不是直接覆写。这在实际应用中有意义，可以防止正在使用`libncursesw`的进程失败。此外修改`curses.h`支持宽字符wchar

```
# make DESTDIR=$PWD/dest install
# install -vm755 dest/usr/lib/libncursesw.so.6.5 /usr/lib
# rm dest/usr/lib/libncursesw.so.6.5
# sed -e 's/^#if.*XOPEN.*$/#if 1/' \
> -i dest/usr/include/curses.h
# cp -a dest/* /
```

创建符号链接，诱导依旧还在使用非宽字符的软件使用宽字符版的库

```
for lib in ncurses form panel menu ; do
    ln -sfv lib${lib}w.so /usr/lib/lib${lib}.so
    ln -sfv ${lib}w.pc    /usr/lib/pkgconfig/${lib}.pc
done
```

创建`libcurses.so`符号链接到`libncursesw.so`

```
# ln -sf libncursesw.so /usr/lib/libcurses.so
```

安装文档

```
# cp -v -R doc -T /usr/share/doc/ncurses-6.5
```

### 3.3.29 sed

**构建**

```
# ./configure --prefix=/usr
# make -j16
# make html
```

**测试**

以`tester`身份运行

```
# chown -R tester .
# su tester -c "PATH=$PATH make check"
```

**安装**

```
# make install
# install -d -m755 /usr/share/doc/sed-4.9
# install -m644 doc/sed.html /usr/share/doc/sed-4.9
```

### 3.3.30 psmisc

**构建**

```
# ./configure --prefix=/usr
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.31 gettext

**构建**

```
# ./configure --prefix=/usr             \
> --disable-static                      \
> --docdir=/usr/share/doc/gettext-0.24
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
# chmod 0755 /usr/lib/preloadable_libintl.so
```

### 3.3.32 bison

**构建**

```
# ./configure --prefix=/usr --docdir=/usr/share/doc/bison-3.8.2
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.33 grep

**构建**

从`egrep.sh`中注释掉`echo`，移除使用`egrep`和`fgrep`的警告，防止测试失败

```
# sed -i "s/echo/#echo/" src/egrep.sh
```

```
# ./configure --prefix=/usr
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.34 bash

**构建**

```
# ./configure --prefix=/usr             \
> --without-bash-malloc                 \
> --with-installed-readline             \ # 使用前面已安装的readline而非内置的版本
> --docdir=/usr/share/doc/bash-5.2.37
# make -j16
```

**测试**

测试用`tester`身份执行。`make tests`会使用`diff`校对测试输出和正确结果，除非明确说明错误可以被忽略，任何`diff`输出都代表输出失败

```
# chown -R tester .
# su -s /usr/bin/expect tester << "EOF"
set timeout -1
spawn make tests
expect eof
lassign [wait] _ _ _ value
exit $value
EOF
```

> `run-builtins`会fail，不影响

**安装**

```
# make install
```

安装完以后执行新的`bash`

```
# exec /usr/bin/bash --login
```

### 3.3.35 libtool

**构建**

```
# ./configure --prefix=/usr
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
# rm -f /usr/lib/libltdl.a
```

### 3.3.36 gdbm

**构建**

```
# ./configure --prefix=/usr     \
> --disable-static              \
> --enable-libgdbm-compat         # 构建libgdbm兼容库，部分包可能需要旧DBM兼容
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.37 gperf

**构建**

```
# ./configure --prefix=/usr --docdir=/usr/share/doc/gperf-3.1
# make -j16
```

**测试**

```
# make -j1 check
```

**安装**

```
# make install
```

### 3.3.38 expat

**构建**

```
# ./configure --prefix=/usr             \
> --disable-static                      \
> --docdir=/usr/share/doc/expat-2.6.4
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

安装文档

```
# install -m644 doc/*.{html,css} /usr/share/doc/expat-2.6.4
```

### 3.3.39 inetutils

**构建**

修改`telnet.c`，以支持`gcc-14.1`上构建

```
# sed -i 's/def HAVE_TERMCAP_TGETENT/ 1/' telnet/telnet.c
```

```
./configure --prefix=/usr   \
> --bindir=/usr/bin         \
> --localstatedir=/var      \
> --disable-logger          \ # 不要安装logger。logger用于向系统日志服务传递信息，util-linux会安装一个更好的版本
> --disable-whois           \ # 不要构建whois
> --disable-rcp             \ # 不要构建一些过时的程序。可以用openssh替代这部分功能
> --disable-rexec           \
> --disable-rlogin          \
> --disable-rsh             \
> --disable-servers           # 不要构建一些过时的服务器程序
```

```
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
# mv /usr/bin/ifconfig /usr/sbin/ifconfig
```

### 3.3.40 less

**构建**

```
# ./configure --prefix=/usr --sysconfdir=/etc # less查找的配置文件路径
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.41 perl

**构建**

设定环境变量。因为会构建`Compress:Raw:Zlib`和`Compress:Raw:BZip2`，以下环境变量强制链接系统已经安装的库而非基于内置的源码构建

```
# export BUILD_ZLIB=False
# export BUILD_BZIP2=0
```

自动检测环境并配置为对应默认配置

```
# sh Configure -des                             \
> -D prefix=/usr                                \
> -D vendorprefix=/usr                          \
> -D privlib=/usr/lib/perl5/5.40/core_perl      \
> -D archlib=/usr/lib/perl5/5.40/core_perl      \
> -D sitelib=/usr/lib/perl5/5.40/site_perl      \
> -D sitearch=/usr/lib/perl5/5.40/site_perl     \
> -D vendorlib=/usr/lib/perl5/5.40/vendor_perl  \
> -D vendorarch=/usr/lib/perl5/5.40/vendor_perl \
> -D man1dir=/usr/share/man/man1                \ # 因为没有安装groff所以不会安装文档。这里强制安装文档
> -D man3dir=/usr/share/man/man3                \
> -D pager="/usr/bin/less -isR"                 \ # 文本查看使用less而非more
> -D useshrplib                                 \
> -D usethreads                                   # 开线程支持
```

```
# make -j16
```

**测试**

```
# TEST_JOBS=$(nproc) make test_harness
```

**安装**

```
# make install
# unset BUILD_ZLIB BUILD_BZIP2
```

### 3.3.42 xml::parser

**构建**

```
# perl Makefile.PL
# make -j16
```

**测试**

```
# make test
```

**安装**

```
# make install
```

### 3.3.43 intltool

**构建**

从`intltool-update.in`中找到`\${`改为`\$\{`

```
# sed -i 's:\\\${:\\\$\\{:' intltool-update.in
```

```
# ./configure --prefix=/usr
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
# install -Dm644 doc/I18N-HOWTO /usr/share/doc/intltool-0.51.0/I18N-HOWTO
```

### 3.3.44 autoconf

**构建**

```
# ./configure --prefix=/usr
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.45 automake

**构建**

```
# ./configure --prefix=/usr --docdir=/usr/share/doc/automake-1.17
# make -j16
```

**测试**

```
# make -j16 check
```

**安装**

```
# make install
```

### 3.3.46 openssl

**构建**

```
# ./config --prefix=/usr    \
> --openssldir=/etc/ssl     \
> --libdir=lib              \
> shared                    \
> zlib-dynamic
```

```
# make -j16
```

**测试**

```
# HARNESS_JOBS=$(nproc) make test
```

> `30-test_afalg.t`会fail不影响，这是因为主机内核没有开`CONFIG_CRYPTO_USER_API_SKCIPHER`，或者没有提供AES-CBC功能

**安装**

不要安装静态库

```
# sed -i '/INSTALL_LIBS/s/libcrypto.a libssl.a//' Makefile
# make MANSUFFIX=ssl install
```

安装文档

```
# mv /usr/share/doc/openssl /usr/share/doc/openssl-3.4.1
# cp -fr doc/* /usr/share/doc/openssl-3.4.1
```

> 因为是安装的共享库，所以`openssl`本身更新时无需重编译其他使用`libcrypto.so`和`libssl.so`的库（大版本更新除外）。更新后需要重启依赖`openssl`的程序

### 3.3.47 libelf

在`elfutils-0.192`

**构建**

```
# ./configure --prefix=/usr     \
> --disable-debuginfod          \
> --enable-libdebuginfod=dummy
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make -C libelf install
# install -vm644 config/libelf.pc /usr/lib/pkgconfig
# rm /usr/lib/libelf.a
```

### 3.3.48 libffi

**构建**

```
# ./configure --prefix=/usr \
> --disable-static          \
> --with-gcc-arch=native
```

```
# make -j16
```

> `libffi`和`gmp`一样会根据CPU特性开优化。`native`表示基于本机CPU特性优化。如果是在其他CPU运行，其他可选项有
>
> Intel：`x86-64` `x86-64-v2` `x86-64-v3` `x86-64-v4` `nocona` `core2` `nahalem` `westmere` `sandybridge` `ivybridge` `haswell` `broadwell` `skylake` `skylake-avx512` `cascadelake` `cooperlake` `tigerlake` `cannonlake` `icelake-client` `icelake-server` `sapphirerapids` `alderlake` `rocketlake` `graniterapids` `arrowlake` `pantherlake` `bonnell` `silvermont` `goldmont` `goldmont-plus` `tremont` `sierraforest` `grandridge` `clearwaterforest`等
>
> AMD：`k8` `opteron` `athlon64` `athlon-fx` `k8-sse3` `opteron-sse3` `athlon64-sse3` `barcelona` `bdver1` `bdver2` `bdver3` `bdver4` `znver1` `znver2` `znver3` `znver4` `znver5`等

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.49 python

**构建**

```
# ./configure --prefix=/usr \
> --enable-shared           \
> --with-system-expat       \ # 链接系统已安装的expat
> --enable-optimizations
```

```
# make -j16
```

**测试**

```
# make test TESTOPTS="--timeout 120"
```

> `test_ssl`可能会`fail`，不影响

**安装**

```
# make install
```

安装文档

```
# install -dm755 /usr/share/doc/python-3.13.2/html
# tar --strip-components=1                  \
> --no-same-owner                           \
> --no-same-permissions                     \
> -C /usr/share/doc/python-3.13.2/html      \
> -xvf ../python-3.13.2-docs-html.tar.bz2
```

> `--no-same-owner`和`--no-same-permissions`保证安装后文件权限和属主正确

**使用**

使用`pip3`可能会报一些警告，主要是使用`root`运行了`pip3`，以及`pip3`会自动检查更新。前者是为了防止和系统包管理冲突，但是这在LFS上面不是问题，并且LFS上面必须使用`root`运行`pip3`。后面的自动更新也不要更，忽略即可

关闭上述警告

```
# cat > /etc/pip.conf << EOF
[global]
root-user-action = ignore
disable-pip-version-check = true
EOF
```

`pip`不会自动重安装已经安装的包，无论是否版本更新。`pip install`更新包需要加`--upgrade`参数，如果是强制重安装同版本或降级，需要使用`--force-reinstall --no-deps`参数

### 3.3.50 flit-core

使用前面下载的本地包

**构建**

```
# pip3 wheel -w dist --no-cache-dir --no-build-isolation --no-deps $PWD
```

> 上述命令给`flit-core`构建wheel archive，并放到指定目录`dist`，而不是放到`/root/.cache/pip`

**安装**

```
# pip3 install --no-index --find-links dist flit_core
```

> 上述命令禁止从PyPI在线仓库获取文件，而是从`dist`目录获取文件

### 3.3.51 wheel

**构建**

```
# pip3 wheel -w dist --no-cache-dir --no-build-isolation --no-deps $PWD
```

**安装**

```
# pip3 install --no-index --find-links dist wheel
```

### 3.3.52 setuptools

**构建**

```
# pip3 wheel -w dist --no-cache-dir --no-build-isolation --no-deps $PWD
```

**安装**

```
# pip3 install --no-index --find-links dist setuptools
```

### 3.3.53 ninja

**构建**

```
# python3 configure.py --bootstrap --verbose
```

> `bootstrap`表示让`ninja`自构建

**安装**

```
# install -m755 ninja /usr/bin/
# install -Dm644 misc/bash-completion /usr/share/bash-completion/completions/ninja
# install -Dm644 misc/zsh-completion  /usr/share/zsh/site-functions/_ninja
```

### 3.3.54 meson

**构建**

```
# pip3 wheel -w dist --no-cache-dir --no-build-isolation --no-deps $PWD
```

**安装**

```
# pip3 install --no-index --find-links dist meson
# install -Dm644 data/shell-completions/bash/meson /usr/share/bash-completion/completions/meson
# install -Dm644 data/shell-completions/zsh/_meson /usr/share/zsh/site-functions/_meson
```

### 3.3.55 kmod

**构建**

```
# mkdir build
# cd build
# meson setup --prefix=/usr ..  \
> --sbindir=/usr/sbin           \
> --buildtype=release           \
> -D manpages=false               # 不要生成man page，因为缺少工具
```

```
# ninja -j16
```

**安装**

```
# ninja install
```

### 3.3.56 coreutils

**构建**

打`i18n`补丁。可能会遇到一些bug

```
# patch -Np1 -i ../coreutils-9.6-i18n-1.patch
```

```
# autoreconf -fv
# automake -af
# FORCE_UNSAFE_CONFIGURE=1 ./configure      \
> --prefix=/usr                             \
> --enable-no-install-program=kill,uptime
```

> 因为上述补丁修改了构建系统所以需要用`autoreconf`重新生成配置文件。正常情况下通过指定`-i`选项可以更新`automake`相关文件，但是因为`coreutils`的`configure.ac`使用了一个旧的`gettext`版本所以不起作用。所以要再执行一遍`automake`更新一下
>
> `FORCE_UNSAFE_CONFIGURE=1`允许`root`执行构建操作
>
> `kill`和`uptime`命令由其他包提供，所以不安装

```
# make -j16
```

**测试**

先运行需要`root`执行的测试

```
# make NON_ROOT_USERNAME=tester check-root
```

剩下的测试需要`tester`身份执行。有些测试要求`tester`隶属于多个不同的组。这里再创建一个`dummy`组，后面删掉

```
# groupadd -g 102 dummy -U tester
```

```
# chown -R tester .
# su tester -c "PATH=$PATH make -k RUN_EXPENSIVE_TESTS=yes check" \
> < /dev/null
```

> 使用`/dev/null`作为输入是为了防止测试中因为访问PTY出错导致失败

测试结束后删除`dummy`组

```
# groupdel dummy
```

**安装**

```
# make install
# mv /usr/bin/chroot /usr/sbin
# mv /usr/share/man/man1/chroot.1 /usr/share/man/man8/chroot.8
# sed -i 's/"1"/"8"/' /usr/share/man/man8/chroot.8
```

### 3.3.57 check

**构建**

```
# ./configure --prefix=/usr --disable-static
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make docdir=/usr/share/doc/check-0.15.2 install
```

### 3.3.58 diffutils

**构建**

```
# ./configure --prefix=/usr
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.59 gawk

**构建**

删除一些多余文件

```
# sed -i 's/extras//' Makefile.in
```

```
# ./configure --prefix=/usr
# make -j16
```

**测试**

```
# chown -R tester .
# su tester -c "PATH=$PATH make check"
```

**安装**

```
# rm -f /usr/bin/gawk-5.3.1
# make install
```

> 这里删除的`gawk-5.3.1`是之前安装的硬链接
>
> 前面已经创建了符号链接`/usr/bin/awk`，这里无需再创建

创建文档符号链接

```
# ln -s gawk.1 /usr/share/man/man1/awk.1
```

安装文档

```
# install -Dm644 doc/{awkforai.txt,*.{eps,pdf,jpg}} -t /usr/share/doc/gawk-5.3.1
```

### 3.3.60 findutils

**构建**

```
# ./configure --prefix=/usr --localstatedir=/var/lib/locate
# make -j16
```

> `localstatedir`指定`locate`数据库路径

**测试**

```
# chown -R tester .
# su tester -c "PATH=$PATH make check"
```

**安装**

```
# make install
```

### 3.3.61 groff

**构建**

```
# PAGE=A4 ./configure --prefix=/usr
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.62 grub

这里先略过，后面在[启动引导](#5-lfs内核编译与uefi启动引导)会讲述

### 3.3.63 gzip

**构建**

```
# ./configure --prefix=/usr
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.64 iproute2

**构建**

不安装`arpd`，它需要Berkeley DB，LFS暂未包含

```
# sed -i /ARPD/d Makefile
# rm -f man/man8/arpd.8
```

```
# make -j16 NETNS_RUN_DIR=/run/netns
```

**安装**

```
# make SBINDIR=/usr/sbin install
```

安装文档

```
# install -Dm644 COPYING README* -t /usr/share/doc/iproute2-6.13.0
```

### 3.3.65 kbd

**构建**

打补丁，解决i386平台后退和delete键在不同keymap行为不一致的问题。补丁后后退键生成`127`，delete键生成最常用的序列

```
# patch -Np1 -i ../kbd-2.7.1-backspace-1.patch
```

删除`resizecons`（修改字体使用`setfont`取代）

```
# sed -i '/RESIZECONS_PROGS=/s/yes/no/' configure
# sed -i 's/resizecons.8 //' docs/man/man8/Makefile.in
```

```
# ./configure --prefix=/usr --disable-vlock
# make -j16
```

> `--disable-vlock`是因为`vlock`需要`pam`支持

**测试**

```
# make check
```

**安装**

```
# make install
```

安装文档

```
# cp -R docs/doc -T /usr/share/doc/kbd-2.7.1
```

### 3.3.66 libpipeline

**构建**

```
# ./configure --prefix=/usr
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.67 make

**构建**

```
# ./configure --prefix=/usr
# make -j16
```

**测试**

```
# chown -R tester .
# su tester -c "PATH=$PATH make check"
```

**安装**

```
# make install
```

### 3.3.68 patch

**构建**

```
# ./configure --prefix=/usr
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.69 tar

**构建**

```
# FORCE_UNSAFE_CONFIGURE=1 ./configure --prefix=/usr
# make -j16
```

**测试**

```
# make check
```

> `capabilities: binary store/restore`测项会失败（没有SELinux），不影响

**安装**

```
# make install
# make -C doc install-html docdir=/usr/share/doc/tar-1.35
```

### 3.3.70 texinfo

**构建**

```
# ./configure --prefix=/usr
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

安装TeX组件

```
# make TEXMF=/usr/share/texmf install-tex
```

> 上述路径指定的是TeX树的根路径，以后安装TeX包会安装到这里

**使用**

`texinfo`使用文件`/usr/share/info/dir`记录已安装的入口。有时因为部分包Makefile的问题该文件可能不会及时更新，可以使用以下命令强制更新

```
# cd /usr/share/info
# rm dir
# for f in *; do install-info $f dir 2>/dev/null; done
```

### 3.3.71 vim

**构建**

先修改一下`vimrc`的默认位置到`/etc`

```
# echo '#define SYS_VIMRC_FILE "/etc/vimrc"' >> src/feature.h
```

```
# ./configure --prefix=/usr
# make -j16
```

**测试**

```
# chown -R tester .
```

删除依赖`curl`和`wget`的测项`test_plugin_glvs`再执行测试，为防止扰乱当前虚拟终端所以重定向到文件`vim-test.log`

```
# sed '/test_plugin_glvs/d' -i src/testdir/Make_all.mak
# su tester -c "TERM=xterm-256color LANG=en_US.UTF-8 make -j1 test" &> vim-test.log
# grep 'ALL DONE' vim-test.log
```

> 这里强制指定`TERM`为`xterm-256color`做测试。查看最后应当有`ALL DONE`

**安装**

```
# make install
# ln -s ../vim/vim91/doc /usr/share/doc/vim-9.1.1166
```

### 3.3.72 markupsafe

**构建**

```
# pip3 wheel -w dist --no-cache-dir --no-build-isolation --no-deps $PWD
```

**安装**

```
# pip3 install --no-index --find-links dist Markupsafe
```

### 3.3.73 jinja2

**构建**

```
# pip3 wheel -w dist --no-cache-dir --no-build-isolation --no-deps $PWD
```

**安装**

```
# pip3 install --no-index --find-links dist Jinja2
```

### 3.3.74 udev

`udev`是`systemd`包的一部分

**构建**

从`50-udev-default.rules.in`删除2个没用的组，`render`改为`video`，删除`sgx`

```
# sed -e 's/GROUP="render"/GROUP="video"/'  \
> -e 's/GROUP="sgx", //'                    \
> -i rules.d/50-udev-default.rules.in
```

从`99-systemd.rules.in`修改一个需要完整安装`systemd`的`rule`，这样就无需依赖完整的`systemd`

```
# sed -i '/systemd-sysctl/s/^/#/' rules.d/99-systemd.rules.in
```

因为只安装`udev`，需要指明网络配置文件的路径，把`systemd`改成`udev`

```
# sed -e '/NETWORK_DIRS/s/systemd/udev/'        \
> -i src/libsystemd/sd-network/network-util.h
```

创建`build`目录

```
# mkdir build
# cd build
# meson setup ..            \
> --prefix=/usr             \
> --buildtype=release       \ # 默认debug，release优化更高
> -D mode=release           \ # 不包含一些还在测试中的特性，更稳定
> -D dev-kvm-mode=0660      \ # 不允许普通用户直接访问kvm
> -D link-udev-shared=false \ # 不要链接libsystemd-shared
> -D logind=false           \ # 不要生成属于systemd的udev规则文件
> -D vconsole=false
```

获取`udev helper`列表并记录到环境变量

```
# export udev_helpers=$(grep "'name' :" ../src/udev/meson.build | \
> awk '{print $3}' | tr -d ",'" | grep -v 'udevadm')
```

显式指定仅构建部分目标，开始构建

```
# ninja -j16 udevadm systemd-hwdb                                   \
> $(ninja -n | grep -Eo '(src/(lib)?udev|rules.d|hwdb.d)/[^ ]*')    \
> $(realpath libudev.so --relative-to .)                            \
> $udev_helpers
```

**安装**

```
# install -vm755 -d {/usr/lib,/etc}/udev/{hwdb.d,rules.d,network}
# install -vm755 -d /usr/{lib,share}/pkgconfig
# install -vm755 udevadm                             /usr/bin/
# install -vm755 systemd-hwdb                        /usr/bin/udev-hwdb
# ln      -svfn  ../bin/udevadm                      /usr/sbin/udevd
# cp      -av    libudev.so{,*[0-9]}                 /usr/lib/
# install -vm644 ../src/libudev/libudev.h            /usr/include/
# install -vm644 src/libudev/*.pc                    /usr/lib/pkgconfig/
# install -vm644 src/udev/*.pc                       /usr/share/pkgconfig/
# install -vm644 ../src/udev/udev.conf               /etc/udev/
# install -vm644 rules.d/* ../rules.d/README         /usr/lib/udev/rules.d/
# install -vm644 $(find ../rules.d/*.rules \
> -not -name '*power-switch*') /usr/lib/udev/rules.d/
# install -vm644 hwdb.d/*  ../hwdb.d/{*.hwdb,README} /usr/lib/udev/hwdb.d/
# install -vm755 $udev_helpers                       /usr/lib/udev
# install -vm644 ../network/99-default.link          /usr/lib/udev/network
```

安装`LFS`提供的一些`rule`

```
# tar -xvf ../../udev-lfs-20230818.tar.xz
# make -f udev-lfs-20230818/Makefile.lfs install
```

安装man pages

```
# tar -xf ../../systemd-man-pages-257.3.tar.xz                        \
> --no-same-owner --strip-components=1                                \
> -C /usr/share/man \
> --wildcards '*/udev*' '*/libudev*' '*/systemd.link.5' '*/systemd-'{hwdb,udevd.service}.8

# sed 's|systemd/network|udev/network|' /usr/share/man/man5/systemd.link.5 > /usr/share/man/man5/udev.link.5

# sed 's/systemd\(\\\?-\)/udev\1/' /usr/share/man/man8/systemd-hwdb.8 > /usr/share/man/man8/udev-hwdb.8

# sed 's|lib.*udevd|sbin/udevd|' /usr/share/man/man8/systemd-udevd.service.8 > /usr/share/man/man8/udevd.8

# rm /usr/share/man/man*/systemd*
```

注销`udev_helpers`变量

```
# unset udev_helpers
```

最后创建数据库。每次硬件信息更新都需要执行一下

```
# udev-hwdb update
```

### 3.3.75 man-db

**构建**

```
# ./configure --prefix=/usr             \
> --docdir=/usr/share/doc/man-db-2.13.0 \
> --sysconfdir=/etc                     \
> --disable-setuid                      \ # 不要将man命令setuid到man用户
> --enable-cache-owner=bin              \ # 缓存文件属主设定为用户bin
> --with-browser=/usr/bin/lynx          \ # 一些默认调用的应用，lynx是一个终端网页浏览器
> --with-vgrind=/usr/bin/vgrind         \ # 源码转groff
> --with-grap=/usr/bin/grap             \ # groff文档图形格式
> --with-systemdtmpfilesdir=            \ # 不要安装systemd相关的文件和目录
> --with-systemdsystemunitdir=
```

```
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.76 procps-ng

**构建**

```
# ./configure --prefix=/usr                 \
> --docdir=/usr/share/doc/procps-ng-4.0.5   \
> --disable-static                          \
> --disable-kill                            \ # 不要构建kill命令，该命令由util-linux包提供
> --enable-watch8bit                          # 为watch命令开启ncursesw支持
```

```
# make -j16
```

**测试**

```
# chown -R tester .
# su tester -c "PATH=$PATH make check"
```

**安装**

```
# make install
```
### 3.3.77 util-linux

**构建**

```
# ./configure --bindir=/usr/bin             \
> --libdir=/usr/lib                         \
> --runstatedir=/run                        \
> --sbindir=/usr/sbin                       \
> --disable-chfn-chsh                       \
> --disable-login                           \
> --disable-nologin                         \
> --disable-su                              \
> --disable-setpriv                         \
> --disable-runuser                         \
> --disable-pylibmount                      \
> --disable-liblastlog2                     \
> --disable-static                          \
> --without-python                          \
> --without-systemd                         \
> --without-systemdsystemunitdir            \
> ADJTIME_PATH=/var/lib/hwclock/adjtime     \
> --docdir=/usr/share/doc/util-linux-2.40.4
```

```
# make -j16
```

**测试**

创建的`/etc/fstab`是空文件，用以防止一些fail

```
# touch /etc/fstab
# chown -R tester .
# su tester -c "make -k check"
```

> `hardlink` `lsfd: inotify` `lsfd: inotify` `utmp: last`可能会fail，不影响。其中`hardlink`如果主机内核编译时没有开`CONFIG_CRYPTO_USER_API_HASH`或者没有提供任何SHA256支持就会fail。`lsfd: inotify`如果主机内核编译时没有开`CONFIG_NETLINK_DIAG`也会fail

**安装**

```
# make install
```

### 3.3.78 e2fsprogs

**构建**

```
# mkdir build
# cd build
# ../configure --prefix=/usr    \
> --sysconfdir=/etc             \
> --enable-elf-shlibs           \ # 编译安装动态库
> --disable-libblkid            \ # 不要构建指定组件，这些组件大多由util-linux提供更好的版本
> --disable-libuuid             \
> --disable-uuidd               \
> --disable-fsck
```

```
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
# rm -f /usr/lib/{libcom_err,libe2p,libext2fs,libss}.a
```

安装`texinfo`包并更新`texinfo`入口

```
# gunzip -v /usr/share/info/libext2fs.info.gz
# install-info --dir-file=/usr/share/info/dir /usr/share/info/libext2fs.info
```

安装一些其他文档

```
# makeinfo -o doc/com_err.info ../lib/et/com_err.texinfo
# install -m644 doc/com_err.info /usr/share/info
# install-info --dir-file=/usr/share/info/dir /usr/share/info/com_err.info
```

修改配置文件`mke2fs.conf`，关`metadata_csum_seed`防止认不到`ext4`

```
# sed 's/metadata_csum_seed,//' -i /etc/mke2fs.conf
```

### 3.3.79 sysklogd

**构建**

```
# ./configure --prefix=/usr                 \
> --sysconfdir=/etc                         \
> --runstatedir=/run                        \
> --without-logger                          \
> --disable-static                          \
> --docdir=/usr/share/doc/sysklogd-2.7.0
```

```
# make -j16
```

**安装**

```
# make install
```

**配置**

创建配置文件`/etc/syslog.conf`，内容如下

```
auth,authpriv.* -/var/log/auth.log
*.*;auth,authpriv.none -/var/log/sys.log
daemon.* -/var/log/daemon.log
kern.* -/var/log/kern.log
mail.* -/var/log/mail.log
user.* -/var/log/user.log
*.emerg *

# Do not open any internet ports.
secure_mode 2
```

### 3.3.80 sysvinit

**构建**

打补丁

```
# patch -Np1 -i ../sysvinit-3.14-consolidated-1.patch
```

```
# make -j16
```

**安装**

```
# make install
```

## 3.4 删除调试符号

默认情况下，上述大部分包在构建时都是向`gcc`传`-g`参数的，会携带调试符号。**如果没有调试的需求**，把调试符号去除可以使得ELF文件占用空间大大减小。例如`bash`去除调试符号以后体积会减小约60%，`gcc`和`glibc`去除调试符号以后体积会减小约82%（大部分都可以减小50%到80%）。当然如果有调试的需求那么还是不用执行这一步，保留原样即可

> 建议到这里还是先退出`chroot`备份一下。不要忘记先卸载之前挂载的vfs，以及清理一下`$LFS/tmp/`下的内容

```
# cd $LFS
# tar -cJpf /path/to/backup/lfs-bk.tar.xz .
```

直接执行以下脚本。删除调试符号使用`strip`命令。`save_usrlib`中列出的库是需要提取调试信息，压缩为`*.dbg`以后依旧放到`/usr/lib`的，后面`valgrind`和`gdb`的测试会用到。原有库文件删除调试信息，添加`debuglink`指向前述调试信息文件后重新`install`到原位

`online_usrbin`和`online_usrlib`中列出的文件直接删除符号即可，无需另行备份`*.dbg`调试信息

最后保证`/usr/lib`下所有`.so` `.a`库文件，以及`/usr/bin` `/usr/sbin` `/usr/libexec`下所有的文件，除去已经`strip`过的文件，都进行过`strip`操作

> 因为有些文件可能不是二进制文件而是其他格式的文件例如shell脚本，`strip`无法识别会报警告，不影响忽略即可

```shell
#!/bin/bash

save_usrlib="ld-linux-x86-64.so.2
             libc.so.6
             libthread_db.so.1
             libquadmath.so.0.0.0
             libstdc++.so.6.0.33
             libitm.so.1.0.0
             libatomic.so.1.2.0"

cd /usr/lib

for LIB in $save_usrlib; do
    objcopy --only-keep-debug --compress-debug-sections=zlib $LIB $LIB.dbg
    cp $LIB /tmp/$LIB
    strip --strip-unneeded /tmp/$LIB
    objcopy --add-gnu-debuglink=$LIB.dbg /tmp/$LIB
    install -vm755 /tmp/$LIB /usr/lib
    rm /tmp/$LIB
done

online_usrbin="bash find strip"
online_usrlib="libbfd-2.44.so
               libsframe.so.1.0.0
               libhistory.so.8.2
               libncursesw.so.6.5
               libm.so.6
               libreadline.so.8.2
               libz.so.1.3.1
               libzstd.so.1.5.7
               $(cd /usr/lib; find libnss*.so* -type f)"

for BIN in $online_usrbin; do
    cp /usr/bin/$BIN /tmp/$BIN
    strip --strip-unneeded /tmp/$BIN
    install -vm755 /tmp/$BIN /usr/bin
    rm /tmp/$BIN
done

for LIB in $online_usrlib; do
    cp /usr/lib/$LIB /tmp/$LIB
    strip --strip-unneeded /tmp/$LIB
    install -vm755 /tmp/$LIB /usr/lib
    rm /tmp/$LIB
done

for i in $(find /usr/lib -type f -name \*.so* ! -name \*dbg) \
         $(find /usr/lib -type f -name \*.a)                 \
         $(find /usr/{bin,sbin,libexec} -type f); do
    case "$online_usrbin $online_usrlib $save_usrlib" in
        *$(basename $i)* )
            ;;
        * ) strip --strip-unneeded $i
            ;;
    esac
done

unset BIN LIB save_usrlib online_usrbin online_usrlib
```

## 3.5 清理临时文件

清理`/tmp`，里面主要存放的是之前测试相关的文件。如果前面已经清理过那么无需执行

```
# rm -rf /tmp/{*,.*}
```

删除可能遗留的`.la`（`libtool archive`）文件。`.la`文件只对`libltdl`有用

```
# find /usr/lib /usr/libexec -name \*.la -delete
```

因为现在已经有了新的工具链3，建议完全删除工具链2。工具链2有部分组件依旧遗留在`/usr/x86_64-lfs-linux-gnu`，例如`ar as ld`等

```
# find /usr -depth -name x86_64-lfs-linux-gnu\* | xargs rm -rf
```

删除临时的`tester`用户

```
# userdel -r tester
```

## 4 LFS：系统配置

## 4.1 sysvinit

Linux内核起来以后首先运行的程序就是`init`。`init`需要在getty拉起`login`让用户登录，以及执行`rc`脚本初始化系统。`init`的行为由`/etc/inittab`控制

LFS中一共有7个runlevel

| runlevel | 定义 |
| :- | :- |
| `0` | Halt |
| `1` | Single User mode |
| `2` | User definable |
| `3` | Full multiuser mode |
| `4` | User definable |
| `5` | Full multiuser mode with display manager |
| `6` | Reboot |

> 默认情况下一般运行于`3`或`5`
>
> `sysvinit`只能串行启动，无法支持cgroups。想要更多高级特性需要更高级的`init`，例如`openrc` `runit` `s6` `dinit` `systemd`等，可以让`sysvinit`带起更高级的`init`，或者直接替代

### 4.1.1 安装启动脚本

安装`lfs-bootscripts`

```
# make install
```

这个包会安装内容到`/etc/rc.d` `/etc/init.d` `/etc/sysconfig` `/lib/services` `/lib/lsb`，在启动与关机时需要调用这些脚本。例如启动时检查挂载文件系统与加载内核模块，启动`udev`，加载内核配置参数；关机前给所有进程发信号停止所有进程，清理临时文件等。此外还有管理网络连接的功能

## 4.2 udev

### 4.2.1 基本概念

**VFS**

首先是一些有关`sysfs`和`devtmpfs`的概念

`/sys`下会挂一个`sysfs`，而`/dev`下会挂一个`devtmpfs`

> 此外现代的Linux系统中常见的还有`/dev/pts`还会挂一个`devpts`，`/dev/shm`会挂一个`shm`，`/dev/mqueue`会挂一个`mqueue`

在古早的Linux系统中会使用一个`MAKEDEV`脚本，调用`mknod`在`/dev`下创建设备节点，只要仅仅是有可能存在的设备都会创建

后来才出现了`udev` `mdev`这样的程序。此外现在的Linux系统中会依据实际存在的设备在`devtmpfs`下创建对应的设备节点

`sysfs`是在Linux 2.6中正式支持的。`sysfs`通常挂载到`/sys`下，它的作用是为用户空间的程序提供硬件设备的信息。识别到设备时，编译到内核里的驱动程序会自动将设备对象注册到`sysfs`。而对于编译为独立模块的驱动程序，只有模块加载时才会将设备对象注册到`sysfs`

只要`sysfs`挂载到`/sys`并且可以访问时，其他用户空间程序，以及`udev`就可以解析其中的内容，例如`udev`可以根据设备信息执行一些操作，对`/dev`下的设备节点做出修改。`/dev`下的设备节点本质最初还是由内核创建的，设备的驱动程序会通过`devtmpfs`创建设备节点

当`devtmpfs`仅仅是挂载到`/dev`时，其中的设备节点会有默认固定的权限，属主与名称。在之后很短时间内核会向`udev`发送`uevent`，`udev`会根据`/etc/udev/rules.d` `/usr/lib/udev/rules.d` `/run/udev/rules.d`目录下的配置文件为对应的设备节点创建符号链接，或者修改权限、属主，或者修改该设备对象对应的`udev`数据库入口等诸多类型的操作。上述3个目录中的配置文件都会以数字为开头命名来表明顺序，并最终被合并。如果`udev`无法匹配到对应设备的规则，就不会做任何事情，直接给`devtmpfs`保留原样

**模块驱动**

其次来了解一下`udev`是如何自动加载驱动模块的。模块驱动不会和内核集成于一体，是分立的文件。模块驱动主要面向类似USB、PCI设备这样可以更换变动的设备

内核驱动模块通常会携带有别名`alias`。`alias`的格式类似`pci:v00001319d00000801sv*sd*bc04sc01i*`，可以看出来它开头的字段和设备的Vendor ID、Device ID有关（PCI、USB这类总线上的设备通常都有`vid`和`did`定义），这个`alias`可以通过`modinfo`查询具体的内核模块得知

已经出现在系统中的设备，上述**设备驱动**的`alias`由**总线驱动**export到`sysfs`，用户可以在例如`/sys/bus/pci/devices/0000:00:0d.0/modalias`看到这个`alias`。如果是多个相同的设备，上述`alias`中的`*`处会不同，代表不同的设备实例

> `/sys/bus`下有许多目录例如`pci` `pci_express` `usb` `i2c` `spi` `serial`，这些目录都代表了系统上存在的总线。其下会包含该总线上安装的设备

`udev`在默认规则下会依据该`alias`设定好名为`MODALIAS`的`uevent`环境变量，调用`/sbin/modprobe`来加载模块驱动。这里采用的是通配符形式，只要驱动模块的`alias`能匹配上就会加载该模块。当然这种情况下如果同一设备有对应多个驱动模块（例如某些AMD显卡），这些驱动模块都会加载，这时候为避免冲突必须防止不想要的模块加载动作

对于热插拔设备也一样，连接设备后内核会触发`uevent`并由`udev`处理，加载模块

> 示例，配置`/etc/modprobe.d/blacklist.conf`实现模块的屏蔽，常见的有为N卡禁用`nouveau`驱动

```
blacklist nouveau
```

除了`udev`以外，内核也是有加载模块的能力的，这通常是一些设备驱动以外的内核模块，例如内核会自动加载网络协议和文件系统支持。`udev`也不负责`wrapper`模块的加载（`wrapper`是指那些为其他模块补足/扩展功能的模块）

> 示例，可以通过配置`/etc/modprobe.d/<filename>.conf`实现`udev`调用`modprobe`加载模块后`modprobe`再自动加载`wrapper`模块，使用`softdep`关键字。`post:`关键字表明前后依赖关系，`snd-pcm-oss`需要在`snd-pcm`加载过后加载

```
softdep snd-pcm post: snd-pcm-oss
```

如果模块仅仅是一个独立模块不和任何`udev`自动加载的模块有依赖关系，在LFS这里需要配置`/etc/sysconfig/modules`脚本来实现启动时的模块加载

**故障排查**

由于`udev`先天设计特性，因为时序问题，同一个设备最终创建的设备节点在每次启动后名称可能是不同的。需要修改`udev`规则配置文件固定设备名，示例

```
SUBSYSTEM=="net", DEVPATH=="/devices/platform/fe4f0000.pcie/pci0000:00/0000:00:00.0/0000:01:00.0/net/*", NAME="net0"
```

> 上述`DEVPATH`是相对于`/sys`路径而言的，可以启动后通过命令`udevadm info --query=path --path=/sys/class/net/enp1s0`查询。这里将PCIE以太网卡名称固定为`net0`
>
> 这只是解决方案其中一个，更多的方案后面会讲述

使用第三方驱动，如果驱动没有将设备信息export到`sysfs`，`udev`无从知晓该设备的信息，容易出现无设备节点的情况。这种情况下可以在`/usr/lib/udev/devices`创建一个静态设备节点，节点名参考内核文档`devices.txt`。`udev`会将该设备节点拷贝到`/dev`

`udev`规则没有写好的情况下可能出现意外匹配设备的情况。此时也可以尝试使用`udevadm info`辅助诊断

其他例如内核时序问题也可能影响到`udev`规则是否正确起作用，尤其是在规则会使用到`sysfs`下`attribute`的情况下。可以写一个`/etc/udev/rules.d/10-wait_for_sysfs.rules`强制去等待`sysfs`

**使用传统网卡设备命名格式**

前面已经展示过了`udev`下通过规则文件固定网卡设备名的方法。此外`udev`下网卡会依据`enp2s1` `wlp3s0`这样的格式命名。如果想要使用传统的命名方式例如`eth0` `wlan0`，可以使用以下内核命令行参数

```
net.ifnames=0
```

### 4.2.2 设备管理

以下操作的主要目标基本也都是为了克服`udev`下同样的设备在多次开机后可能有不同设备名的问题，强制指定设备名，并解决潜在的命名冲突，创建一致的符号链接

**udev规则：网卡名称示例**

主要示例规则的组成和写法，以及其中部分关键字的作用

LFS下可以使用以下脚本生成可自定义的`udev`规则

```
# bash /usr/lib/udev/init-net-rules.sh
```

生成的规则文件在`/etc/udev/rules.d/70-persistent-net.rules`，其中对于每个网络设备都会有1条设定。示例

```
SUBSYSTEM=="net", ACTION=="add", DRIVERS="?*", ATTR{address}=="xx:xx:xx:xx:xx:xx", ATTR{type}=="1", NAME="eth1"
```

> `ACTION=="add"`表示只在触发的`uevent`为`add`时该条规则才会生效，其他`uevent`例如`remove`和`change`不生效。`DRIVERS="?*"`强制有硬件驱动对应的网络接口才会生效，该条规则对于系统创建的`bridge`虚拟网桥设备或VLAN接口无效。`ATTR{address}`是该网卡的MAC。`ATTR{type}=="1"`避免部分无线网卡设备有多个虚拟接口的情况下发生命名冲突，仅匹配主接口
>
> `NAME`同前，就是我们想要给这个网卡设定的名称

此外`/usr/lib/udev/network/99-default.link`定义了`AlternativeNamesPolicy`，这个设置会影响到网络设备的命名方式，并且这个默认的命名可能和前面用户定义的规则冲突。创建`/etc/udev/network/99-default.link`可以覆盖这个设定，将`=.*$`替换为`=`

**创建符号链接**

主要讲述使用`SYMLINK`关键字创建符号链接时如何基于`by-id`或`by-path`稳定地定位设备

`udev`提供了`/etc/udev/rules.d/83-cdrom-symlinks.rules`文件用于创建`/dev/cdrom`和`/dev/dvd`符号链接，链接到实际的光驱设备路径

设备可以通过`by-id`或`by-path`进行定位，在规则中通常只选择其中一种定位方式。`by-id`通常用于可能更换接口但是不替换设备本身的情况，`by-path`通常用于可能更换设备本身但是不更换接口的情况

可以使用以下命令访问`sysfs`获取相关信息，输出的内容中如果有`ID_SERIAL`或`ID_MODEL` `ID_REVISION`，说明当前设备是按照规则是依据`by-id`定位的；如果是`ID_PATH`则说明是依据`by-path`定位的

```
# udevadm test /sys/block/hdd
```

可以修改`/etc/udev/rules.d/83-cdrom-symlinks.rules`，修改`write_cd_rules`为`write_cd_rules by-id`或`write_cd_rules by-path`强制指定匹配设备的方式

> 除了声卡网卡以外，大部分的设备名不一致问题都可以通过创建一致的符号链接解决

更多示例，为`v4l`设备创建一致的符号链接

首先访问`sysfs`查询设备信息，留意硬件参数

```
# udevadm info -a -p /sys/class/video4linux/video0
```

创建`/etc/udev/rules.d/83-duplicate_devs.rules`文件，写入以下内容

```
KERNEL=="video*", ATTRS{idProduct}=="1910", ATTRS{idVendor}=="0d81", SYMLINK+="webcam"
KERNEL=="video*", ATTRS{device}=="0x036f",  ATTRS{vendor}=="0x109e", SYMLINK+="tvtuner"
```

> 上述规则依据`idProduct idVendor`识别两类设备，并分别为其创建`/dev/webcam`和`/dev/tvtuner`设备节点。`/dev/video0`和`/dev/video1`依旧存在，但是指向的设备不一定

## 4.3 网络管理

### 4.3.1 接口配置文件

LFS将网络接口配置文件放在`/etc/sysconfig`，命名格式示例`ifconfig.eth0`

配置文件格式示例。`sysvinit`的网络脚本会获取里面的内容来设定网络接口

```
ONBOOT=yes
IFACE=eth0
SERVICE=ipv4-static
IP=192.168.1.2
GATEWAY=192.168.1.1
PREFIX=24
BROADCAST=192.168.1.255
```

> `ONBOOT`设定为`yes`表示启动时上线网卡设备。网卡设备在系统运行时也可通过`ifup` `ifdown`命令管理
>
> `IFACE`必须和配置文件后缀一致
>
> `SERVICE`表示获取IP的形式，这里采用静态IP，通过`IP`指定
>
> `GATEWAY`表示默认网关，`PREFIX`表示子网掩码，`BROADCAST`表示广播地址

### 4.3.2 DNS

创建`/etc/resolv.conf`指定DNS服务器地址，示例

```
nameserver 172.16.0.1
nameserver 172.16.0.37
```

> 如果机器有自己的域名，可以通过`domain`参数设定

### 4.3.3 主机名

在`/etc/hostname`设定

```
h81m
```

### 4.3.4 hosts

`/etc/hosts`示例

```
127.0.0.1 localhost.localdomain localhost h81m.localdomain h81m
127.0.1.1 localhost.localdomain localhost h81m.localdomain h81m
::1       localhost.localdomain localhost h81m.localdomain h81m ip6-localhost ip6-loopback
ff02::1   ip6-allnodes
ff02::2   ip6-allrouters
```

## 4.4 sysvinit配置与使用

### 4.4.1 runlevel

前面已经说过LFS里面`sysvinit`有`7`个`runlevel`，分别如下

```
0: halt the computer
1: single-user mode
2: reserved for customization, otherwise the same as 3
3: multi-user mode with networking
4: reserved for customization, otherwise the same as 3
5: same as 4, it is usually used for GUI login (like GNOME's gdm or LXDE's lxdm)
6: reboot the computer 
```

默认`runlevel`为`3`

### 4.4.2 inittab

创建`/etc/inittab`文件，内容如下。`init`会在启动时读取这个文件

```
id:3:initdefault:

si::sysinit:/etc/rc.d/init.d/rc S

l0:0:wait:/etc/rc.d/init.d/rc 0
l1:S1:wait:/etc/rc.d/init.d/rc 1
l2:2:wait:/etc/rc.d/init.d/rc 2
l3:3:wait:/etc/rc.d/init.d/rc 3
l4:4:wait:/etc/rc.d/init.d/rc 4
l5:5:wait:/etc/rc.d/init.d/rc 5
l6:6:wait:/etc/rc.d/init.d/rc 6

ca:12345:ctrlaltdel:/sbin/shutdown -t1 -a -r now

su:S06:once:/sbin/sulogin
s1:1:respawn:/sbin/sulogin

1:2345:respawn:/sbin/agetty --noclear tty1 9600
2:2345:respawn:/sbin/agetty tty2 9600
3:2345:respawn:/sbin/agetty tty3 9600
4:2345:respawn:/sbin/agetty tty4 9600
5:2345:respawn:/sbin/agetty tty5 9600
6:2345:respawn:/sbin/agetty tty6 9600
```

> `init`读取上述文件后就开始调用`rc`命令执行初始化脚本。`/etc/rc.d/rcS.d`目录下会存有一些`S`开头的脚本。`rc`首先会执行这个目录下所有`S`开头的脚本。随后`rc`会根据`runlevel`，执行`/etc/rc.d/rc?.d`下所有`S`开头的脚本，例如指定`runlevel`为`3`，那么会执行`/etc/rc.d/rc3.d`下的脚本
>
> `rc`会到`/lib/lsb/init-functions`下`source`其中的脚本作为支持库。这个库会读取`/etc/sysconfig/rc.site`，这个文件可以存放任意的系统配置参数
>
> 运行的脚本会将日志输出到`/run/var/bootlog`，并在启动完成后写到`/var/log/boot.log`做非易失储存
>
> 使用`openrc`的系统中，只是将上述`rc`命令替换为了`openrc`

### 4.4.3 切换runlevel

切换`runlevel`直接使用`init`命令就可以

示例，关机

```
# init 0
```

`/etc/rc.d`下后若干`rc?.d`目录，`?`可以是`runlevel`号或者`S`，其中包含了一些符号链接。符号链接的命名格式类似`K20*` `S33*`，即一个大写字母加上2个数字的组合。实际上这个`K`表示`kill`，即终止一个进程；而`S`表示`start`，即启动一个进程。后面的数字代表了这些脚本的执行顺序，数字越小越早执行。通过`init`命令切换`runlevel`时会调用这些脚本来启动/停止特定进程

上述目录中的符号链接实际上都链接到`/etc/rc.d/init.d`目录下的脚本，并且通常`S` `K`是链接到同一个脚本的。实际上这些脚本支持接受参数`start` `stop` `restart` `reload` `status`，通过`S`链接调用时相当于传`start`参数，通过`K`链接调用时相当于传`stop`参数

### 4.4.4 udev启动脚本

`udevd`在系统启动时通过脚本`/etc/rc.d/init.d/udev`启动，首次启动会依据规则处理内核已经创建的设备节点。此外该脚本还会取消使用`/sbin/hotplug`作为内核默认的`uevent handler`，因为`udev`起来以后会自动通过socket监听内核的`uevent`

此外还有一个`/etc/rc.d/init.d/udev_retry`脚本。因为有些子系统的`udev`规则可能依赖于尚未挂载的文件系统，该脚本在`mountfs`之后执行以重新触发`uevent`来应用这些规则，正常情况下这些规则应当应用成功。配置文件在`/etc/sysconfig/udev_retry`，其中包含了所有需要在`mountfs`之后重新触发的`subsystem`名称。可以通过`udevadm info --attribute-walk`后接设备路径来查询一个设备的子系统

### 4.4.5 系统时钟

LFS使用`setclock`从系统RTC时钟读取时间并设定。RTC时钟必须设定为UTC。`/etc/localtime`链接到了本地时区，该操作会自动设定到本地时区，因为`hwclock`会通过该文件知道当前处于哪个时区

`setclock`在系统启动后由`udev`调用执行，如果`udev`检测到了RTC时钟硬件

配置文件在`/etc/sysconfig/clock`

```
UTC=1
CLOCKPARAMS=
```

> `UTC=1`表示硬件时钟确实设定为UTC时间

### 4.4.6 终端配置

`console`脚本会读取`/etc/sysconfig/console`作为终端相关配置。如果使用US键盘且在终端没有显示特殊符号（标准ASCII符号以外符号）的需求，通常无需额外配置。可以尝试配置一下字体

键盘类型参考`/usr/share/keymaps`，终端字体参考`/usr/share/consolefonts`，可以分别通过`loadkeys` `setfont`命令设定

可用设定项

| 设定项 | 定义 | 可取值 |
| :- | :- | :- |
| `LOGLEVEL` | 终端打印的内核信息等级，相当于`dmesg -n`设定 | `1`到`8`，默认`7` |
| `KEYMAP` | 键盘类型 | US键盘默认无需设定 |
| `FONT` | 终端字体 | `font -m map`，示例`lat1-16 -m 8859-1` |
| `UNICODE` | 是否将终端设定为`UTF-8`模式，如果locale为UTF-8需要开启 | `1` `0` `yes` `no` `true` `false` |

配置示例

```
UNICODE="1"
FONT="Lat2-Terminus16"
```

### 4.4.7 启动时创建文件

可以在`/etc/sysconfig/createfiles`添加入口实现指定文件的创建

### 4.4.8 配置sysklogd

`sysklogd`脚本会在启动时调用`syslogd`

可以在`/etc/sysconfig/rc.site`配置传给`syslogd`的参数，以下默认清空参数

```
SYSKLOGD_PARMS=
```

### 4.4.9 rc.site配置

`/etc/sysconfig/rc.site`相当于一个全局配置文件。其余任何脚本的配置参数也都可以在这里设置，但是脚本专有的配置文件优先级更高，如果`rc.site`和这些配置文件中的参数有重合，优先取专有配置文件中的参数

默认会给一个如下的默认配置，所有的参数都被注释。可以按需打开

```
# rc.site
# Optional parameters for boot scripts.

# Distro Information
# These values, if specified here, override the defaults
#DISTRO="Linux From Scratch" # The distro name
#DISTRO_CONTACT="lfs-dev@lists.linuxfromscratch.org" # Bug report address
#DISTRO_MINI="LFS" # Short name used in filenames for distro config

# Define custom colors used in messages printed to the screen

# Please consult `man console_codes` for more information
# under the "ECMA-48 Set Graphics Rendition" section
#
# Warning: when switching from a 8bit to a 9bit font,
# the linux console will reinterpret the bold (1;) to
# the top 256 glyphs of the 9bit font.  This does
# not affect framebuffer consoles

# These values, if specified here, override the defaults
#BRACKET="\\033[1;34m" # Blue
#FAILURE="\\033[1;31m" # Red
#INFO="\\033[1;36m"    # Cyan
#NORMAL="\\033[0;39m"  # Grey
#SUCCESS="\\033[1;32m" # Green
#WARNING="\\033[1;33m" # Yellow

# Use a colored prefix
# These values, if specified here, override the defaults
#BMPREFIX="      "
#SUCCESS_PREFIX="${SUCCESS}  *  ${NORMAL} "
#FAILURE_PREFIX="${FAILURE}*****${NORMAL} "
#WARNING_PREFIX="${WARNING} *** ${NORMAL} "

# Manually set the right edge of message output (characters)
# Useful when resetting console font during boot to override
# automatic screen width detection
#COLUMNS=120

# Interactive startup
#IPROMPT="yes" # Whether to display the interactive boot prompt
#itime="3"    # The amount of time (in seconds) to display the prompt

# The total length of the distro welcome string, without escape codes
#wlen=$(echo "Welcome to ${DISTRO}" | wc -c )
#welcome_message="Welcome to ${INFO}${DISTRO}${NORMAL}"

# The total length of the interactive string, without escape codes
#ilen=$(echo "Press 'I' to enter interactive startup" | wc -c )
#i_message="Press '${FAILURE}I${NORMAL}' to enter interactive startup"

# Set scripts to skip the file system check on reboot
#FASTBOOT=yes

# Skip reading from the console
#HEADLESS=yes

# Write out fsck progress if yes
#VERBOSE_FSCK=no

# Speed up boot without waiting for settle in udev
#OMIT_UDEV_SETTLE=y

# Speed up boot without waiting for settle in udev_retry
#OMIT_UDEV_RETRY_SETTLE=yes

# Skip cleaning /tmp if yes
#SKIPTMPCLEAN=no

# For setclock
#UTC=1
#CLOCKPARAMS=

# For consolelog (Note that the default, 7=debug, is noisy)
#LOGLEVEL=7

# For network
#HOSTNAME=mylfs

# Delay between TERM and KILL signals at shutdown
#KILLDELAY=3

# Optional sysklogd parameters
#SYSKLOGD_PARMS="-m 0"

# Console parameters
#UNICODE=1
#KEYMAP="de-latin1"
#KEYMAP_CORRECTIONS="euro2"
#FONT="lat0-16 -m 8859-15"
#LEGACY_CHARSET=
```

### 4.4.10 启动加速

`sysvinit`默认是串行执行所有的初始化操作，速度肯定是比`systemd` `dinit`或者开了并行启动的`openrc`要慢的。想要启动更快可以考虑让`sysvinit`带起另一个`init`，或者直接全套更换

启动时`udev`有一个耗时的操作`udev settle`。如果分区并不复杂，并且只有一张以太网卡，可以开启如下参数，跳过该操作

```
OMIT_UDEV_SETTLE=y
```

`udev_retry`默认也会执行一下`udev settle`，这个操作只有在`/var`是一个单独分区时才需要，因为系统时钟依赖`/var/lib/hwclock/adjtime`。可以开启以下参数在`udev_retry`中跳过`udev settle`操作

```
OMIT_UDEV_SETTLE=y
```

启动时会运行`fsck`且默认不会有任何输出。添加以下参数开启输出

```
VERBOSE_FSCK=y
```

也可以关闭`fsck`，但是不推荐

```
FASTBOOT=y
```

> 临时跳过`fsck`，可以在重启前创建一个`/fastboot`空文件或使用命令`shutdown -f -r now`。反之强制`fsck`可以创建`/forcefsck`或使用命令`shutdown -F -r now`

默认情况下系统启动时会清空`/tmp`。可以跳过该清理操作

```
SKIPTMPCLEAN=y
```

关机时`init`会向所有由它启动的进程发送一个`TERM`信号，并默认最多等待3秒，如果进程没有退出就直接发送一个`KILL`。此外除了服务本身的脚本，`sendsignals`对于任何没有及时停止的进程还会重复一遍上述步骤。上述延时是可以修改的，例如可以通过命令`shutdown -t0 -r now`设定为0秒，或设定如下参数

```
KILLDELAY=0
```

## 4.5 locale配置

列出`glibc`提供的所有locale

```
# locale -a
```

将上述命令打印的locale名转为正式名，示例

```
# LC_ALL=en_US.utf8 locale charmap
UTF-8
```

> 正式名为`en_US.UTF-8`

测试一下该locale是否可以正常使用

```
# LC_ALL=en_US.UTF-8 locale language
# LC_ALL=en_US.UTF-8 locale charmap
# LC_ALL=en_US.UTF-8 locale int_curr_symbol
# LC_ALL=en_US.UTF-8 locale int_prefix
```

创建`/etc/profile`，设定locale

```
for i in $(locale); do
  unset ${i%=*}
done

if [[ "$TERM" = linux ]]; then
  export LANG=C.UTF-8
else
  export LANG=en_US.UTF-8
fi
```

> `C.UTF-8`是为了防止程序在linux console下输出linux console无法渲染的字符

## 4.6 inputrc

`/etc/inputrc`是用于`readline`库的文件。`readline`是很重要的一个库，`bash`等大部分shell都要依赖这个库以支援用户在输入时的编辑功能。其中的基本配置就是将键盘转义符映射到特定的动作，这些键包括方向键，翻页键以及Ctrl的组合等。例如移动到行开头，末尾，移动一个word等动作

配置示例。更多配置相关信息可以通过命令`info bash`或`info readline`查看

```
# Allow the command prompt to wrap to the next line
set horizontal-scroll-mode Off

# Enable 8-bit input
set meta-flag On
set input-meta On

# Turns off 8th bit stripping
set convert-meta Off

# Keep the 8th bit for display
set output-meta On

# none, visible or audible
set bell-style none

# All of the following map the escape sequence of the value
# contained in the 1st argument to the readline specific functions
"\eOd": backward-word
"\eOc": forward-word

# for linux console
"\e[1~": beginning-of-line
"\e[4~": end-of-line
"\e[5~": beginning-of-history
"\e[6~": end-of-history
"\e[3~": delete-char
"\e[2~": quoted-insert

# for xterm
"\eOH": beginning-of-line
"\eOF": end-of-line

# for Konsole
"\e[H": beginning-of-line
"\e[F": end-of-line
```

## 4.7 shell

`/etc/shells`中记录了系统上的可用于login的shell。用户在使用`chsh`修改login shell时`chsh`就会查询这个文件，判断用户指定的shell是否包含在里面。`gdm`和FTP服务器也会需要这个文件

```
/bin/sh
/bin/bash
```

## 5 LFS：内核编译与UEFI启动引导

## 5.1 fstab

LFS下需要创建的`fstab`需要包含前文所述的各类虚拟文件系统

```
/dev/sda1      /              ext4     defaults            1     1
/dev/sda2      swap           swap     pri=1               0     0
proc           /proc          proc     nosuid,noexec,nodev 0     0
sysfs          /sys           sysfs    nosuid,noexec,nodev 0     0
devpts         /dev/pts       devpts   gid=5,mode=620      0     0
tmpfs          /run           tmpfs    defaults            0     0
devtmpfs       /dev           devtmpfs mode=0755,nosuid    0     0
tmpfs          /dev/shm       tmpfs    nosuid,nodev        0     0
cgroup2        /sys/fs/cgroup cgroup2  nosuid,noexec,nodev 0     0
```

> 如果使用`ext3`且磁盘支持NCQ（通过`hdparm -I /dev/sda | grep NCQ`检测），可以在挂载参数加`barrier=1`在关机前强制flush数据，防止文件系统损坏
>
> `vfat` `ntfs`等来源于MS的文件系统需要加`utf8`挂载参数。`vfat`和`smbfs`还需要`codepage`参数（也可以省略），`en_US.UTF-8`通常设定为`437`。挂载`vfat`U盘还可以加上参数`noauto,user,quiet,showexec`

## 5.2 构建内核

## 5.3 GRUB启动配置

## 6 BLFS和其他杂项

这里开始的主要目的是将LFS打造成可以（大概是勉强）作为桌面系统使用的系统：

+ 使用Wayland，compositor使用`sway`，支持XWayland

+ intel gen7.5 GPU驱动（Haswell），包含3D支持，编解码，Vulkan支持

+ 字体支持，例如JetBrains的等距字体，Droid字体，WenQuanYi中文字体，以及noto字体等

+ Sway环境适用的小组件，例如`waybar` `foot` `fuzzel`等

+ 其他常用组件，例如`dbus` `elogind`等

+ `init`系统，可以选择`openrc`，或者考虑ChimeraLinux的`dinit`和`turnstiled`组合

+ ...

并且探索一些其他的可能性：

+ 使用`busybox`替代`sysvinit`和`coreutils`

+ `initramfs`方案

+ 引入包管理，备选方案有Alpine的`apk`，或Arch的`pacman`

+ 工具链的替换：使用`musl`替代`glibc`，使用`mold`（[Gentoo Wiki](https://wiki.gentoo.org/wiki/Mold)）替代GNU提供的动态链接器`ld`或`gold`，或者像ChimeraLinux一样直接基于`llvm`，相应的链接器使用`lld`。这意味着整个流程需要重新开始

+ ...