# Linux From Scratch

主要涵盖[LFS](https://www.linuxfromscratch.org/lfs/)和[BLFS](https://www.linuxfromscratch.org/blfs/)，BLFS仅挑选部分内容实现

V12.3

平台Alpine Linux v3.21

## 目录

+ [**1**](#1-lfs) LFS
    + [**1.1**](#11-标准解读lsb30需要的包) 标准解读：LSB3.0需要的包
        + [**1.1.1**](#111-lsb-core) LSB Core
        + [**1.1.2**](#112-lsb-desktop) LSB Desktop
        + [**1.1.3**](#113-lsb-languages) LSB Languages
        + [**1.1.4**](#114-lsb-imaging) LSB Imaging
    + [**1.2**](#12-lfs源码准备) LFS源码准备
    + [**1.3**](#13-lfs补丁准备) LFS补丁准备
    + [**1.4**](#14-lfs目录与用户创建) LFS目录与用户创建
+ [**2**](#2-blfs) BLFS

## 1 LFS：准备工作

## 1.1 标准解读：LSB3.0需要的包

LSB（Linux Standard Base）Version 3.0

LSB只是一个推荐的标准，仅供参考，实际上不一定要完全按照LSB的来，有些包可以省略或自己选替代，也可以另外加想要的包和功能

### 1.1.1 LSB Core

LFS提供

```
bash bc binutils coreutils diffutils file findutils gawk gcc gettext glibc grep gzip m4 man-db procps psmisc sed shadow sysvinit tar util-linux zlib
```

BLFS提供

```
at batch blfs-bash-startup-files cpio ed fcrontab lsb-tools nspr nss linux-pam pax sendmail/postfix/exim time
```

其他

```
install_initd libxcrypt(libcrypt.so.1) ncurses(libncurses.so.5 libncursesw.so.6) 
```

> LSB 3.0要求提供`libncursesw.so.5`

### 1.1.2 LSB Desktop

BLFS提供

```
alsa atk cairo desktop-file-utils freetype fontconfig gdk-pixbuf glib2 glu icon-naming-utils libjpeg-turbo libxml2 mesa pango xdg-utils xorg
```

其他

```
gtk+3(libgdk-3.so libgtk-3.so) gtk4(libgtk-4.so) libpng(libpng16.so) qt6(libQt6*.so.6) libtiff(libtiff.so.6) libpng(libpng16.so)
```

> LSB 3.0要求提供`libgdk-x11-2.0.so libgtk-x11-2.0.so libpng12.so libQt*.so.4 libtiff.so.4 libpng15.so`

### 1.1.3 LSB Languages

LFS提供

```
perl
```

BLFS提供

```
libxml2 libxslt
```

其他

```
python(python3)
```

> LSB 3.0要求提供`python2`

### 1.1.4 LSB Imaging

BLFS提供

```
cups cups-filters ghostscript sane
```

## 1.2 LFS源码准备

共87个包

尽量使用`tarball`而不是克隆仓库

记得下载完成以后把所有包和补丁放到`$LFS/sources`再解压

| 包名 | 版本 | 项目主页 | release tarball下载地址 | 仓库地址 |
| :- | :- | :- | :- | :- |
| `acl` | `2.3.2` | [nongnu.org](https://savannah.nongnu.org/projects/acl) | [下载](http://download.savannah.nongnu.org/releases/acl/acl-2.3.2.tar.gz) | [nongnu.org](https://git.savannah.nongnu.org/git/acl.git) |
| `attr` | `2.5.2` | [nongnu.org](https://savannah.nongnu.org/projects/attr) | [下载](http://download.savannah.nongnu.org/releases/attr/attr-2.5.2.tar.gz) | [nongnu.org](https://git.savannah.nongnu.org/git/attr.git) |
| `autoconf` | `2.72` | [gnu.org](https://www.gnu.org/software/autoconf/) | [下载](https://ftp.gnu.org/gnu/autoconf/autoconf-2.72.tar.xz) | [gnu.org](https://git.sv.gnu.org/r/autoconf.git) |
| `automake` | `1.17` | [gnu.org](https://www.gnu.org/software/automake/) | [下载](https://ftp.gnu.org/gnu/automake/automake-1.17.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/automake.git) |
| `bash` | `5.2.37` | [gnu.org](https://www.gnu.org/software/bash/) | [下载](https://ftp.gnu.org/gnu/bash/bash-5.2.37.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/bash.git) |
| `bc` | `7.0.3` | [github.com](https://github.com/gavinhoward/bc) | [下载](https://github.com/gavinhoward/bc/releases/download/7.0.3/bc-7.0.3.tar.xz) | [github.com](https://github.com/gavinhoward/bc.git) |
| `binutils` | `2.44` | [gnu.org](https://www.gnu.org/software/binutils/) | [下载](https://sourceware.org/pub/binutils/releases/binutils-2.44.tar.xz) | [sourceware.org](https://sourceware.org/git/binutils-gdb.git) |
| `bison` | `3.8.2` | [gnu.org](https://www.gnu.org/software/bison/) | [下载](https://ftp.gnu.org/gnu/bison/bison-3.8.2.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/bison.git) |
| `bzip2` | `1.0.8` | [sourceware.org](https://sourceware.org/bzip2/) | [下载](http://www.sourceware.org/pub/bzip2/bzip2-1.0.8.tar.gz) | [sourceware.org](https://sourceware.org/git/bzip2.git) |
| `check` | `0.15.2` | [github.io](https://libcheck.github.io/check/) | [下载](https://github.com/libcheck/check/releases/download/0.15.2/check-0.15.2.tar.gz) | [github.com](https://github.com/libcheck/check.git) |
| `coreutils` | `9.6` | [gnu.org](https://www.gnu.org/software/coreutils/) | [下载](https://ftp.gnu.org/gnu/coreutils/coreutils-9.6.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/coreutils.git) |
| `dejagnu` | `1.6.3` | [gnu.org](https://www.gnu.org/software/dejagnu/) | [下载](https://ftp.gnu.org/gnu/dejagnu/dejagnu-1.6.3.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/dejagnu.git) |
| `diffutils` | `3.11` | [gnu.org](https://www.gnu.org/software/diffutils/) | [下载](https://ftp.gnu.org/gnu/diffutils/diffutils-3.11.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/diffutils.git) |
| `e2fsprogs` | `1.47.2` | [sourceforge.net](https://e2fsprogs.sourceforge.net/) | [下载](https://mirrors.edge.kernel.org/pub/linux/kernel/people/tytso/e2fsprogs/v1.47.2/e2fsprogs-1.47.2.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/fs/ext2/e2fsprogs.git) |
| `elfutils` | `0.192` | [sourceware.org](https://sourceware.org/elfutils/) | [下载](https://sourceware.org/elfutils/ftp/0.192/elfutils-0.192.tar.bz2) | [sourceware.org](https://sourceware.org/git/elfutils.git) |
| `expat` | `2.6.4` | [github.io](https://libexpat.github.io/) | [下载](https://github.com/libexpat/libexpat/releases/download/R_2_6_4/expat-2.6.4.tar.xz) | [github.com](https://github.com/libexpat/libexpat.git) |
| `expect` | `5.45.4` | [tcl-lang.org](https://core.tcl-lang.org/expect/index) | [下载](https://prdownloads.sourceforge.net/expect/expect5.45.4.tar.gz) | [tcl-lang.org (fossil)](https://core.tcl-lang.org/expect) |
| `file` | `5.46` | [darwinsys.com](https://www.darwinsys.com/file/) | [下载](http://astron.com/pub/file/file-5.46.tar.gz) | [github.com](https://github.com/file/file.git) |
| `findutils` | `4.10.0` | [gnu.org](https://www.gnu.org/software/findutils/) | [下载](https://ftp.gnu.org/gnu/findutils/findutils-4.10.0.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/findutils.git) |
| `flex` | `2.6.4` | [github.com](https://github.com/westes/flex) | [下载](https://github.com/westes/flex/releases/download/v2.6.4/flex-2.6.4.tar.gz) | [github.com](https://github.com/westes/flex.git) |
| `flit-core` | `3.11.0` | [pypi.org](https://pypi.org/project/flit-core/) | [下载](https://files.pythonhosted.org/packages/source/f/flit-core/flit_core-3.11.0.tar.gz) | [github.com](https://github.com/pypa/flit.git) |
| `gawk` | `5.3.1` | [gnu.org](https://www.gnu.org/software/gawk/) | [下载](https://ftp.gnu.org/gnu/gawk/gawk-5.3.1.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/gawk.git) |
| `gcc` | `14.2.0` | [gnu.org](https://gcc.gnu.org/) | [下载](https://ftp.gnu.org/gnu/gcc/gcc-14.2.0/gcc-14.2.0.tar.xz) | [gnu.org](https://gcc.gnu.org/git/gcc.git) |
| `gdbm` | `1.24` | [gnu.org](https://www.gnu.org/software/gdbm/) | [下载](https://ftp.gnu.org/gnu/gdbm/gdbm-1.24.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/gdbm.git) |
| `gettext` | `0.24` | [gnu.org](https://www.gnu.org/software/gettext/) | [下载](https://ftp.gnu.org/pub/gnu/gettext/gettext-0.24.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/gettext.git) |
| `glibc` | `2.41` | [gnu.org](https://www.gnu.org/software/libc/) | [下载](https://ftp.gnu.org/pub/gnu/glibc/glibc-2.41.tar.xz) | [sourceware.org](https://sourceware.org/git/glibc.git) |
| `gmp` | `6.3.0` | [gmplib.org](https://gmplib.org/) | [下载](https://gmplib.org/download/gmp/gmp-6.3.0.tar.xz) | [gmplib.org (mercurial)](https://gmplib.org/repo/gmp/) |
| `gperf` | `3.1` | [gnu.org](https://www.gnu.org/software/gperf/) | [下载](https://ftp.gnu.org/pub/gnu/gperf/gperf-3.2.1.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/gperf.git) |
| `grep` | `3.11` | [gnu.org](https://www.gnu.org/software/grep/) | [下载](https://ftp.gnu.org/pub/gnu/grep/grep-3.11.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/grep.git) |
| `groff` | `1.23.0` | [gnu.org](https://www.gnu.org/software/groff/) | [下载](https://ftp.gnu.org/pub/gnu/groff/groff-1.23.0.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/groff.git) |
| `grub` | `2.12` | [gnu.org](https://www.gnu.org/software/grub/) | [下载](https://ftp.gnu.org/pub/gnu/grub/grub-2.12.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/grub.git) |
| `gzip` | `1.13` | [gnu.org](https://www.gnu.org/software/gzip/) | [下载](https://ftp.gnu.org/gnu/gzip/gzip-1.13.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/gzip.git) |
| `iana-etc` | `20250123` | [github.com](https://github.com/Mic92/iana-etc) | [下载](https://github.com/Mic92/iana-etc/releases/download/20250123/iana-etc-20250123.tar.gz) | [github.com](https://github.com/Mic92/iana-etc.git) |
| `inetutils` | `2.6` | [gnu.org](https://www.gnu.org/software/inetutils/) | [下载](https://ftp.gnu.org/gnu/inetutils/inetutils-2.6.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/inetutils.git) |
| `intltool` | `0.51.0` | [freedesktop.org](https://freedesktop.org/wiki/Software/intltool/) | [下载](https://launchpad.net/intltool/trunk/0.51.0/+download/intltool-0.51.0.tar.gz) | [launchpad.net (bazaar)](https://bazaar.launchpad.net/~intltool/intltool/trunk/files) |
| `iproute2` | `6.13.0` | [kernel.org](https://mirrors.edge.kernel.org/pub/linux/utils/net/iproute2/) | [下载](https://mirrors.edge.kernel.org/pub/linux/utils/net/iproute2/iproute2-6.13.0.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/network/iproute2/iproute2.git) |
| `jinja2` | `3.1.5` | [palletsprojects.com](https://jinja.palletsprojects.com/en/stable/) [github.com](https://github.com/pallets/jinja/) | [下载](https://pypi.org/packages/source/J/Jinja2/jinja2-3.1.5.tar.gz) | [github.com](https://github.com/pallets/jinja.git) |
| `kbd` | `2.7.1` | [kbd-project.org](https://kbd-project.org/) | [下载](https://www.kernel.org/pub/linux/utils/kbd/kbd-2.7.1.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/linux/kernel/git/legion/kbd.git) |
| `kmod` | `34` | [github.com](https://github.com/kmod-project/kmod) | [下载](https://www.kernel.org/pub/linux/utils/kernel/kmod/kmod-34.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/utils/kernel/kmod/kmod.git) |
| `less` | `668` | [greenwoodsoftware.com](http://greenwoodsoftware.com/less) | [下载](https://www.greenwoodsoftware.com/less/less-668.tar.gz) | [github.com](https://github.com/gwsw/less.git) |
| `lfs-bootscripts` | `20240825` |  | [下载](https://www.linuxfromscratch.org/lfs/downloads/12.3/lfs-bootscripts-20240825.tar.xz) |  |
| `libcap` | `2.73` | [google.com/site/fullycapable](https://sites.google.com/site/fullycapable/) | [下载](https://www.kernel.org/pub/linux/libs/security/linux-privs/libcap2/libcap-2.73.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/libs/libcap/libcap.git) |
| `libffi` | `3.4.7` | [sourceware.org](https://sourceware.org/libffi/) | [下载](https://github.com/libffi/libffi/releases/download/v3.4.7/libffi-3.4.7.tar.gz) | [github.com](https://github.com/libffi/libffi.git) |
| `libpipeline` | `1.5.8` | [nongnu.org](https://libpipeline.nongnu.org/) | [下载]( https://download.savannah.gnu.org/releases/libpipeline/libpipeline-1.5.8.tar.gz) | [nongnu.org](https://git.savannah.nongnu.org/git/libpipeline.git) |
| `libtool` | `2.5.4` | [gnu.org](https://www.gnu.org/software/libtool/) | [下载](https://ftp.gnu.org/gnu/libtool/libtool-2.5.4.tar.xz) | [gnu.org](https://git.savannah.gnu.org/libtool.git) |
| `libxcrypt` | `4.4.38` | [github.com](https://github.com/besser82/libxcrypt/) | [下载]( https://github.com/besser82/libxcrypt/releases/download/v4.4.38/libxcrypt-4.4.38.tar.xz) | [github.com](https://github.com/besser82/libxcrypt.git) |
| `linux` | `6.13.4` | [kernel.org](https://www.kernel.org/) | [下载](https://www.kernel.org/pub/linux/kernel/v6.x/linux-6.13.4.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git) |
| `lz4` | `1.10.0` | [lz4.org](https://lz4.org/) | [下载]( https://github.com/lz4/lz4/releases/download/v1.10.0/lz4-1.10.0.tar.gz) | [github.com](https://github.com/lz4/lz4.git) |
| `m4` | `1.4.19` | [gnu.org](https://www.gnu.org/software/m4/) | [下载](https://ftp.gnu.org/gnu/m4/m4-1.4.19.tar.xz) | [gnu.org](https://git.savannah.gnu.org/r/m4.git) |
| `make` | `4.4.1` | [gnu.org](https://www.gnu.org/software/make/) | [下载](https://ftp.gnu.org/gnu/make/make-4.4.1.tar.gz) | [gnu.org](https://git.savannah.gnu.org/r/make.git) |
| `man-db` | `2.13.0` | [nongnu.org](https://www.nongnu.org/man-db/) | [下载](https://download.savannah.gnu.org/releases/man-db/man-db-2.13.0.tar.xz) | [gitlab.com](https://gitlab.com/man-db/man-db.git) |
| `man-pages` | `6.12` | [kernel.org](https://www.kernel.org/doc/man-pages/) | [下载](https://www.kernel.org/pub/linux/docs/man-pages/man-pages-6.12.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/docs/man-pages/man-pages.git) |
| `markupsafe` | `3.0.2` | [palletsprojects.com](https://palletsprojects.com/p/markupsafe/) | [下载](https://pypi.org/packages/source/M/MarkupSafe/markupsafe-3.0.2.tar.gz) | [github.com](https://github.com/pallets/markupsafe.git) |
| `meson` | `1.7.0` | [mesonbuild.com](https://mesonbuild.com) | [下载](https://github.com/mesonbuild/meson/releases/download/1.7.0/meson-1.7.0.tar.gz) | [github.com](https://github.com/mesonbuild/meson.git) |
| `mpc` | `1.3.1` | [multiprecision.org](https://www.multiprecision.org/) | [下载](https://ftp.gnu.org/gnu/mpc/mpc-1.3.1.tar.gz) | [gitlab.inria.fr](https://gitlab.inria.fr/mpc/mpc.git) |
| `mpfr` | `4.2.1` | [mpfr.org](https://www.mpfr.org/) | [下载](https://ftp.gnu.org/gnu/mpfr/mpfr-4.2.1.tar.xz) | [gitlab.inria.fr](https://gitlab.inria.fr/mpfr/mpfr.git) |
| `ncurses` | `6.5` | [invisible-island.net](https://invisible-island.net/ncurses/) | [下载](https://invisible-mirror.net/archives/ncurses/ncurses-6.5.tar.gz) | [invisible-island.net (patch only)](https://invisible-island.net/archives/ncurses/6.4/) |
| `ninja` | `1.12.1` | [ninja-build.org](https://ninja-build.org/) | [下载](https://github.com/ninja-build/ninja/archive/v1.12.1/ninja-1.12.1.tar.gz) | [github.com](https://github.com/ninja-build/ninja.git) |
| `openssl` | `3.4.1` | [openssl-library.org](https://www.openssl-library.org/) | [下载](https://github.com/openssl/openssl/releases/download/openssl-3.4.1/openssl-3.4.1.tar.gz) | [github.com](https://github.com/openssl/openssl.git) |
| `patch` | `2.7.6` | [gnu.org](https://savannah.gnu.org/projects/patch/) | [下载](https://ftp.gnu.org/gnu/patch/patch-2.7.6.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/patch.git) |
| `perl` | `5.40.1` | [perl.org](https://www.perl.org/) | [下载](https://www.cpan.org/src/5.0/perl-5.40.1.tar.xz) | [github.com](https://github.com/Perl/perl5.git) |
| `pkgconf` | `2.3.0` | [github.com](https://github.com/pkgconf/pkgconf) | [下载]( https://distfiles.ariadne.space/pkgconf/pkgconf-2.3.0.tar.xz) | [github.com](https://github.com/pkgconf/pkgconf.git) |
| `procps` | `4.0.5` | [gitlab.com](https://gitlab.com/procps-ng/procps/) | [下载]( https://sourceforge.net/projects/procps-ng/files/Production/procps-ng-4.0.5.tar.xz) | [gitlab.com](https://gitlab.com/procps-ng/procps.git) |
| `psmisc` | `23.7` | [gitlab.com](https://gitlab.com/psmisc/psmisc) | [下载](https://sourceforge.net/projects/psmisc/files/psmisc/psmisc-23.7.tar.xz) | [gitlab.com](https://gitlab.com/psmisc/psmisc.git) |
| `python` | `3.13.2` | [python.org](https://www.python.org/) | [下载](https://www.python.org/ftp/python/3.13.2/Python-3.13.2.tar.xz) | [github.com](https://github.com/python/cpython.git) |
| `python-docs` | `3.13.2` | [python.org](https://www.python.org/) | [下载](https://www.python.org/ftp/python/doc/3.13.2/python-3.13.2-docs-html.tar.bz2) | [github.com](https://github.com/python/cpython.git) |
| `readline` | `8.2.13` | [tiswww.case.edu](https://tiswww.case.edu/php/chet/readline/rltop.html) | [下载](https://ftp.gnu.org/gnu/readline/readline-8.2.13.tar.gz) | [gnu.org](http://git.savannah.gnu.org/cgit/readline.git) |
| `sed` | `4.9` | [gnu.org](https://www.gnu.org/software/sed/) | [下载](https://ftp.gnu.org/gnu/sed/sed-4.9.tar.xz) | [gnu.org](https://git.sv.gnu.org/sed) |
| `setuptools` | `75.8.1` | [pypi.org](https://pypi.org/project/setuptools/) | [下载](https://pypi.org/packages/source/s/setuptools/setuptools-75.8.1.tar.gz) | [github.com](https://github.com/pypa/setuptools.git) |
| `shadow` | `4.17.3` | [github.com](https://github.com/shadow-maint/shadow/) | [下载](https://github.com/shadow-maint/shadow/releases/download/4.17.3/shadow-4.17.3.tar.xz) | [github.com](https://github.com/shadow-maint/shadow.git) |
| `sysklogd` | `2.7.0` | [infodrom.org](https://www.infodrom.org/projects/sysklogd/) | [下载](https://github.com/troglobit/sysklogd/releases/download/v2.7.0/sysklogd-2.7.0.tar.gz) | [infodrom.org](git://git.infodrom.org/infodrom/sysklogd) [github.com](https://github.com/troglobit/sysklogd.git) |
| `systemd` | `257.3` | [freedesktop.org](https://www.freedesktop.org/wiki/Software/systemd/) | [下载](https://github.com/systemd/systemd/archive/v257.3/systemd-257.3.tar.gz) | [github.com](https://github.com/systemd/systemd.git) |
| `systemd-man-pages` | `257.3` | [freedesktop.org](https://www.freedesktop.org/wiki/Software/systemd/) | [下载](https://anduin.linuxfromscratch.org/LFS/systemd-man-pages-257.3.tar.xz) | [github.com](https://github.com/systemd/systemd.git) |
| `sysvinit` | `3.14` | [nongnu.org](https://savannah.nongnu.org/projects/sysvinit) | [下载](https://github.com/slicer69/sysvinit/releases/download/3.14/sysvinit-3.14.tar.xz) | [github.com](https://github.com/slicer69/sysvinit.git) |
| `tar` | `1.35` | [gnu.org](https://www.gnu.org/software/tar/) | [下载](https://ftp.gnu.org/gnu/tar/tar-1.35.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/tar.git) |
| `tcl` | `8.6.16` | [sourceforge.net](https://tcl.sourceforge.net/) | [下载](https://downloads.sourceforge.net/tcl/tcl8.6.16-src.tar.gz) | [tcl-lang.org (fossil)](https://core.tcl-lang.org/tcl) |
| `tcl-docs` | `8.6.16` | [sourceforge.net](https://tcl.sourceforge.net/) | [下载](https://downloads.sourceforge.net/tcl/tcl8.6.16-html.tar.gz) | [tcl-lang.org (fossil)](https://core.tcl-lang.org/tcl) |
| `texinfo` | `7.2` | [gnu.org](https://www.gnu.org/software/texinfo/) | [下载](https://ftp.gnu.org/gnu/texinfo/texinfo-7.2.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/texinfo.git) |
| `timezonedata` | `2025a` | [iana.org](https://www.iana.org/time-zones) | [下载](https://www.iana.org/time-zones/repository/releases/tzdata2025a.tar.gz) | [iana.org (tarballs only)](https://data.iana.org/time-zones/releases/) |
| `udev-lfs` | `udev-lfs-20230818` |  | [下载](https://anduin.linuxfromscratch.org/LFS/udev-lfs-20230818.tar.xz) |  |
| `util-linux` | `2.40.4` | [kernel.org](https://git.kernel.org/pub/scm/utils/util-linux/util-linux.git/about/) | [下载](https://www.kernel.org/pub/linux/utils/util-linux/v2.40/util-linux-2.40.4.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/utils/util-linux/util-linux.git) |
| `vim` | `9.1.1166` | [vim.org](https://www.vim.org) | [下载](https://github.com/vim/vim/archive/v9.1.1166/vim-9.1.1166.tar.gz) | [github.com](https://github.com/vim/vim.git) |
| `wheel` | `0.45.1` | [pypi.org](https://pypi.org/project/wheel/) | [下载](https://pypi.org/packages/source/w/wheel/wheel-0.45.1.tar.gz) | [github.com](https://github.com/pypa/wheel.git) |
| `xml-parser` | `2.47` | [github.com](https://github.com/chorny/XML-Parser) | [下载](https://cpan.metacpan.org/authors/id/T/TO/TODDR/XML-Parser-2.47.tar.gz) | [github.com](https://github.com/chorny/XML-Parser.git) |
| `xz` | `5.6.4` | [tukaani.org](https://tukaani.org/xz) | [下载](https://github.com//tukaani-project/xz/releases/download/v5.6.4/xz-5.6.4.tar.xz) | [github.com](https://github.com/tukaani-project/xz.git) |
| `zlib` | `1.3.1` | [zlib.net](https://zlib.net/) | [下载](https://zlib.net/fossils/zlib-1.3.1.tar.gz) | [github.com](https://github.com/madler/zlib.git) |
| `zstd` | `1.5.7` | [github.com](https://facebook.github.io/zstd/) | [下载](https://github.com/facebook/zstd/releases/download/v1.5.7/zstd-1.5.7.tar.gz) | [github.com](https://github.com/facebook/zstd.git) |

## 1.3 LFS补丁准备

| 补丁 | tarball下载 |
| :- | :- |
| bzip2 documentation | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/bzip2-1.0.8-install_docs-1.patch) |
| coreutils internationalization fixes (i18n) | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/coreutils-9.6-i18n-1.patch) |
| expect gcc14 | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/expect-5.45.4-gcc14-1.patch) |
| glibc fhs | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/glibc-2.41-fhs-1.patch) |
| kbd backspace/delete fix | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/kbd-2.7.1-backspace-1.patch) |
| sysvinit consolidated | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/sysvinit-3.14-consolidated-1.patch) |

## 1.4 LFS目录创建

使用普通用户身份创建一个新目录，用于LFS的根目录。确保权限为`755`（可以设定`umask 022`）

后续该目录以及所有子目录要`chown root:root`，保证UID和GID都为`0`。这里先保持为普通用户

```
$ umask 022
$ mkdir -p lfs/etc lfs/var
$ mkdir -p lfs/usr/bin lfs/usr/sbin lfs/usr/lib
$ ln -s usr/bin lfs/bin
$ ln -s usr/sbin lfs/sbin
$ ln -s usr/lib lfs/lib
$ mkdir lfs/tools
$ mkdir lfs/sources
$ mkdir lfs/lib64
$ ls lfs/
bin     etc     lib     lib64   sbin    sources     tools   usr     var
```

> `tools`用于存放交叉工具链1。注意刚刚下载的源码和补丁必须放到`sources`再解压缩，不要解压缩后中途复制，否则时间戳会对构建过程造成影响

## 1.5 环境

使用普通用户身份新开一个`bash`，隔离可能会有影响的环境变量，设定一些常用变量，仅继承少量无关紧要的变量。可以写成shell脚本

```
$ export LFS=/absolute/path/to/lfs
$ exec env -i HOME="$HOME" \
> TERM="$TERM" \
> PS1="$PS1" \
> PATH=/bin:/usr/bin:$LFS/tools/bin \
> LFS=$LFS \
> LC_ALL=POSIX \
> LFS_TGT=x86_64-lfs-linux-gnu \
> CONFIG_SITE=$LFS/usr/share/config.site /bin/bash
```

> 设置`CONFIG_SITE`是防止`configure`脚本读主机的`config.site`

进入新shell后检查一下

```
$ env
```

在新`bash`实例下执行以下命令

```
$ set +h
$ umask 022
```

> `set +h`关闭`bash`的哈希功能，强制`bash`每次都去`$PATH`找可执行文件而不是使用缓存的路径

也可以提前设定一下`make`线程数，按CPU线程数来

```
$ export MAKEFLAGS=-j$(nproc)
```

## 2 LFS：构建交叉工具链与基础组件

## 2.1 基本概念

### 2.1.1 triplet名

工具链名称是一个triplet，已经给出`LFS_TGT=x86_64-lfs-linux-gnu`（target）。这是`autoconf`要求的格式，格式为`cpu-vendor-kernel-os`，其中`vendor`可以省略（默认不写为`unknown`）。可以通过`binutils`包中的`config.guess`脚本获取这个名称

> 当前系统使用的工具链triplet名可以通过`gcc -dumpmachine`获得

### 2.1.2 动态链接器

`glibc`提供了一个动态链接器`ld-linux-x86-64.so.2`。其他的替代品有`mold`等（[github](https://github.com/rui314/mold)）

> 当前系统使用的动态链接器可以使用`readelf -l /any/elf/file | grep interpreter`获取

### 2.1.3 Canadian Cross

工具链是制造软件的软件，正如机床是工业母机。工具链当然可以用来编译工具链

工具链有3个属性：**build**，**host**，**target**

**build**指这个工具链本身在什么平台被生产编译出来

**host**指这个工具链本身在什么平台运行

**target**指这个工具链生产出来的代码在什么平台运行

也就是说当前机器运行的工具链不一定是在本机生产的，它编译出的代码也不一定是在本机运行的

之所以叫Canadian Cross原因如下

> The term Canadian Cross was coined because at the time that these issues were all being hashed out, Canada had three national political parties - [by crosstool-ng](https://crosstool-ng.github.io/docs/toolchain-types/)

假设我们想要在平台A构建在平台B上运行的工具链，而这个工具链编译出的程序在平台C上执行，至少需要编译3次

| Pass | build | host | target |
| :- | :- | :- | :- |
| 交叉工具链1 | A | A | B |
| 交叉工具链2 | A | B | C |
| 工具链3 | B | C | C |

后续就可以实现C平台完全自举（同时可以测试检查用）

| Pass | build | host | target |
| :- | :- | :- | :- |
| 工具链4 | C | C | C |

> 第1次在平台A构建出在A上执行的生成平台B程序的工具链
>
> 第2次将第1次构建出的工具链放到平台B上执行，用这个工具链构建出生成平台C程序的工具链
>
> 第3次将第2次构建出的工具链放到平台C上执行，这样C平台就有了可以在本机执行的、生成本机代码的工具链，实现自举
>
> 只有第1次和第2次的工具链算交叉工具链，因为它们的host和target不同

上述场景的前提是A性能较低，且B没有可用的工具链。而LFS中实际上我们只需要Cross一次（B有可用的工具链且性能足够，无需再有A->B），所以至少编译2次即可

| Pass | build | host | target |
| :- | :- | :- | :- |
| 交叉工具链1 | B | B | C |
| 工具链2 | B | C | C |

保证C平台完全自举

| Pass | build | host | target |
| :- | :- | :- | :- |
| 工具链3 | C | C | C |

我们要生产工具链，所以当前主机必须要有至少一个可以直接运行的工具链，才有可能造出新的工具链

AlpineLinux安装

```
$ apk add gcc musl-dev make bison flex texinfo automake
```

> 实际上最后还是要在C平台重新编译出整个工具链3，因为工具链2是在B平台交叉编译出来的，可能会缺少一些可选的依赖，并且在B平台由于是交叉编译环境`autoconf`可能无法侦测到一些feature。还有一个原因是可能需要本地运行testsuite检验功能是否完整。这不仅对于工具链本身成立，对于其他软件也是成立的
>
> 交叉工具链1会被放到`$LFS/tools`

### 2.1.4 libgcc

GNU工具链本身需要依赖`libgcc`才能运行，而`libgcc`又链接了`glibc`和`libstdc++`

在本文的环境里，构建B平台运行的交叉工具链1时，编译`libgcc`时会避免使用到`libc`以及`libstdc++`的功能，从而避免链接，这个交叉工具链1是一个degraded的工具链，缺少一些功能和特性。而在C平台运行的工具链2会依赖交叉工具链1编译出来的`glibc`和`libstdc++`运行，具备相对更完整的功能

## 2.2 交叉工具链1

这里开始编译交叉工具链1

### 2.2.1 构建顺序

构建与安装顺序按照`binutils` `gcc` `linux-headers` `glibc` `libstdc++`

> 这里的`binutils` `gcc`依赖AlpineLinux的环境运行，使用Alpine的`musl`和`libstdc++`。而后面的`linux-headers` `glibc` `libstdc++`由这个`gcc`编译，是给这个交叉工具链的`target`使用的

**binutils和gcc**

把`binutils`放在最开始编译是因为无论`gcc`还是`glibc`的`configure`脚本都需要检查平台已有的汇编器和链接器的特性，来判断开启/关闭哪些特性与功能

`binutils`会安装到`$LFS/tools/bin`和`$LFS/tools/$LFS_TGT/bin`，两个目录里的文件是硬链接的关系

后续运行`gcc`的`configure`脚本时会看到它使用了`$LFS/tools/$LFS_TGT/bin`下的`as`和`ld`。而在后续实际执行时并不一定使用这两个`as`和`ld`，实际使用的汇编器和链接器可以在`gcc`被编译出来以后使用`$LFS_TGT-gcc -print-prog-name=ld`获取。而在已经启动的本地系统上可以使用`gcc -print-prog-name=ld`

`ld`链接器扫描库文件目录也是有顺序的。在编译完成`binutils`后可以通过`$LFS_TGT-ld --verbose | grep SEARCH`获取搜寻顺序，而在已经启动的本地系统上可以使用`ld --verbose | grep SEARCH`

> 使用`gcc -v somecode.c`试编译代码也可以看到上述这类信息

**linux-headers**

把`linux-headers`安装放在`glibc`之前是因为`glibc`需要调用`linux`提供的接口

**glibc**

编译`glibc`前，`configure`脚本通过`--host`参数判定使用`$LFS_TGT-gcc`和`$LFS_TGT-ld`等工具。建议`configure`完先检查一下`build`目录下的`config.make`是否有异样

**libstdc++**

`libstdc++`依赖`glibc`所以把`glibc`放在前

### 2.2.2 binutils

编译前最后再检查一下AlpineLinux下是否有`/usr/bin/awk`和`/usr/bin/yacc`，`sh`软链接到`bash`，且当前默认使用的shell为`bash`

进入到`$LFS/sources`下解压后的`binutils-2.44`目录，创建一个`build`目录

```
$ mkdir build
$ cd build
```

执行`../configure`，参数含义见下

```
$ ../configure --prefix=$LFS/tools  \ # make install安装的路径前缀
> --with-sysroot=$LFS               \ # 该交叉工具链1需要搜寻的库所在路径
> --target=$LFS_TGT                 \ # 告诉binutil的构建系统构建一个交叉链接器，强制覆盖config.guess的返回结果
> --disable-nls                     \ # 关i18n国际化支持，交叉工具链不需要
> --enable-gprofng=no               \ # 不构建gprofng，交叉工具链不需要
> --disable-werror                  \ # 编译出现warning时不停止
> --enable-new-dtags                \ # 让ld在编译出来的可执行文件/动态库中使用runpath而非rpath记录搜寻目录，方便调试
> --enable-default-hash-style=gnu     # hash table被动态链接器用于搜寻符号，由于后续使用glibc所以只保留gnu style的hash table，速度更快，丢弃classic style的hash table
```

构建与安装

```
$ make -j16
$ make install
```

> 第一次构建可能很容易发现系统AlpineLinux环境缺少的组件例如`flex` `texinfo`等从而导致构建失败。这时候先安装好这些组件，`make clean`后重新`make`即可，直到构建通过
>
> `make install`以后应当在`../../../tools`下看到新安装的内容

### 2.2.3 gcc

> 注意这里解压tar包必须按顺序来，先解压`gcc`再依次解压`mpfr` `gmp` `mpc`，否则会因为时间戳前后顺序不一致导致构建失败

需要使用到`mpfr mpc gmp`，把它们都放到`gcc-14.2.0`下并解压重命名，这些包主要是计算功能

```
$ mv mpfr-4.2.1 mpfr
$ mv gmp-6.3.0 gmp
$ mv mpc-1.3.1 mpc
```

修改`gcc-14.2.0`下`gcc/config/i386/t-linux64`，将`lib64`改为`lib`（因为是`x86_64`平台）

```
...
MULTILIB_OSDIRNAMES = m64=../lib$(call if_multiarch,:x86_64-linux-gnu)
...
```

创建`build`再`configure`

```
$ mkdir build
$ cd build
$ ../configure              \
> --target=$LFS_TGT         \
> --prefix=$LFS/tools       \
> --with-glibc-version=2.41 \ # 该交叉工具链搭配使用的glibc版本
> --with-sysroot=$LFS       \
> --with-newlib             \ # 保证编译libgcc时inhibit_libc常量被定义，避免这个交叉工具链的libgcc依赖任何libc
> --without-headers         \ # 无需强制要求目标平台的标准头文件
> --enable-default-pie      \ # 安全特性，尽量接近后面的最终版工具链
> --enable-default-ssp      \ # 安全特性
> --disable-nls             \
> --disable-shared          \ # 指示静态链接gcc的库而非动态，如果动态是需要glibc的，此时还没有
> --disable-multilib        \ # x86_64禁用multilib
> --disable-threads         \ # 关threads库防止构建失败。交叉工具链1无需该特性
> --disable-libatomic       \ # 关libatomic
> --disable-libgomp         \ # 关libgomp
> --disable-libquadmath     \ # 关libquadmath
> --disable-libssp          \ # 关libssp
> --disable-libvtv          \ # 关libvtv
> --disable-libstdcxx       \ # 关libstdc++
> --enable-languages=c,c++
```

构建

```
$ make -j16
$ make install
```

上述安装会安装一些系统头文件。`limits.h`会`include`系统的`$LFS/usr/include/limits.h`，但是此时该文件还不存在。这对于构建`glibc`暂时不影响，但是后续会用到。使用以下命令创建该头文件的完整版

```
cd ..
cat gcc/limitx.h gcc/glimits.h gcc/limity.h > \
  `dirname $($LFS_TGT-gcc -print-libgcc-file-name)`/include/limits.h
```

## 3 LFS：构建系统剩余部分

## 4 LFS：系统配置

## 5 LFS：UEFI启动引导

## 6 BLFS