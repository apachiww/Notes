# Linux From Scratch

主要涵盖[LFS](https://www.linuxfromscratch.org/lfs/)和[BLFS](https://www.linuxfromscratch.org/blfs/)，BLFS仅挑选部分内容实现

V12.3

构建平台 x86_64 Intel CoffeeLake ASRock Z390M-PRO4 AlpineLinux v3.21

目标平台 x86_64 Intel Haswell-R ASRock H81M-HDS

## 目录

+ [**1**](#1-lfs准备工作) LFS：准备工作
    + [**1.1**](#11-标准解读lsb30需要的包) 标准解读：LSB3.0需要的包
        + [**1.1.1**](#111-lsb-core) LSB Core
        + [**1.1.2**](#112-lsb-desktop) LSB Desktop
        + [**1.1.3**](#113-lsb-languages) LSB Languages
        + [**1.1.4**](#114-lsb-imaging) LSB Imaging
    + [**1.2**](#12-lfs源码准备) LFS源码准备
    + [**1.3**](#13-lfs补丁准备) LFS补丁准备
    + [**1.4**](#14-lfs目录创建) LFS目录创建
    + [**1.5**](#15-环境) 环境
+ [**2**](#2-lfs构建交叉工具链与基础组件) LFS：构建交叉工具链与基础组件
    + [**2.1**](#21-基本概念) 基本概念
        + [**2.1.1**](#211-triplet名) triplet名
        + [**2.1.2**](#212-动态链接器) 动态链接器
        + [**2.1.3**](#213-canadian-cross) Canadian Cross
        + [**2.1.4**](#214-libgcc) libgcc
    + [**2.2**](#22-构建交叉工具链1) 构建交叉工具链1
        + [**2.2.1**](#221-构建顺序) 构建顺序
        + [**2.2.2**](#222-binutils) binutils
        + [**2.2.3**](#223-gcc) gcc
        + [**2.2.4**](#224-linux-headers) linux-headers
        + [**2.2.5**](#225-glibc) glibc
        + [**2.2.4**](#224-libstdc) libstdc++
    + [**2.3**](#23-交叉构建基础组件) 交叉构建基础组件
        + [**2.3.1**](#231-m4) m4
        + [**2.3.2**](#232-ncurses) ncurses
        + [**2.3.3**](#233-bash) bash
        + [**2.3.4**](#234-coreutils) coreutils
        + [**2.3.5**](#235-diffutils) diffutils
        + [**2.3.6**](#236-file) file
        + [**2.3.7**](#237-findutils) findutils
        + [**2.3.8**](#238-gawk) gawk
        + [**2.3.9**](#239-grep) grep
        + [**2.3.10**](#2310-gzip) gzip
        + [**2.3.11**](#2311-make) make
        + [**2.3.12**](#2312-patch) patch
        + [**2.3.13**](#2313-sed) sed
        + [**2.3.14**](#2314-tar) tar
        + [**2.3.15**](#2315-xz) xz
        + [**2.3.16**](#2316-binutils) binutils
        + [**2.3.17**](#2317-gcc) gcc
    + [**2.4**](#24-chroot后续构建) chroot后续构建
        + [**2.4.1**](#241-准备工作) 准备工作
        + [**2.4.2**](#242-chroot) chroot
        + [**2.4.3**](#243-gettext) gettext
        + [**2.4.4**](#244-bison) bison
        + [**2.4.5**](#245-perl) perl
        + [**2.4.6**](#246-python) python
        + [**2.4.7**](#247-texinfo) texinfo
        + [**2.4.8**](#248-util-linux) util-linux
        + [**2.4.9**](#249-清理并备份lfs目录) 清理并备份LFS目录
+ [**3**](#3-lfs构建系统剩余部分) LFS：构建系统剩余部分
    + [**3.1**](#31-简介) 简介
    + [**3.2**](#32-包管理) 包管理
    + [**3.3**](#33-剩余部分构建) 剩余部分构建
        + [**3.3.1**](#331-man-pages) man-pages
        + [**3.3.2**](#332-iana-etc) iana-etc
        + [**3.3.3**](#333-glibc) glibc
        + [**3.3.4**](#334-zlib) zlib
        + [**3.3.5**](#335-bzip2) bzip2
        + [**3.3.6**](#336-xz) xz
        + [**3.3.7**](#337-lz4) lz4
        + [**3.3.8**](#338-zstd) zstd
        + [**3.3.9**](#339-file) file
        + [**3.3.10**](#3310-readline) readline
        + [**3.3.11**](#3311-m4) m4
        + [**3.3.12**](#3312-bc) bc
        + [**3.3.13**](#3313-flex) flex
        + [**3.3.14**](#3314-tcl) tcl
        + [**3.3.15**](#3315-expect) expect
        + [**3.3.16**](#3316-dejagnu) dejagnu
        + [**3.3.17**](#3317-pkgconf) pkgconf
        + [**3.3.18**](#3318-binutils) binutils
        + [**3.3.19**](#3319-gmp) gmp
        + [**3.3.20**](#3320-mpfr) mpfr
        + [**3.3.21**](#3321-mpc) mpc
        + [**3.3.22**](#3322-attr) attr
        + [**3.3.23**](#3323-acl) acl
        + [**3.3.24**](#3324-libcap) libcap
        + [**3.3.25**](#3325-libxcrypt) libxcrypt
        + [**3.3.26**](#3326-shadow) shadow
        + [**3.3.27**](#3327-gcc) gcc
        + [**3.3.28**](#3328-ncurses) ncurses
        + [**3.3.29**](#3329-sed) sed
        + [**3.3.30**](#3330-psmisc) psmisc
        + [**3.3.31**](#3331-gettext) gettext
        + [**3.3.32**](#3332-bison) bison
        + [**3.3.33**](#3333-grep) grep
        + [**3.3.34**](#3334-bash) bash
        + [**3.3.35**](#3335-libtool) libtool
        + [**3.3.36**](#3336-gdbm) gdbm
        + [**3.3.37**](#3337-gperf) gperf
        + [**3.3.38**](#3338-expat) expat
        + [**3.3.39**](#3339-inetutils) inetutils
        + [**3.3.40**](#3340-less) less
        + [**3.3.41**](#3341-perl) perl
        + [**3.3.42**](#3342-xmlparser) xml::parser
        + [**3.3.43**](#3343-intltool) intltool
        + [**3.3.44**](#3344-autoconf) autoconf
        + [**3.3.45**](#3345-automake) automake
        + [**3.3.46**](#3346-openssl) openssl
        + [**3.3.47**](#3347-libelf-from-elfutils) libelf from elfutils
        + [**3.3.48**](#3348-libffi) libffi
        + [**3.3.49**](#3349-python) python
        + [**3.3.50**](#3350-flit-core) flit-core
        + [**3.3.51**](#3351-wheel) wheel
        + [**3.3.52**](#3352-setuptools) setuptools
        + [**3.3.53**](#3353-ninja) ninja
        + [**3.3.54**](#3354-meson) meson
        + [**3.3.55**](#3355-kmod) kmod
        + [**3.3.56**](#3356-coreutils) coreutils
        + [**3.3.57**](#3357-check) check
        + [**3.3.58**](#3358-diffutils) diffutils
        + [**3.3.59**](#3359-gawk) gawk
        + [**3.3.60**](#3360-findutils) findutils
        + [**3.3.61**](#3361-groff) groff
        + [**3.3.62**](#3362-grub) grub
        + [**3.3.63**](#3363-gzip) gzip
        + [**3.3.64**](#3364-iproute2) iproute2
        + [**3.3.65**](#3365-kbd) kbd
        + [**3.3.66**](#3366-libpipeline) libpipeline
        + [**3.3.67**](#3367-make) make
        + [**3.3.68**](#3368-patch) patch
        + [**3.3.69**](#3369-tar) tar
        + [**3.3.70**](#3370-texinfo) texinfo
        + [**3.3.71**](#3371-vim) vim
        + [**3.3.72**](#3372-markupsafe) markupsafe
        + [**3.3.73**](#3373-jinja2) jinja2
        + [**3.3.74**](#3374-udev-from-systemd) udev from systemd
        + [**3.3.75**](#3375-man-db) man-db
        + [**3.3.76**](#3376-procps-ng) procps-ng
        + [**3.3.77**](#3377-util-linux) util-linux
        + [**3.3.78**](#3378-e2fsprogs) e2fsprogs
        + [**3.3.79**](#3379-sysklogd) sysklogd
        + [**3.3.80**](#3380-sysvinit) sysvinit
+ [**4**](#4-lfs系统配置) LFS：系统配置
+ [**5**](#5-lfs内核编译与uefi启动引导) LFS：内核编译与UEFI启动引导
+ [**6**](#6-blfs) BLFS

## 1 LFS：准备工作

## 1.1 标准解读：LSB3.0需要的包

LSB（Linux Standard Base）Version 3.0

LSB只是一个推荐的标准，仅供参考，实际上不一定要完全按照LSB的来，有些包可以省略或自己选替代，也可以另外加想要的包和功能

### 1.1.1 LSB Core

LFS提供

```
bash bc binutils coreutils diffutils file findutils gawk gcc gettext glibc grep gzip m4 man-db procps psmisc sed shadow sysvinit tar util-linux zlib
```

BLFS提供

```
at batch blfs-bash-startup-files cpio ed fcrontab lsb-tools nspr nss linux-pam pax sendmail/postfix/exim time
```

其他

```
install_initd libxcrypt(libcrypt.so.1) ncurses(libncurses.so.5 libncursesw.so.6) 
```

> LSB 3.0要求提供`libncursesw.so.5`

### 1.1.2 LSB Desktop

BLFS提供

```
alsa atk cairo desktop-file-utils freetype fontconfig gdk-pixbuf glib2 glu icon-naming-utils libjpeg-turbo libxml2 mesa pango xdg-utils xorg
```

其他

```
gtk+3(libgdk-3.so libgtk-3.so) gtk4(libgtk-4.so) libpng(libpng16.so) qt6(libQt6*.so.6) libtiff(libtiff.so.6) libpng(libpng16.so)
```

> LSB 3.0要求提供`libgdk-x11-2.0.so libgtk-x11-2.0.so libpng12.so libQt*.so.4 libtiff.so.4 libpng15.so`

### 1.1.3 LSB Languages

LFS提供

```
perl
```

BLFS提供

```
libxml2 libxslt
```

其他

```
python(python3)
```

> LSB 3.0要求提供`python2`

### 1.1.4 LSB Imaging

BLFS提供

```
cups cups-filters ghostscript sane
```

## 1.2 LFS源码准备

共87个包

尽量使用`tarball`而不是克隆仓库

记得下载完成以后把所有包和补丁放到`$LFS/sources`再解压，并且最好是构建每个包之前再解压，否则容易遇到时间戳导致的怪问题

| 包名 | 版本 | 项目主页 | release tarball下载地址 | 仓库地址 |
| :- | :- | :- | :- | :- |
| `acl` | `2.3.2` | [nongnu.org](https://savannah.nongnu.org/projects/acl) | [下载](http://download.savannah.nongnu.org/releases/acl/acl-2.3.2.tar.gz) | [nongnu.org](https://git.savannah.nongnu.org/git/acl.git) |
| `attr` | `2.5.2` | [nongnu.org](https://savannah.nongnu.org/projects/attr) | [下载](http://download.savannah.nongnu.org/releases/attr/attr-2.5.2.tar.gz) | [nongnu.org](https://git.savannah.nongnu.org/git/attr.git) |
| `autoconf` | `2.72` | [gnu.org](https://www.gnu.org/software/autoconf/) | [下载](https://ftp.gnu.org/gnu/autoconf/autoconf-2.72.tar.xz) | [gnu.org](https://git.sv.gnu.org/r/autoconf.git) |
| `automake` | `1.17` | [gnu.org](https://www.gnu.org/software/automake/) | [下载](https://ftp.gnu.org/gnu/automake/automake-1.17.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/automake.git) |
| `bash` | `5.2.37` | [gnu.org](https://www.gnu.org/software/bash/) | [下载](https://ftp.gnu.org/gnu/bash/bash-5.2.37.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/bash.git) |
| `bc` | `7.0.3` | [github.com](https://github.com/gavinhoward/bc) | [下载](https://github.com/gavinhoward/bc/releases/download/7.0.3/bc-7.0.3.tar.xz) | [github.com](https://github.com/gavinhoward/bc.git) |
| `binutils` | `2.44` | [gnu.org](https://www.gnu.org/software/binutils/) | [下载](https://sourceware.org/pub/binutils/releases/binutils-2.44.tar.xz) | [sourceware.org](https://sourceware.org/git/binutils-gdb.git) |
| `bison` | `3.8.2` | [gnu.org](https://www.gnu.org/software/bison/) | [下载](https://ftp.gnu.org/gnu/bison/bison-3.8.2.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/bison.git) |
| `bzip2` | `1.0.8` | [sourceware.org](https://sourceware.org/bzip2/) | [下载](http://www.sourceware.org/pub/bzip2/bzip2-1.0.8.tar.gz) | [sourceware.org](https://sourceware.org/git/bzip2.git) |
| `check` | `0.15.2` | [github.io](https://libcheck.github.io/check/) | [下载](https://github.com/libcheck/check/releases/download/0.15.2/check-0.15.2.tar.gz) | [github.com](https://github.com/libcheck/check.git) |
| `coreutils` | `9.6` | [gnu.org](https://www.gnu.org/software/coreutils/) | [下载](https://ftp.gnu.org/gnu/coreutils/coreutils-9.6.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/coreutils.git) |
| `dejagnu` | `1.6.3` | [gnu.org](https://www.gnu.org/software/dejagnu/) | [下载](https://ftp.gnu.org/gnu/dejagnu/dejagnu-1.6.3.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/dejagnu.git) |
| `diffutils` | `3.11` | [gnu.org](https://www.gnu.org/software/diffutils/) | [下载](https://ftp.gnu.org/gnu/diffutils/diffutils-3.11.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/diffutils.git) |
| `e2fsprogs` | `1.47.2` | [sourceforge.net](https://e2fsprogs.sourceforge.net/) | [下载](https://mirrors.edge.kernel.org/pub/linux/kernel/people/tytso/e2fsprogs/v1.47.2/e2fsprogs-1.47.2.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/fs/ext2/e2fsprogs.git) |
| `elfutils` | `0.192` | [sourceware.org](https://sourceware.org/elfutils/) | [下载](https://sourceware.org/elfutils/ftp/0.192/elfutils-0.192.tar.bz2) | [sourceware.org](https://sourceware.org/git/elfutils.git) |
| `expat` | `2.6.4` | [github.io](https://libexpat.github.io/) | [下载](https://github.com/libexpat/libexpat/releases/download/R_2_6_4/expat-2.6.4.tar.xz) | [github.com](https://github.com/libexpat/libexpat.git) |
| `expect` | `5.45.4` | [tcl-lang.org](https://core.tcl-lang.org/expect/index) | [下载](https://prdownloads.sourceforge.net/expect/expect5.45.4.tar.gz) | [tcl-lang.org (fossil)](https://core.tcl-lang.org/expect) |
| `file` | `5.46` | [darwinsys.com](https://www.darwinsys.com/file/) | [下载](http://astron.com/pub/file/file-5.46.tar.gz) | [github.com](https://github.com/file/file.git) |
| `findutils` | `4.10.0` | [gnu.org](https://www.gnu.org/software/findutils/) | [下载](https://ftp.gnu.org/gnu/findutils/findutils-4.10.0.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/findutils.git) |
| `flex` | `2.6.4` | [github.com](https://github.com/westes/flex) | [下载](https://github.com/westes/flex/releases/download/v2.6.4/flex-2.6.4.tar.gz) | [github.com](https://github.com/westes/flex.git) |
| `flit-core` | `3.11.0` | [pypi.org](https://pypi.org/project/flit-core/) | [下载](https://files.pythonhosted.org/packages/source/f/flit-core/flit_core-3.11.0.tar.gz) | [github.com](https://github.com/pypa/flit.git) |
| `gawk` | `5.3.1` | [gnu.org](https://www.gnu.org/software/gawk/) | [下载](https://ftp.gnu.org/gnu/gawk/gawk-5.3.1.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/gawk.git) |
| `gcc` | `14.2.0` | [gnu.org](https://gcc.gnu.org/) | [下载](https://ftp.gnu.org/gnu/gcc/gcc-14.2.0/gcc-14.2.0.tar.xz) | [gnu.org](https://gcc.gnu.org/git/gcc.git) |
| `gdbm` | `1.24` | [gnu.org](https://www.gnu.org/software/gdbm/) | [下载](https://ftp.gnu.org/gnu/gdbm/gdbm-1.24.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/gdbm.git) |
| `gettext` | `0.24` | [gnu.org](https://www.gnu.org/software/gettext/) | [下载](https://ftp.gnu.org/pub/gnu/gettext/gettext-0.24.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/gettext.git) |
| `glibc` | `2.41` | [gnu.org](https://www.gnu.org/software/libc/) | [下载](https://ftp.gnu.org/pub/gnu/glibc/glibc-2.41.tar.xz) | [sourceware.org](https://sourceware.org/git/glibc.git) |
| `gmp` | `6.3.0` | [gmplib.org](https://gmplib.org/) | [下载](https://gmplib.org/download/gmp/gmp-6.3.0.tar.xz) | [gmplib.org (mercurial)](https://gmplib.org/repo/gmp/) |
| `gperf` | `3.1` | [gnu.org](https://www.gnu.org/software/gperf/) | [下载](https://ftp.gnu.org/pub/gnu/gperf/gperf-3.2.1.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/gperf.git) |
| `grep` | `3.11` | [gnu.org](https://www.gnu.org/software/grep/) | [下载](https://ftp.gnu.org/pub/gnu/grep/grep-3.11.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/grep.git) |
| `groff` | `1.23.0` | [gnu.org](https://www.gnu.org/software/groff/) | [下载](https://ftp.gnu.org/pub/gnu/groff/groff-1.23.0.tar.gz) | [gnu.org](https://git.savannah.gnu.org/git/groff.git) |
| `grub` | `2.12` | [gnu.org](https://www.gnu.org/software/grub/) | [下载](https://ftp.gnu.org/pub/gnu/grub/grub-2.12.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/grub.git) |
| `gzip` | `1.13` | [gnu.org](https://www.gnu.org/software/gzip/) | [下载](https://ftp.gnu.org/gnu/gzip/gzip-1.13.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/gzip.git) |
| `iana-etc` | `20250123` | [github.com](https://github.com/Mic92/iana-etc) | [下载](https://github.com/Mic92/iana-etc/releases/download/20250123/iana-etc-20250123.tar.gz) | [github.com](https://github.com/Mic92/iana-etc.git) |
| `inetutils` | `2.6` | [gnu.org](https://www.gnu.org/software/inetutils/) | [下载](https://ftp.gnu.org/gnu/inetutils/inetutils-2.6.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/inetutils.git) |
| `intltool` | `0.51.0` | [freedesktop.org](https://freedesktop.org/wiki/Software/intltool/) | [下载](https://launchpad.net/intltool/trunk/0.51.0/+download/intltool-0.51.0.tar.gz) | [launchpad.net (bazaar)](https://bazaar.launchpad.net/~intltool/intltool/trunk/files) |
| `iproute2` | `6.13.0` | [kernel.org](https://mirrors.edge.kernel.org/pub/linux/utils/net/iproute2/) | [下载](https://mirrors.edge.kernel.org/pub/linux/utils/net/iproute2/iproute2-6.13.0.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/network/iproute2/iproute2.git) |
| `jinja2` | `3.1.5` | [palletsprojects.com](https://jinja.palletsprojects.com/en/stable/) [github.com](https://github.com/pallets/jinja/) | [下载](https://pypi.org/packages/source/J/Jinja2/jinja2-3.1.5.tar.gz) | [github.com](https://github.com/pallets/jinja.git) |
| `kbd` | `2.7.1` | [kbd-project.org](https://kbd-project.org/) | [下载](https://www.kernel.org/pub/linux/utils/kbd/kbd-2.7.1.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/linux/kernel/git/legion/kbd.git) |
| `kmod` | `34` | [github.com](https://github.com/kmod-project/kmod) | [下载](https://www.kernel.org/pub/linux/utils/kernel/kmod/kmod-34.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/utils/kernel/kmod/kmod.git) |
| `less` | `668` | [greenwoodsoftware.com](http://greenwoodsoftware.com/less) | [下载](https://www.greenwoodsoftware.com/less/less-668.tar.gz) | [github.com](https://github.com/gwsw/less.git) |
| `lfs-bootscripts` | `20240825` |  | [下载](https://www.linuxfromscratch.org/lfs/downloads/12.3/lfs-bootscripts-20240825.tar.xz) |  |
| `libcap` | `2.73` | [google.com/site/fullycapable](https://sites.google.com/site/fullycapable/) | [下载](https://www.kernel.org/pub/linux/libs/security/linux-privs/libcap2/libcap-2.73.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/libs/libcap/libcap.git) |
| `libffi` | `3.4.7` | [sourceware.org](https://sourceware.org/libffi/) | [下载](https://github.com/libffi/libffi/releases/download/v3.4.7/libffi-3.4.7.tar.gz) | [github.com](https://github.com/libffi/libffi.git) |
| `libpipeline` | `1.5.8` | [nongnu.org](https://libpipeline.nongnu.org/) | [下载]( https://download.savannah.gnu.org/releases/libpipeline/libpipeline-1.5.8.tar.gz) | [nongnu.org](https://git.savannah.nongnu.org/git/libpipeline.git) |
| `libtool` | `2.5.4` | [gnu.org](https://www.gnu.org/software/libtool/) | [下载](https://ftp.gnu.org/gnu/libtool/libtool-2.5.4.tar.xz) | [gnu.org](https://git.savannah.gnu.org/libtool.git) |
| `libxcrypt` | `4.4.38` | [github.com](https://github.com/besser82/libxcrypt/) | [下载]( https://github.com/besser82/libxcrypt/releases/download/v4.4.38/libxcrypt-4.4.38.tar.xz) | [github.com](https://github.com/besser82/libxcrypt.git) |
| `linux` | `6.13.4` | [kernel.org](https://www.kernel.org/) | [下载](https://www.kernel.org/pub/linux/kernel/v6.x/linux-6.13.4.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git) |
| `lz4` | `1.10.0` | [lz4.org](https://lz4.org/) | [下载]( https://github.com/lz4/lz4/releases/download/v1.10.0/lz4-1.10.0.tar.gz) | [github.com](https://github.com/lz4/lz4.git) |
| `m4` | `1.4.19` | [gnu.org](https://www.gnu.org/software/m4/) | [下载](https://ftp.gnu.org/gnu/m4/m4-1.4.19.tar.xz) | [gnu.org](https://git.savannah.gnu.org/r/m4.git) |
| `make` | `4.4.1` | [gnu.org](https://www.gnu.org/software/make/) | [下载](https://ftp.gnu.org/gnu/make/make-4.4.1.tar.gz) | [gnu.org](https://git.savannah.gnu.org/r/make.git) |
| `man-db` | `2.13.0` | [nongnu.org](https://www.nongnu.org/man-db/) | [下载](https://download.savannah.gnu.org/releases/man-db/man-db-2.13.0.tar.xz) | [gitlab.com](https://gitlab.com/man-db/man-db.git) |
| `man-pages` | `6.12` | [kernel.org](https://www.kernel.org/doc/man-pages/) | [下载](https://www.kernel.org/pub/linux/docs/man-pages/man-pages-6.12.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/docs/man-pages/man-pages.git) |
| `markupsafe` | `3.0.2` | [palletsprojects.com](https://palletsprojects.com/p/markupsafe/) | [下载](https://pypi.org/packages/source/M/MarkupSafe/markupsafe-3.0.2.tar.gz) | [github.com](https://github.com/pallets/markupsafe.git) |
| `meson` | `1.7.0` | [mesonbuild.com](https://mesonbuild.com) | [下载](https://github.com/mesonbuild/meson/releases/download/1.7.0/meson-1.7.0.tar.gz) | [github.com](https://github.com/mesonbuild/meson.git) |
| `mpc` | `1.3.1` | [multiprecision.org](https://www.multiprecision.org/) | [下载](https://ftp.gnu.org/gnu/mpc/mpc-1.3.1.tar.gz) | [gitlab.inria.fr](https://gitlab.inria.fr/mpc/mpc.git) |
| `mpfr` | `4.2.1` | [mpfr.org](https://www.mpfr.org/) | [下载](https://ftp.gnu.org/gnu/mpfr/mpfr-4.2.1.tar.xz) | [gitlab.inria.fr](https://gitlab.inria.fr/mpfr/mpfr.git) |
| `ncurses` | `6.5` | [invisible-island.net](https://invisible-island.net/ncurses/) | [下载](https://invisible-mirror.net/archives/ncurses/ncurses-6.5.tar.gz) | [invisible-island.net (patch only)](https://invisible-island.net/archives/ncurses/6.4/) |
| `ninja` | `1.12.1` | [ninja-build.org](https://ninja-build.org/) | [下载](https://github.com/ninja-build/ninja/archive/v1.12.1/ninja-1.12.1.tar.gz) | [github.com](https://github.com/ninja-build/ninja.git) |
| `openssl` | `3.4.1` | [openssl-library.org](https://www.openssl-library.org/) | [下载](https://github.com/openssl/openssl/releases/download/openssl-3.4.1/openssl-3.4.1.tar.gz) | [github.com](https://github.com/openssl/openssl.git) |
| `patch` | `2.7.6` | [gnu.org](https://savannah.gnu.org/projects/patch/) | [下载](https://ftp.gnu.org/gnu/patch/patch-2.7.6.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/patch.git) |
| `perl` | `5.40.1` | [perl.org](https://www.perl.org/) | [下载](https://www.cpan.org/src/5.0/perl-5.40.1.tar.xz) | [github.com](https://github.com/Perl/perl5.git) |
| `pkgconf` | `2.3.0` | [github.com](https://github.com/pkgconf/pkgconf) | [下载]( https://distfiles.ariadne.space/pkgconf/pkgconf-2.3.0.tar.xz) | [github.com](https://github.com/pkgconf/pkgconf.git) |
| `procps` | `4.0.5` | [gitlab.com](https://gitlab.com/procps-ng/procps/) | [下载]( https://sourceforge.net/projects/procps-ng/files/Production/procps-ng-4.0.5.tar.xz) | [gitlab.com](https://gitlab.com/procps-ng/procps.git) |
| `psmisc` | `23.7` | [gitlab.com](https://gitlab.com/psmisc/psmisc) | [下载](https://sourceforge.net/projects/psmisc/files/psmisc/psmisc-23.7.tar.xz) | [gitlab.com](https://gitlab.com/psmisc/psmisc.git) |
| `python` | `3.13.2` | [python.org](https://www.python.org/) | [下载](https://www.python.org/ftp/python/3.13.2/Python-3.13.2.tar.xz) | [github.com](https://github.com/python/cpython.git) |
| `python-docs` | `3.13.2` | [python.org](https://www.python.org/) | [下载](https://www.python.org/ftp/python/doc/3.13.2/python-3.13.2-docs-html.tar.bz2) | [github.com](https://github.com/python/cpython.git) |
| `readline` | `8.2.13` | [tiswww.case.edu](https://tiswww.case.edu/php/chet/readline/rltop.html) | [下载](https://ftp.gnu.org/gnu/readline/readline-8.2.13.tar.gz) | [gnu.org](http://git.savannah.gnu.org/cgit/readline.git) |
| `sed` | `4.9` | [gnu.org](https://www.gnu.org/software/sed/) | [下载](https://ftp.gnu.org/gnu/sed/sed-4.9.tar.xz) | [gnu.org](https://git.sv.gnu.org/sed) |
| `setuptools` | `75.8.1` | [pypi.org](https://pypi.org/project/setuptools/) | [下载](https://pypi.org/packages/source/s/setuptools/setuptools-75.8.1.tar.gz) | [github.com](https://github.com/pypa/setuptools.git) |
| `shadow` | `4.17.3` | [github.com](https://github.com/shadow-maint/shadow/) | [下载](https://github.com/shadow-maint/shadow/releases/download/4.17.3/shadow-4.17.3.tar.xz) | [github.com](https://github.com/shadow-maint/shadow.git) |
| `sysklogd` | `2.7.0` | [infodrom.org](https://www.infodrom.org/projects/sysklogd/) | [下载](https://github.com/troglobit/sysklogd/releases/download/v2.7.0/sysklogd-2.7.0.tar.gz) | [infodrom.org](git://git.infodrom.org/infodrom/sysklogd) [github.com](https://github.com/troglobit/sysklogd.git) |
| `systemd` | `257.3` | [freedesktop.org](https://www.freedesktop.org/wiki/Software/systemd/) | [下载](https://github.com/systemd/systemd/archive/v257.3/systemd-257.3.tar.gz) | [github.com](https://github.com/systemd/systemd.git) |
| `systemd-man-pages` | `257.3` | [freedesktop.org](https://www.freedesktop.org/wiki/Software/systemd/) | [下载](https://anduin.linuxfromscratch.org/LFS/systemd-man-pages-257.3.tar.xz) | [github.com](https://github.com/systemd/systemd.git) |
| `sysvinit` | `3.14` | [nongnu.org](https://savannah.nongnu.org/projects/sysvinit) | [下载](https://github.com/slicer69/sysvinit/releases/download/3.14/sysvinit-3.14.tar.xz) | [github.com](https://github.com/slicer69/sysvinit.git) |
| `tar` | `1.35` | [gnu.org](https://www.gnu.org/software/tar/) | [下载](https://ftp.gnu.org/gnu/tar/tar-1.35.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/tar.git) |
| `tcl` | `8.6.16` | [sourceforge.net](https://tcl.sourceforge.net/) | [下载](https://downloads.sourceforge.net/tcl/tcl8.6.16-src.tar.gz) | [tcl-lang.org (fossil)](https://core.tcl-lang.org/tcl) |
| `tcl-docs` | `8.6.16` | [sourceforge.net](https://tcl.sourceforge.net/) | [下载](https://downloads.sourceforge.net/tcl/tcl8.6.16-html.tar.gz) | [tcl-lang.org (fossil)](https://core.tcl-lang.org/tcl) |
| `texinfo` | `7.2` | [gnu.org](https://www.gnu.org/software/texinfo/) | [下载](https://ftp.gnu.org/gnu/texinfo/texinfo-7.2.tar.xz) | [gnu.org](https://git.savannah.gnu.org/git/texinfo.git) |
| `timezonedata` | `2025a` | [iana.org](https://www.iana.org/time-zones) | [下载](https://www.iana.org/time-zones/repository/releases/tzdata2025a.tar.gz) | [iana.org (tarballs only)](https://data.iana.org/time-zones/releases/) |
| `udev-lfs` | `udev-lfs-20230818` |  | [下载](https://anduin.linuxfromscratch.org/LFS/udev-lfs-20230818.tar.xz) |  |
| `util-linux` | `2.40.4` | [kernel.org](https://git.kernel.org/pub/scm/utils/util-linux/util-linux.git/about/) | [下载](https://www.kernel.org/pub/linux/utils/util-linux/v2.40/util-linux-2.40.4.tar.xz) | [kernel.org](https://git.kernel.org/pub/scm/utils/util-linux/util-linux.git) |
| `vim` | `9.1.1166` | [vim.org](https://www.vim.org) | [下载](https://github.com/vim/vim/archive/v9.1.1166/vim-9.1.1166.tar.gz) | [github.com](https://github.com/vim/vim.git) |
| `wheel` | `0.45.1` | [pypi.org](https://pypi.org/project/wheel/) | [下载](https://pypi.org/packages/source/w/wheel/wheel-0.45.1.tar.gz) | [github.com](https://github.com/pypa/wheel.git) |
| `xml-parser` | `2.47` | [github.com](https://github.com/chorny/XML-Parser) | [下载](https://cpan.metacpan.org/authors/id/T/TO/TODDR/XML-Parser-2.47.tar.gz) | [github.com](https://github.com/chorny/XML-Parser.git) |
| `xz` | `5.6.4` | [tukaani.org](https://tukaani.org/xz) | [下载](https://github.com//tukaani-project/xz/releases/download/v5.6.4/xz-5.6.4.tar.xz) | [github.com](https://github.com/tukaani-project/xz.git) |
| `zlib` | `1.3.1` | [zlib.net](https://zlib.net/) | [下载](https://zlib.net/fossils/zlib-1.3.1.tar.gz) | [github.com](https://github.com/madler/zlib.git) |
| `zstd` | `1.5.7` | [github.com](https://facebook.github.io/zstd/) | [下载](https://github.com/facebook/zstd/releases/download/v1.5.7/zstd-1.5.7.tar.gz) | [github.com](https://github.com/facebook/zstd.git) |

## 1.3 LFS补丁准备

| 补丁 | tarball下载 |
| :- | :- |
| bzip2 documentation | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/bzip2-1.0.8-install_docs-1.patch) |
| coreutils internationalization fixes (i18n) | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/coreutils-9.6-i18n-1.patch) |
| expect gcc14 | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/expect-5.45.4-gcc14-1.patch) |
| glibc fhs | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/glibc-2.41-fhs-1.patch) |
| kbd backspace/delete fix | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/kbd-2.7.1-backspace-1.patch) |
| sysvinit consolidated | [下载](https://www.linuxfromscratch.org/patches/lfs/12.3/sysvinit-3.14-consolidated-1.patch) |

## 1.4 LFS目录创建

使用普通用户身份创建一个新目录，用于LFS的根目录。确保权限为`755`（可以设定`umask 022`）

后续该目录以及所有子目录要`chown root:root`，保证UID和GID都为`0`。这里先保持为普通用户

```
$ umask 022
$ mkdir -p lfs/etc lfs/var
$ mkdir -p lfs/usr/bin lfs/usr/sbin lfs/usr/lib
$ ln -s usr/bin lfs/bin
$ ln -s usr/sbin lfs/sbin
$ ln -s usr/lib lfs/lib
$ mkdir lfs/tools
$ mkdir lfs/sources
$ mkdir lfs/lib64
$ ls lfs/
bin     etc     lib     lib64   sbin    sources     tools   usr     var
```

> `tools`用于存放交叉工具链1。注意刚刚下载的源码和补丁尽量放到`sources`再解压缩，不要解压缩后中途复制，否则时间戳问题容易会对构建过程造成影响

## 1.5 环境

使用普通用户身份新开一个`bash`，隔离可能会有影响的环境变量，设定一些常用变量，仅继承少量无关紧要的变量。可以写成shell脚本

```
$ export LFS=/absolute/path/to/lfs
$ exec env -i HOME="$HOME" \
> TERM="$TERM" \
> PS1="$PS1" \
> PATH=/bin:/usr/bin:$LFS/tools/bin \
> LFS=$LFS \
> LC_ALL=POSIX \
> LFS_TGT=x86_64-lfs-linux-gnu \
> CONFIG_SITE=$LFS/usr/share/config.site /bin/bash
```

> 设置`CONFIG_SITE`是防止`configure`脚本读主机的`config.site`

进入新shell后检查一下

```
$ env
```

在新`bash`实例下执行以下命令

```
$ set +h
$ umask 022
```

> `set +h`关闭`bash`的哈希功能，强制`bash`每次都去`$PATH`找可执行文件而不是使用缓存的路径

也可以提前设定一下`make`线程数，后面可以直接调这个环境变量

```
$ export MAKEFLAGS=-j$(nproc)
```

## 2 LFS：构建交叉工具链与基础组件

## 2.1 基本概念

### 2.1.1 triplet名

工具链名称是一个triplet，已经给出`LFS_TGT=x86_64-lfs-linux-gnu`（target）。这是`autoconf`要求的格式，格式为`cpu-vendor-kernel-os`，其中`vendor`可以省略（默认不写为`unknown`）。可以通过`binutils`包中的`config.guess`脚本获取这个名称

> 当前系统使用的工具链triplet名可以通过`gcc -dumpmachine`获得

### 2.1.2 动态链接器

`glibc`提供了一个动态链接器`ld-linux-x86-64.so.2`。其他的替代品有`mold`等（[github](https://github.com/rui314/mold)）

> 当前系统使用的动态链接器可以使用`readelf -l /any/elf/file | grep interpreter`获取

### 2.1.3 Canadian Cross

工具链是制造软件的软件，正如机床是工业母机。工具链当然可以用来编译工具链

工具链有3个属性：**build**，**host**，**target**

**build**指这个工具链本身在什么平台被生产编译出来

**host**指这个工具链本身在什么平台运行

**target**指这个工具链生产出来的代码在什么平台运行

也就是说当前机器运行的工具链不一定是在本机生产的，它编译出的代码也不一定是在本机运行的

之所以叫Canadian Cross原因如下

> The term Canadian Cross was coined because at the time that these issues were all being hashed out, Canada had three national political parties - [by crosstool-ng](https://crosstool-ng.github.io/docs/toolchain-types/)

假设我们想要在平台A构建在平台B上运行的工具链，而这个工具链编译出的程序在平台C上执行，至少需要编译3次

| Pass | build | host | target |
| :- | :- | :- | :- |
| 交叉工具链1 | A | A | B |
| 交叉工具链2 | A | B | C |
| 工具链3 | B | C | C |

后续就可以实现C平台完全自举（同时可以测试检查用）

| Pass | build | host | target |
| :- | :- | :- | :- |
| 工具链4 | C | C | C |

> 第1次在平台A构建出在A上执行的生成平台B程序的工具链
>
> 第2次将第1次构建出的工具链放到平台B上执行，用这个工具链构建出生成平台C程序的工具链
>
> 第3次将第2次构建出的工具链放到平台C上执行，这样C平台就有了可以在本机执行的、生成本机代码的工具链，实现自举
>
> 只有第1次和第2次的工具链算交叉工具链，因为它们的host和target不同

上述场景的前提是A性能较低，且B没有可用的工具链。而LFS中实际上我们只需要Cross一次（B有可用的工具链且性能足够，无需再有A->B），所以至少编译2次即可

| Pass | build | host | target |
| :- | :- | :- | :- |
| 交叉工具链1 | B | B | C |
| 工具链2 | B | C | C |

保证C平台完全自举

| Pass | build | host | target |
| :- | :- | :- | :- |
| 工具链3 | C | C | C |

我们要生产工具链，所以当前主机必须要有至少一个可以直接运行的工具链，才有可能造出新的工具链

AlpineLinux安装

```
$ apk add gcc musl-dev make bison flex texinfo automake patch gawk gperf
```

> 实际上最后还是要在C平台重新编译出整个工具链3，因为工具链2是在B平台交叉编译出来的，可能会缺少一些可选的依赖，并且在B平台由于是交叉编译环境`autoconf`可能无法侦测到一些feature。还有一个原因是可能需要本地运行testsuite检验功能是否完整。这不仅对于工具链本身成立，对于其他软件也是成立的
>
> 交叉工具链1会被放到`$LFS/tools`

### 2.1.4 libgcc

GNU工具链本身需要依赖`libgcc`才能运行，而`libgcc`又链接了`libc`和`libstdc++`

在本文的环境里，构建B平台运行（目标为C平台）的交叉工具链1时，编译它的`libgcc`时会避免去使用到`libc`以及`libstdc++`的功能，从而避免链接到主机的`libc`库，这个交叉工具链1是一个degraded的工具链，缺少一些功能和特性，主要是**它本身**无法调用操作系统的线程库以及异常处理等功能，用它构建目标机代码在某些场景下可能会遇到一些问题。而在C平台运行的工具链2会依赖交叉工具链1编译出来的`glibc`和`libstdc++`运行，具备相对更完整的功能，因为用交叉工具链1构建出来的适用于C平台的`glibc`功能是完备的

## 2.2 构建交叉工具链1

### 2.2.1 构建顺序

构建与安装顺序按照`binutils` `gcc` `linux-headers` `glibc` `libstdc++`

> 这里的`gcc`是一个degraded的交叉工具链。后面的`glibc` `libstdc++`以及新的工具链2由这个交叉工具链1编译出来
>
> 从使用方法来看，交叉工具链和非交叉工具链的一大区别就是会有triplet前缀，例如`arm-none-gnueabihf-gcc` `x86_64-lfs-linux-gnu-gcc` `X86_64-none-linux-musl-gcc`，而本机平台的非交叉工具链不会有triplet前缀，triplet要通过`gcc -dumpmachine`才能看到

**binutils和gcc**

把`binutils`放在最开始编译是因为无论`gcc`还是`glibc`的`configure`脚本都需要检查平台已有的汇编器和链接器的特性，来判断开启/关闭哪些特性与功能

`binutils`会安装到`$LFS/tools/bin`和`$LFS/tools/$LFS_TGT/bin`，两个目录里的文件是硬链接的关系

后续运行`gcc`的`configure`脚本时会看到它使用了`$LFS/tools/$LFS_TGT/bin`下的`as`和`ld`。而在后续实际执行时并不一定使用这两个`as`和`ld`，实际使用的汇编器和链接器可以在`gcc`被编译出来以后使用`$LFS_TGT-gcc -print-prog-name=ld`获取。而在已经启动的本地系统上可以使用`gcc -print-prog-name=ld`

`ld`链接器扫描库文件目录也是有顺序的。在编译完成`binutils`后可以通过`$LFS_TGT-ld --verbose | grep SEARCH`获取搜寻顺序，而在已经启动的本地系统上可以使用`ld --verbose | grep SEARCH`

> 使用`gcc -v somecode.c`试编译代码也可以看到上述这类信息

**linux-headers**

把`linux-headers`安装放在`glibc`之前是因为`glibc`需要调用`linux`提供的接口

**glibc**

编译`glibc`前，`configure`脚本通过`--host`参数判定使用`$LFS_TGT-gcc`和`$LFS_TGT-ld`等工具。建议`configure`完先检查一下`build`目录下的`config.make`是否有异样

**libstdc++**

`libstdc++`依赖`glibc`所以把`glibc`放在前

### 2.2.2 binutils

编译前最后再检查一下AlpineLinux下是否有`/usr/bin/awk`和`/usr/bin/yacc`，`sh`软链接到`bash`，`yacc`软链接到`bison`，且当前默认使用的shell为`bash`

进入到`$LFS/sources`下解压后的`binutils-2.44`目录，创建一个`build`目录

```
$ mkdir build
$ cd build
```

执行`../configure`，参数含义见下

```
$ ../configure --prefix=$LFS/tools  \ # make install安装的路径前缀
> --with-sysroot=$LFS               \ # 该交叉工具链1需要搜寻的库所在路径
> --target=$LFS_TGT                 \ # 告诉binutil的构建系统构建一个交叉链接器，强制覆盖config.guess的返回结果
> --disable-nls                     \ # 关i18n国际化支持，交叉工具链暂不需要
> --enable-gprofng=no               \ # 不构建gprofng，交叉工具链不需要
> --disable-werror                  \ # 编译出现warning时不停止
> --enable-new-dtags                \ # 让ld在编译出来的可执行文件/动态库中使用runpath而非rpath记录搜寻目录，方便调试
> --enable-default-hash-style=gnu     # hash table被动态链接器用于搜寻符号，由于后续使用glibc所以只保留gnu style的hash table，速度更快，丢弃classic style的hash table
```

构建与安装

```
$ make -j16
$ make install
```

> 第一次构建可能很容易发现系统AlpineLinux环境缺少的组件例如`flex` `texinfo`等从而导致构建失败。这时候先安装好这些组件，`make clean`后可以先重新`configure`再重新`make`，直到构建通过
>
> `make install`以后应当在`../../../tools`下看到新安装的内容

### 2.2.3 gcc

> 注意这里解压tar包尽量按顺序来，先解压`gcc`再依次解压`mpfr` `gmp` `mpc`，也不要修改这些目录下的内容导致时间戳被改变。时间戳的改变会导致`configure`异常或`build`失败。如果发生了一些奇怪的error，可以重新解压一遍重新build

需要使用到`mpfr gmp mpc`，把它们都放到`gcc-14.2.0`下并依次解压重命名，这些包主要是计算功能

```
$ cp ../mpfr-4.2.1.tar.xz .
$ tar -axvf mpfr-4.2.1.tar.xz
$ mv mpfr-4.2.1 mpfr
$ cp ../gmp-6.3.0.tar.xz .
$ tar -axvf gmp-6.3.0.tar.xz
$ mv gmp-6.3.0 gmp
$ cp ../mpc-1.3.1.tar.gz .
$ tar -axvf mpc-1.3.1.tar.gz
$ mv mpc-1.3.1 mpc
```

修改`gcc-14.2.0`下`gcc/config/i386/t-linux64`，将`lib64`改为`lib`（因为是`x86_64`平台）

```
...
MULTILIB_OSDIRNAMES = m64=../lib$(call if_multiarch,:x86_64-linux-gnu)
...
```

创建`build`再`configure`

```
$ mkdir build
$ cd build
$ ../configure              \
> --target=$LFS_TGT         \
> --prefix=$LFS/tools       \
> --with-glibc-version=2.41 \ # 该交叉工具链搭配使用的glibc版本
> --with-sysroot=$LFS       \
> --with-newlib             \ # 保证编译libgcc时inhibit_libc常量被定义，避免这个交叉工具链的libgcc依赖任何libc
> --without-headers         \ # 无需强制要求目标平台的标准头文件
> --enable-default-pie      \ # 安全特性，尽量接近后面的最终版工具链
> --enable-default-ssp      \ # 安全特性
> --disable-nls             \
> --disable-shared          \ # 指示静态链接gcc的库而非动态，如果动态是需要glibc的，此时还没有
> --disable-multilib        \ # x86_64禁用multilib
> --disable-threads         \ # 关threads库防止构建失败。交叉工具链1无需该特性
> --disable-libatomic       \ # 关libatomic
> --disable-libgomp         \ # 关libgomp
> --disable-libquadmath     \ # 关libquadmath
> --disable-libssp          \ # 关libssp
> --disable-libvtv          \ # 关libvtv
> --disable-libstdcxx       \ # 关libstdc++
> --enable-languages=c,c++
```

构建

```
$ make -j16
$ make install
```

上述安装会安装一些系统头文件。`limits.h`会`include`系统的`$LFS/usr/include/limits.h`，但是此时该文件还不存在。这对于构建`glibc`暂时不影响，但是后续会用到。使用以下命令创建该头文件的完整版

```
cd ..
cat gcc/limitx.h gcc/glimits.h gcc/limity.h > \
  `dirname $($LFS_TGT-gcc -print-libgcc-file-name)`/include/limits.h
```

> 上述命令将`gcc`目录下的`limitx.h` `glimits.h` `limity.h`三个文件拼起来放到`$LFS/tools/lib/gcc/x86_64-lfs-linux-gnu/14.2.0/include/limits.h`

### 2.2.4 linux-headers

解压`linux-6.13.4.tar.xz`后进入

先确定没有过时文件

```
$ make mrproper
```

仅提取头文件，放在`usr/include`下

```
$ make headers
```

删除所有非`.h`后缀的文件

```
$ find usr/include -type f ! -name '*.h' -delete
```

把头文件复制到`$LFS/usr`，注意不是放到`$LFS/tools`下

```
$ cp -r usr/include $LFS/usr
```

> 这些头文件主要包含`asm`头文件，`asm-generic`头文件，`drm`用于DRM的头文件，`linux`系统常用功能头文件，`misc`杂项头文件，`mtd`头文件，`rdma`头文件，`scsi`子系统头文件，`sound`子系统头文件，`video`子系统头文件，`xen`头文件等

### 2.2.5 glibc

`glibc`包含了一个动态链接器`ld-linux-x86-64.so.2`。先为动态链接器预先创建符号链接，因为此时还未编译安装，这两个符号链接是死链接

```
$ ln -sf ../lib/ld-linux-x86-64.so.2 $LFS/lib64/ld-linux-x86-64.so.2
$ ln -sf ../lib/ld-linux-x86-64.so.2 $LFS/lib64/ld-lsb-x86-64.so.3
```

有些`glibc`程序会把运行时的数据丢到`/var/db`，这不符合FHS。需要打前文所述[补丁](https://www.linuxfromscratch.org/patches/lfs/12.3/glibc-2.41-fhs-1.patch)

```
$ cd glibc-2.41
$ patch -Np1 -i ../glibc-2.41-fhs-1.patch
```

> `-N`表示`--forward`仅向前`patch`，忽略已经应用的`patch`以及可能的反向`patch`；`-p1`表示在文件名前面减去1个`/`

创建`build`目录

```
$ mkdir build
$ cd build
```

在`build`下创建一个文件，确保新编译出来的`ldconfig`和`sln`安装会放到`/usr/sbin`

```
$ echo "rootsbindir=/usr/sbin" > configparms
```

执行`configure`

```
$ ../configure  \
> --prefix=/usr                       \
> --host=$LFS_TGT                     \ # 使用交叉工具链
> --build=$(../scripts/config.guess)  \ # 使用交叉工具链
> --enable-kernel=5.4                 \ # 兼容linux5.4及之后的内核，不开启旧内核的workaround
> --with-headers=$LFS/usr/include     \ # 使用刚才安装的linux-headers
> --disable-nscd                      \ # 不要编译name service cache daemon，这是以前nss用来缓存域名查询记录的服务，已经弃用
> libc_cv_slibdir=/usr/lib              # 强制在64位机器上安装到/usr/lib
```

> 这里的`prefix`是相对`$LFS`而言的，安装到`$LFS/usr`，而`$LFS/usr/bin` `$LFS/usr/sbin` `$LFS/usr/lib`又分别软链接到`$LFS/bin` `$LFS/sbin` `$LFS/lib`

构建`glibc`。如果出错尝试`make -j1`（概率很小）

```
$ make -j16
$ make DESTDIR=$LFS install
```

修改一下`$LFS/usr/bin/ldd`脚本中的动态链接器路径，把`/usr`前缀都删了

```
RTLDLIST="/lib64/ld-linux-x86-64.so.2 /lib/ld-linux.so.2 /libx32/ld-linux-x32.so.2"
```

**检查工具链功能**

到`source`目录下尝试编译一下

```
$ cd ../../
$ echo "int main(){}" | $LFS_TGT-gcc -xc -
$ readelf -l a.out | grep ld-linux
      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]
```

此时`$LFS/lib64`下应当有该符号链接。删除编译出来的`a.out`

```
$ rm a.out
```

### 2.2.4 libstdc++

`libstdc++`在`gcc`源码里

```
$ cd gcc-14.2.0
```

另创一个`build`目录给`libstdc++`

```
$ mkdir build-libstdcxx
$ cd build-libstdcxx
```

运行`configure`

```
$ ../libstdc++-v3/configure       \
> --host=$LFS_TGT                 \ # 交叉编译
> --build=$(../config.guess)      \
> --prefix=/usr                   \
> --disable-multilib              \ # 纯64位
> --disable-nls                   \
> --disable-libstdcxx-pch         \ # 不安装预编译的include文件
> --with-gxx-include-dir=/tools/$LFS_TGT/include/c++/14.2.0 # 实际上是$LFS/tools/$LFS_TGT/include/c++/14.2.0，$LFS前缀是从前面编译gcc时设定的--with-sysroot参数得来，指定libstdc++ include文件的安装路径，这个路径会被g++查找
```

> 这里的`prefix`同样是相对`$LFS`而言的

构建安装`libstdc++`

```
$ make -j16
$ make DESTDIR=$LFS install
```

删除libtool archive（后缀`.la`）文件

```
$ cd $LFS/usr/lib/
$ rm *.la
```

正常应该会删除`libstdc++.la` `libstdc++exp.la` `libstdc++fs.la` `libsupc++.la`共计4个文件

到这里为止交叉工具链1就构建完成了，接下来可以开始构建其他组件

## 2.3 交叉构建基础组件

这里开始的所有基础组件是使用`$LFS/tools`下的交叉工具链1构建的，最终是直接安装在`$LFS`下，并且放在`target`机器上运行

### 2.3.1 m4

可以不创建`build`直接运行`configure`

```
$ ./configure --prefix=/usr \
> --host=$LFS_TGT           \
> --build=$(build-aux/config.guess)
```

构建

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.2 ncurses

先构建`tic`

```
$ mkdir build
$ cd build
$ ../configure AWK=gawk
$ make -C include
$ make -j16 -C progs tic
```

回到源码根目录直接运行`configure`

```
$ ./configure --prefix=/usr              \
>           --host=$LFS_TGT              \
>           --build=$(./config.guess)    \
>           --mandir=/usr/share/man      \
>           --with-manpage-format=normal \ # 不要给manpage压缩
>           --with-shared                \ # 使用动态C库
>           --without-normal             \ # 不要使用静态C库
>           --with-cxx-shared            \ # 不要包含C++ bindings
>           --without-debug              \ # 不要包含调试库
>           --without-ada                \ # 不包含ada支持
>           --disable-stripping          \ # 不要调用主机的strip命令
>           AWK=gawk
```

构建

```
$ make -j16
```

安装

```
$ make DESTDIR=$LFS TIC_PATH=$(pwd)/build/progs/tic install
$ ln -s libncursesw.so $LFS/usr/lib/libncurses.so
```

编辑`$LFS/usr/include/curses.h`，找到

```c
#if defined(_XOPEN_SOURCE_EXTENDED) || (defined(_XOPEN_SOURCE) && (_XOPEN_SOURCE - 0 >= 500))
```

改为

```c
#if 1
```

强制开`#define NCURSES_WIDECHAR 1`

> 显式指定`tic`是为了成功创建terminal database
>
> 因为我们编译出来的是wide char版本而非单char版本，所以没有名字叫`libncurses.so`的库，创建`$LFS/usr/lib/libncurses.so`为了防止后续一些build步骤找不到
>
> 编辑`$LFS/usr/include/curses.h`同样是为了支持wide char，强制开启wide char兼容的结构体

### 2.3.3 bash

直接运行`configure`

```
$ ./configure
> --prefix=/usr                         \
> --build=$(sh support/config.guess)    \
> --host=$LFS_TGT                       \
> --without-bash-malloc                   # 关闭bash自带的malloc防止segfault，调用glibc的malloc
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
$ ln -s bash $LFS/bin/sh
```

### 2.3.4 coreutils

先不要打`i18n`补丁影响时间戳否则`automake`版本会出错

直接运行`configure`

```
$ ./configure --prefix=/usr                 \
> --host=$LFS_TGT                           \
> --build=$(build-aux/config.guess)         \
> --enable-install-program=hostname         \ # 构建hostname程序，Perl测试需要用到
> --enable-no-install-program=kill,uptime     # 不构建kill和uptime程序
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

移动`chroot`，修改manpage里面所有`"1"`改为`"8"`

```
$ mv $LFS/usr/bin/chroot                    $LFS/usr/sbin
$ mkdir -p $LFS/usr/share/man/man8
$ mv $LFS/usr/share/man/man1/chroot.1       $LFS/usr/share/man/man8/chroot.8
$ sed -i 's/"1"/"8"/'                       $LFS/usr/share/man/man8/chroot.8
```

### 2.3.5 diffutils

直接运行`configure`

```
$ ./configure --prefix=/usr \
> --host=$LFS_TGT           \
> --build=$(./build-aux/config.guess)
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.6 file

被构建的`file`需要和主机上的`file`版本相同，以创建签名。创建`build`目录再`configure`，先编译一个临时的`file`

```
$ mkdir build
$ cd build
$ ../configure --disable-bzlib  \ # 都是为了防止去链接一些库
> --disable-libseccomp          \
> --disable-xzlib               \ 
> --disable-zlib 
```

回退到父目录，再次运行`configure`

```
$ cd ..
$ ./configure --prefix=/usr --host=$LFS_TGT --build=$(./config.guess)
```

构建并安装

```
$ make -j16 FILE_COMPILE=$(pwd)/build/src/file
$ make DESTDIR=$LFS install
```

删除`.la`

```
$ rm $LFS/usr/lib/libmagic.la
```

### 2.3.7 findutils

直接运行`configure`

```
$ ./configure --prefix=/usr         \
> --localstatedir=/var/lib/locate   \
> --host=$LFS_TGT                   \
> --build=$(build-aux/config.guess)
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.8 gawk

把`Makefile.in`里面所有的`extras`字符串删除，防止安装多余文件

```
$ sed -i 's/extras//' Makefile.in
```

直接运行`configure`

```
$ ./configure --prefix=/usr         \
> --host=$LFS_TGT                   \
> --build=$(build-aux/config.guess)
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.9 grep

直接运行`configure`

```
$ ./configure --prefix=/usr         \
> --host=$LFS_TGT                   \
> --build=$(./build-aux/config.guess)
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.10 gzip

直接运行`configure`

```
$ ./configure --prefix=/usr         \
> --host=$LFS_TGT
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.11 make

直接运行`configure`

```
$ ./configure --prefix=/usr     \
> --without-guile               \ # 防止使用guile
> --host=$LFS_TGT               \
> --build=$(build-aux/config.guess)
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.12 patch

直接运行`configure`

```
$ ./configure --prefix=/usr         \
> --host=$LFS_TGT                   \
> --build=$(build-aux/config.guess)
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.13 sed

直接运行`configure`

```
$ ./configure --prefix=/usr         \
> --host=$LFS_TGT                   \
> --build=$(./build-aux/config.guess)
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.14 tar

直接运行`configure`

```
$ ./configure --prefix=/usr         \
> --host=$LFS_TGT                   \
> --build=$(build-aux/config.guess)
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

### 2.3.15 xz

直接运行`configure`

```
$ ./configure --prefix=/usr         \
> --host=$LFS_TGT                   \
> --build=$(build-aux/config.guess) \
> --disable-static                  \
> --docdir=/usr/share/doc/xz-5.6.4
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

删除`.la`文件

```
$ rm $LFS/usr/lib/liblzma.la
```

### 2.3.16 binutils

Pass 2第2遍编译，目标机可以直接执行的`binutils`。注意这里的`prefix`参数变为了`/usr`

建议重新解压一下

修改`ltmain.sh`，找到`6031`行，删掉`$add_dir`

```
add_dir=" -L$inst_prefix_dir$libdir"
```

> 这是为了防止编译出的文件被错误地和主机的库进行链接。包里提供了一个`libtool`来链接内部静态库，但是包里的`libiberty`和`zlib`又不使用`libtool`

创建`build`目录再`configure`

```
$ mkdir build
$ cd build
```

```
$ ../configure                  \
> --prefix=/usr                 \
> --build=$(../config.guess)    \
> --host=$LFS_TGT               \
> --disable-nls                 \
> --enable-shared               \ # 以共享库形式构建libbfd
> --enable-gprofng=no           \
> --disable-werror              \
> --enable-64-bit-bfd           \ # 在32位平台开启64位支持。64位平台不开也行
> --enable-new-dtags            \
> --enable-default-hash-style=gnu
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

删除一些`libtool`相关文件与多余的静态库

```
$ cd $LFS/usr/lib
$ rm lib{bfd,ctf,ctf-nobfd,opcodes,sframe}.{a,la}
```

### 2.3.17 gcc

Pass 2第2遍编译，目标机可以直接执行的`gcc`。注意这里的`prefix`参数变为了`/usr`

这次是用交叉工具链1编译工具链2，而不是用主机的工具链来编译。因为前面已经编译并安装了`glibc`和`libstdc++`所以这里构建出来的工具链2具备更加完整的功能，例如支持线程

> 注意这里往后一直到目标机本地重新构建检验之前，不会再构建一遍`glibc` `libstdc++`，因为[前面](#22-构建交叉工具链1)用交叉工具链1构建出的`glibc` `libstdc++`不但可以给这个工具链2本身使用，也可以给这个工具链2的目标代码使用

建议重新解压一下。不要忘记重命名`mpfr gmp mpc`目录

修改`gcc-14.2.0`下`gcc/config/i386/t-linux64`，将`lib64`改为`lib`

```
...
MULTILIB_OSDIRNAMES = m64=../lib$(call if_multiarch,:x86_64-linux-gnu)
...
```

修改`libgcc/Makefile.in` `libstdc++-v3/include/Makefile.in`，开启`libgcc`和`libstdc++`的POSIX线程支持

在两个文件中找到`thread_header =`，替换掉`@`括起来的内容

```
thread_header = gthr-posix.h
```

创建`build`目录

```
$ mkdir build
$ cd build
```

执行`configure`

```
$ ../configure                                  \
> --build=$(../config.guess)                    \
> --host=$LFS_TGT                               \
> --target=$LFS_TGT                             \ # 因为是交叉编译，所以无法立即执行工具链2来编译libgcc和libstdc++。如果不指定该参数，默认会使用主机的工具链来编译而不是交叉工具链1。该参数保证使用交叉工具链1编译libgcc和libstdc++
> LDFLAGS_FOR_TARGET=-L$PWD/$LFS_TGT/libgcc     \ # 允许libstdc++使用本轮构建的libgcc而不是之前构建的版本，之前构建的版本无法支持C++异常处理特性，因为没有libc支持
> --prefix=/usr                                 \
> --with-build-sysroot=$LFS                     \ # host指定的路径只是指明用交叉编译器去编译，这个编译器知道应该去哪里找头文件和库，但是其他工具不知道。所以要指定一下
> --enable-default-pie                          \
> --enable-default-ssp                          \
> --disable-nls                                 \
> --disable-multilib                            \
> --disable-libatomic                           \
> --disable-libgomp                             \
> --disable-libquadmath                         \
> --disable-libsanitizer                        \ # 禁用gcc sanitizer运行时库，因为临时安装用不到。之前是通过--disable-libstdcxx连带禁用的
> --disable-libssp                              \
> --disable-libvtv                              \
> --enable-languages=c,c++
```

构建安装

```
$ make -j16
$ make DESTDIR=$LFS install
```

创建`cc`符号链接

```
$ ln -s gcc $LFS/usr/bin/cc
```

## 2.4 chroot后续构建

接下来可以在主机上`chroot`继续剩余的构建流程。到这里为止大部分棘手的循环依赖问题已经解决，并且构建机和目标机都是x86_64，所以直接利用`chroot`进行接下来的工作，使用功能更为完备的工具链2编译可以省去一些麻烦。而交叉工具链1不会再使用

但如果构建机和目标机不是相同架构，例如目标机是arm，情况就大不一样了。这种情况下，工具链2无法直接在构建机上执行，接下来的部分依旧只能使用之前的交叉工具链1构建，直到构建出Linux内核并成功在目标机上跑起来（没有物理设备当然也可以使用`qemu`）。当然在这种情况下在构建机上无法运行testsuite

> `chroot`用工具链2继续构建可以让构建前配置更简单，更加不容易出错，还能执行test看看构建出来的包功能是否正常

### 2.4.1 准备工作

先`su root`

首先修改`$LFS`下所有子目录的属主，改为`root`（`username`为原来的普通用户名）

```
# cd $LFS
# chown -R root:root *
```

创建虚拟文件系统`dev` `proc` `sys` `run`

```
# mkdir dev proc sys run
```

LFS启动时应当会自动在`dev`挂载`devtmpfs`以创建设备节点。这里先把主机的`/dev`挂过来

> 建议这里这些挂载操作写成脚本方便使用，把脚本放在`lfs`同级目录下，加上`lfs`前缀相对路径

```
# mount --bind /dev dev
```

再依次挂`devpts` `proc` `sysfs` `tmpfs`

```
# mount -t devpts devpts -o gid=5,mode=0620 dev/pts
# mount -t proc proc proc
# mount -t sysfs sysfs sys
# mount -t tmpfs tmpfs run
```

> `devpts`的`gid=5`是因为后面`tty`GID就是`5`，`mode=0620`表示属主可读写，组成员可写，这个权限设定是因为`grantpt()`，这样就没必要使用`glibc`的`pt_chown`

AlpineLinux下默认`/dev/shm`挂了一个`tmpfs`，所以也要挂一个`tmpfs`

```
# mount -t tmpfs -o nosuid,nodev tmpfs dev/shm
```

其他有些发行版里面`/dev/shm`可能是一个到`/run/shm`的软链接。这时候直接创建一个`dev/shm`即可

```
# install -d -m 1777 dev/shm
```

### 2.4.2 chroot

AlpineLinux的`chroot`在`/usr/sbin/chroot`，所以要改一下`PATH`

```
# export PATH=/usr/sbin:$PATH
```

可以写成脚本

```
# chroot lfs /usr/bin/env -i    \
> HOME=/root                    \
> TERM="$TERM"                  \
> PS1="(lfs chroot) \u:\w\$ "   \
> PATH=/usr/bin:/usr/sbin       \
> MAKEFLAG="-j16"               \
> TESTSUITEFLAGS="-j16"         \
> /bin/bash --login
```

> 有些包例如`autoconf` `libtool` `tar`不使用`MAKEFLAGS`而是`TESTSUITEFLAGS`
>
> `env -i`是为了防止当前环境变量被带入到`chroot`

另外此时还没有创建`etc/passwd`，所以`chroot`进去以后用户名显示`I have no name!`，不影响

**创建目录**

```
# mkdir boot home mnt opt srv
# mkdir -p /etc/{opt,sysconfig}
# mkdir -p /lib/firmware
# mkdir -p /media/{floppy,cdrom}
# mkdir -p /usr/{,local/}{include,src}
# mkdir -p /usr/lib/locale
# mkdir -p /usr/local/{bin,lib,sbin}
# mkdir -p /usr/{,local/}share/{color,dict,doc,info,locale,man,misc,terminfo,zoneinfo}
# mkdir -p /usr/{,local/}share/man/man{1..8}
# mkdir -p /var/{cache,local,log,mail,opt,spool}
# mkdir -p /var/lib/{color,misc,locate}
# ln -sf /run /var/run
# ln -sf /run/lock /var/lock
# install -d -m 0750 /root
# install -d -m 1777 /tmp /var/tmp
```

> 上述目录树定义在[FHS](https://refspecs.linuxfoundation.org/fhs.shtml)。可以按需自己创建目录，但是注意不要创建目录`/usr/lib64`

**创建文件，软链接和账户**

当前的`mount`列表。该文件以前在`/etc/mtab`，为兼容性需要创建符号链接

```
# ln -s /proc/self/mounts /etc/mtab
```

创建`/etc/hosts`，自己命名主机名。当前没有可用的编辑器，可以使用`cat > /etc/hosts << EOF`的方法

```
127.0.0.1   localhost   lfs-host
::1         localhost
```

创建`/etc/passwd`和`/etc/group`

```
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/dev/null:/usr/bin/false
daemon:x:6:6:Daemon User:/dev/null:/usr/bin/false
messagebus:x:18:18:D-Bus Message Daemon User:/run/dbus:/usr/bin/false
uuidd:x:80:80:UUID Generation Daemon User:/dev/null:/usr/bin/false
nobody:x:65534:65534:Unprivileged User:/dev/null:/usr/bin/false
```

```
root:x:0:
bin:x:1:daemon
sys:x:2:
kmem:x:3:
tape:x:4:
tty:x:5:
daemon:x:6:
floppy:x:7:
disk:x:8:
lp:x:9:
dialout:x:10:
audio:x:11:
video:x:12:
utmp:x:13:
cdrom:x:15:
adm:x:16:
messagebus:x:18:
input:x:24:
mail:x:34:
kvm:x:61:
uuidd:x:80:
wheel:x:97:
users:x:999:
nogroup:x:65534:
```

> 上述这些用户和组部分是因为`udev`。LSB规定要有`GID 0`的`root`，以及`GID 1`的`bin`。`GID 5`用于`tty`
>
> Linux内核中`ID 65534`会用于NFS等，在本机上没有的用户或组

创建一个测试用户和对应的组，后面要删掉

```
tester:x:101:101::/home/tester:/bin/bash
```

```
tester:x:101:
```

创建家目录

```
# install -o tester -g tester -d /home/tester
```

此时重新开一个`bash`，不会再有`I have no name!`

```
# exec /usr/bin/bash --login
```

创建一些日志文件

```
# touch /var/log/{btmp,lastlog,faillog,wtmp}
# chgrp utmp /var/log/lastlog
# chmod 664 /var/log/lastlog
# chmod 600 /var/log/btmp
```

> `wtmp`记录所有的登入和登出操作。`lastlog`记录每个用户最后一次登入时间。`faillog`和`btmp`记录登入失败操作，区别是一个用于`faillog`命令，一个用于`lastb`命令。`/run/utmp`在init期间自动创建，记录当前登入的用户。然而这些日志文件其中的时间戳有2038问题，目前已经逐步淘汰，部分软件不再使用它们

### 2.4.3 gettext

直接运行`configure`

```
# ./configure --disable-shared  # 不构建共享库
```

构建安装

```
# make -j16
# cp gettext-tools/src/{msgfmt,msgmerge,xgettext} /usr/bin
```

> 只安装`msgfmt` `msgmerge` `xgettext`

### 2.4.4 bison

直接运行`configure`

```
# ./configure --prefix=/usr --docdir=/usr/share/doc/bison-3.8.2
```

构建安装

```
# make -j16
# make install
```

### 2.4.5 perl

运行配置

```
# sh Configure -des                                 \ # 所有配置项默认，且保证所有任务完成，不print不重要的输出
> -D prefix=/usr                                    \
> -D vendorprefix=/usr                              \ # Perl安装包时模块安装的位置
> -D useshrplib                                     \ # 将libperl构建为动态库
> -D privlib=/usr/lib/perl5/5.40/core_perl          \ # Perl查找已安装模块的位置
> -D archlib=/usr/lib/perl5/5.40/core_perl          \
> -D sitelib=/usr/lib/perl5/5.40/site_perl          \
> -D sitearch=/usr/lib/perl5/5.40/site_perl         \
> -D vendorlib=/usr/lib/perl5/5.40/vendor_perl      \
> -D vendorarch=/usr/lib/perl5/5.40/vendor_perl
```

构建安装

```
# make -j16
# make install
```

### 2.4.6 python

直接运行`configure`

```
# ./configure --prefix=/usr     \
> --enable-shared               \ # 使用动态库而不是静态库
> --without-ensurepip             # 不使用pip包管理，现阶段用不上
```

构建安装

```
# make -j16
# make install
```

### 2.4.7 texinfo

直接运行`configure`

```
# ./configure --prefix=/usr
```

构建安装

```
# make -j16
# make install
```

### 2.4.8 util-linux

创建目录用来放`adjtime`文件

```
# mkdir -p /var/lib/hwclock
```

运行`configure`

```
# ./configure --libdir=/usr/lib             \ # 保证.so文件的软接直接通过相对路径指向/usr/lib下的库
> --runstatedir=/run                        \ # 指定libuuid和uuidd使用的socket位置
> --disable-chfn-chsh                       \ # 防止报warning，因为此时有些依赖还没有安装
> --disable-login                           \
> --disable-nologin                         \
> --disable-su                              \
> --disable-setpriv                         \
> --disable-runuser                         \
> --disable-pylibmount                      \
> --disable-static                          \
> --disable-liblastlog2                     \
> --without-python                          \ # 不构建python bindings
> ADJTIME_PATH=/var/lib/hwclock/adjtime     \ # 用来记CMOS时钟信息的文件，这里添加这个定义是为了防止创建不会被自动删除的多余文件
> --docdir=/usr/share/doc/util-linux-2.40.4
```

构建安装

```
# make -j16
# make install
```

### 2.4.9 清理并备份LFS目录

到这里可以备份一下当前的LFS目录，因为将当前的LFS作为`chroot`的起始点已经足以支持后续的构建。当然也可以不备份，但是之后如果遇到问题想要回退到早一些的版本会比较麻烦。此外在这里也会去掉一些冗余的部分，减小LFS体积，这对后续的构建也是有益的

**清理**

删除`/usr/share/{info,man,doc}/*`下所有的已安装文档

```
# rm -rf /usr/share/{info,man,doc}/*
```

清理`/usr/lib`和`/usr/libexec`下的`.la`文件。现在`.la`文件只对`libltdl`有用，并且LFS中`libltdl`不会加载任何库。此外`.la`文件容易导致一些包的构建失败

```
# find /usr/{lib,libexec} -name \*.la -delete
```

现在可以删除`/tools`目录，也可以选择不删，留作备用，可以把`/tools`移动出来单独备份

```
# rm -rf /tools
```

**备份**

如果按照前文所述删除文件，备份通常需要小于2GB的磁盘空间。备份压缩可能需要耗费较长的CPU时间

首先必须退出`chroot`

退出后卸载`$LFS/dev/shm` `$LFS/dev/pts` `$LFS/{sys,proc,run,dev}`（前面[挂载操作](#241-准备工作)的反操作），保证`$LFS`下没有挂载vfs，可以写成脚本

```
# cd $LFS
# umount dev/shm
# umount dev/pts
# umount sys
# umount proc
# umount run
# umount dev
```

以`root`身份打包成`tar`

```
# cd $LFS
# tar -cJpf /path/to/backup/lfs-base.tar.xz .
```

> `-c`表示创建`tar`档，`-J`表示调用`xz`压缩，`-p`表示保留所有权限设定

打包完以后想要继续构建不要忘记重新挂载vfs

**恢复**

后续想要恢复，只需解压即可，再挂载vfs即可`chroot`从头开始

```
# cd $LFS
# rm -rf ./*
# tar -xpf /path/to/backup/lfs-base.tar.xz
```

## 3 LFS：构建系统剩余部分

## 3.1 简介

这里不建议过早开额外的优化参数，最好等所有包都构建通过并且功能确认无误，再考虑尝试从顶层包开始开优化参数重构建。况且大部分包的优化参数实际上在配置中默认已经被维护者打开了，很多包都会开`-O2`或`-O3`。有些基础包例如`gcc` `glibc`尤其不建议开优化参数

此外不要将库构建为静态库版本，尽可能全部构建为动态库

## 3.2 包管理

LFS没有包管理相关内容。从前面的构建流程其实已经可以感受到给包逐个做配置的繁琐，并且后面还要考虑到如何正确地卸载或更新一个包。此外包和包之间还有依赖问题需要解决。这些都是包管理系统需要做的事情

可以考虑的包管理工具（以及配套的构建系统）：ArchLinux的`pacman`，AlpineLinux的`apk`，Debian的`apt`，或者可以尝试NixOS的`nix`

> Linux内核和用户空间之间做了很好的解耦，所以更新Linux内核通常可以完全不动用户空间的任何程序，直接安装新内核重启就可以正常使用
>
> 动态库版本更新后通常文件名会更改，导致原来链接到该动态库的程序无法运行。所有这些直接相关的程序需要同步重构建
>
> 有时候降级动态库，其文件名中的版本号（一般是后缀）会变小。如果不把版本号大的文件删除，因为`ldconfig`会默认选择版本号大的库文件，这会导致其他程序依旧链接到原来的库
>
> 更新动态库后也必须重启所有链接到该动态库的程序
>
> 更新包时，如果有相关进程正在运行，最好先停止该进程，或者至少把原来的文件删除干净再安装新的文件。`install`命令和普通的复制命令不同，`install`命令就是会在安装前先删除原来的文件

## 3.3 剩余部分构建

### 3.3.1 man-pages

**构建与安装**

先删除2个`libxcrypt`的文档，后面`libxcrypt`会安装一个更好的版本

```
# rm man3/crypt*
```

构建并安装

```
# make -R GIT=false prefix=/usr install
```

> `-R`防止`make`设定内部变量，`GIT=false`防止调用`git`（目前不可用）

### 3.3.2 iana-etc

**安装**

直接复制

```
# cp services protocols /etc
```

### 3.3.3 glibc

**构建**

先打`i18n`补丁

```
# patch -Np1 -i ../glibc-2.41-fhs-1.patch
```

创建`build`

```
# mkdir build
# cd build
```

让`ldconfig`和`sln`安装到`/usr/sbin`

```
# echo "rootsbindir=/usr/sbin" > configparms
```

```
# ../configure --prefix=/usr            \
> --disable-werror                      \ # 后面要跑test suite，所以这里关-Werror参数
> --enable-kernel=5.4                   \
> --enable-stack-protector=strong       \ # 开栈溢出保护。虽然构建gcc时会开--enable-default-ssp，但是glibc默认不会遵从这个设定
> --disable-nscd                        \ # 不构建nscd名称服务守护进程
> libc_cv_slibdir=/usr/lib                # 指定正确的库文件目录，而不是使用lib64
```

**测试**

运行testsuite

```
# make check
```

可以忽略以下警告

+ `io/tst-lchmod`错误

+ 超时错误，可以通过`grep "Timed out" $(find -name \*.out)`找到，例如`nss/tst-nss-files-hosts-multi`和`nptl/tst-thread-affinity*`。遇到这类超时可以使用`make test`例如`TIMEOUTFACTOR=10 make test t=nss/tst-nss-files-hosts-multi`重跑单个测试

+ CPU较旧可能遇到`elf/tst-cpu-features-cpuinfo`失败，构建机内核版本可能导致`stdlib/tst-arc4random-thread`失败

**安装**

安装前可以创建一个`/etc/ld.so.conf`的空文件，否则可能报错

```
# touch /etc/ld.so.conf
```

修改`Makefile`，跳过完整性检查

找到有`test-installation`的行，把`$(PERL)`改成`echo not running`

```
echo not running
```

使用`sed`命令

```
# sed '/test-installation/s@$(PERL)@echo not running@' -i ../Makefile
```

安装

```
# make install
```

修改一下`/usr/bin/ldd`脚本中的动态链接器路径，把`/usr`前缀都删了

```
# sed '/RTLDLIST=/s@/usr@@g' -i /usr/bin/ldd
```

**安装locale**

安装部分`locale`。如果不安装`locale`可能会跳过一些重要的检查点。命令较多建议写成脚本运行

```
localedef -i C -f UTF-8 C.UTF-8
localedef -i cs_CZ -f UTF-8 cs_CZ.UTF-8
localedef -i de_DE -f ISO-8859-1 de_DE
localedef -i de_DE@euro -f ISO-8859-15 de_DE@euro
localedef -i de_DE -f UTF-8 de_DE.UTF-8
localedef -i el_GR -f ISO-8859-7 el_GR
localedef -i en_GB -f ISO-8859-1 en_GB
localedef -i en_GB -f UTF-8 en_GB.UTF-8
localedef -i en_HK -f ISO-8859-1 en_HK
localedef -i en_PH -f ISO-8859-1 en_PH
localedef -i en_US -f ISO-8859-1 en_US
localedef -i en_US -f UTF-8 en_US.UTF-8
localedef -i es_ES -f ISO-8859-15 es_ES@euro
localedef -i es_MX -f ISO-8859-1 es_MX
localedef -i fa_IR -f UTF-8 fa_IR
localedef -i fr_FR -f ISO-8859-1 fr_FR
localedef -i fr_FR@euro -f ISO-8859-15 fr_FR@euro
localedef -i fr_FR -f UTF-8 fr_FR.UTF-8
localedef -i is_IS -f ISO-8859-1 is_IS
localedef -i is_IS -f UTF-8 is_IS.UTF-8
localedef -i it_IT -f ISO-8859-1 it_IT
localedef -i it_IT -f ISO-8859-15 it_IT@euro
localedef -i it_IT -f UTF-8 it_IT.UTF-8
localedef -i ja_JP -f EUC-JP ja_JP
localedef -i ja_JP -f SHIFT_JIS ja_JP.SJIS 2> /dev/null || true
localedef -i ja_JP -f UTF-8 ja_JP.UTF-8
localedef -i nl_NL@euro -f ISO-8859-15 nl_NL@euro
localedef -i ru_RU -f KOI8-R ru_RU.KOI8-R
localedef -i ru_RU -f UTF-8 ru_RU.UTF-8
localedef -i se_NO -f UTF-8 se_NO.UTF-8
localedef -i ta_IN -f UTF-8 ta_IN.UTF-8
localedef -i tr_TR -f UTF-8 tr_TR.UTF-8
localedef -i zh_CN -f GB18030 zh_CN.GB18030
localedef -i zh_HK -f BIG5-HKSCS zh_HK.BIG5-HKSCS
localedef -i zh_TW -f UTF-8 zh_TW.UTF-8
```

如果想要安装全部`locale`（`glibc-2.41/localedata/SUPPORTED`里列出的）

```
# make localedata/install-locales
```

如果还想要安装遗漏的`locale`示例

```
# localedef -i C -f UTF-8 C.UTF-8
# localedef -i ja_JP -f SHIFT_JIS ja_JP.SJIS 2> /dev/null || true
```

**小版本升级**

以下步骤需要按顺序完成

+ 如果是从LFS12.0之前的版本升级，需要安装`libxcrypt`[3.3.25](#3325-libxcrypt)，用`libcrypt.so.1*`替换掉`libcrypt.so.1`

+ 如果是在LFS12.1前的系统，需要删除`/usr/sbin/nscd`

+ 如果用的是`5.4`之前的老内核，需要同时更新内核和内核头文件

+ 使用`DESTDIR`先把动态库安装到一个临时目录，再`install`到`/usr/lib`

```
# make DESTDIR=$PWD/dest install
# install -vm755 dest/usr/lib/*.so.* /usr/lib
```

+ 执行`make install`安装

+ 修改一下`/usr/bin/ldd`脚本中的动态链接器路径，把`/usr`前缀都删了

```
RTLDLIST="/lib64/ld-linux-x86-64.so.2 /lib/ld-linux.so.2 /libx32/ld-linux-x32.so.2"
```

+ 安装`locale`

+ 立即重启

+ 重启后如果是LFS12.0之前的版本，构建时没有使用`--disable-fixincludes`参数，需要将`/usr/lib/gcc/x86_64-lfs-linux-gnu/xx.x.x/include-fixed`下两个文件`limits.h`和`syslimits.h`移动到`/usr/lib/gcc/x86_64-lfs-linux-gnu/xx.x.x/include`下，同时删除`/usr/lib/gcc/x86_64-lfs-linux-gnu/xx.x.x/include-fixed`下其他所有文件。更新的版本不需要

**NSS配置**

`glibc`需要依赖于`/etc/nsswitch.conf`，否则网络功能不正常

```
passwd: files
group: files
shadow: files

hosts: files dns
networks: files

protocols: files
services: files
ethers: files
rpc: files
```

**时区配置**

解压`tzdata2025a.tar.gz`到当前目录

```
# tar -xf ../../tzdata2025a.tar.gz
```

创建目录（也可以不创建，后面也不用在里面创建时区，但是部分应用或testsuite可能会出错）

```
# mkdir /usr/share/zoneinfo/{posix,right}
```

依次创建`posix`时区，`right`时区（包含`leapseconds`）

```
for tz in etcetera southamerica northamerica europe africa antarctica \
    asia australasia backward; do
    zic -L /dev/null   -d $ZONEINFO       ${tz}
    zic -L /dev/null   -d $ZONEINFO/posix ${tz}
    zic -L leapseconds -d $ZONEINFO/right ${tz}
done
```

把`zone.tab` `zone1970.tab` `iso3166.tab`放到`/usr/share/zoneinfo`

```
# cp zone.tab zone1970.tab iso3166.tab /usr/share/zoneinfo
```

创建`posixrules`。因为POSIX规定夏令时以美国时间为准，所以这里选纽约时间

```
# zic -d /usr/share/zoneinfo -p America/New_York
# unset tz
```

查找时区名称

```
# tzselect
```

依照上述命令的结果设定时区，示例

```
ln -sf /usr/share/zoneinfo/Asia/Hong_Kong /etc/localtime
```

**动态链接器配置**

`/lib/ld-linux.so.2`默认只会从`/usr/lib`找动态库。需要在`/etc/ld.so.conf`添加额外路径

```
/usr/local/lib
/opt/lib
```

`/etc/ld.so.conf`还可以包含其他文件，添加以下行

```
include /etc/ld.so.conf.d/*.conf
```

创建目录

```
# mkdir -p /etc/ld.so.conf.d
```

### 3.3.4 zlib

**构建**

```
# ./configure --prefix=/usr
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

删除一个无用静态库

```
# rm -f /usr/lib/libz.a
```

### 3.3.5 bzip2

**构建**

先打文档补丁

```
# patch -Np1 -i ../bzip2-1.0.8-install_docs-1.patch
```

确保符号链接是相对路径，将所有`ln -s -f $(PREFIX)/bin/`前缀删除

```
# sed -i 's@\(ln -s -f \)$(PREFIX)/bin/@\1@' Makefile
```

确保man pages安装到正确位置，安装到`/usr/share/man`

```
# sed -i "s@(PREFIX)/man@(PREFIX)/share/man@g" Makefile
```

使用`Makefile-libbz2_so`构建，这样先构建出`libbz2.so`，后面其他程序动态链接到这个库

```
# make -j16 -f Makefile-libbz2_so
# make clean
```

再执行`make`

```
# make -j16
```

**安装**

```
# make PREFIX=/usr install
```

安装动态库

```
# cp -a libbz2.so.* /usr/lib
# ln -s libbz2.so.1.0.8 /usr/lib/libbz2.so
```

删除静态库

```
# rm /usr/lib/libbz2.a
```

安装共享库分离版`bzip2`

```
# cp bzip2-shared /usr/bin/bzip2
# ln -sf bzip2 /usr/bin/bzcat
# ln -sf bzip2 /usr/bin/bunzip2
```

### 3.3.6 xz

**构建**

```
# ./configure --prefix=/usr     \
> --disable-static              \
> --docdir=/usr/share/doc/xz-5.6.4
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.7 lz4

**构建**

```
# make -j16 BUILD_STATIC=no PREFIX=/usr
```

**测试**

```
# make -j1 check
```

**安装**

```
# make BUILD_STATIC=no PREFIX=/usr install
```

### 3.3.8 zstd

**构建**

```
# make -j16 prefix=/usr
```

**测试**

```
# make check
```

**安装**

```
# make prefix=/usr install
```

删除静态库

```
# rm /usr/lib/libzstd.a
```

### 3.3.9 file

**构建**

```
# ./configure --prefix=/usr
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.10 readline

**构建**

重新安装`readline`默认会把原来的库文件重命名为`.old`后缀。这可能导致`ldconfig`出错。修改一下`Makefile.in`和`support/shlib-install`，分别删除`MV.*old`操作，以及把`{OLDSUFF}`的行替换为`:`字符

```
# sed -i '/MV.*old/d' Makefile.in
# sed -i '/{OLDSUFF}/c:' support/shlib-install
```

从`support/shobj-conf`删除`rpath`库查找目录

```
# sed -i 's/-Wl,-rpath,[^ ]*//' support/shobj-conf
```

配置

```
# ./configure --prefix=/usr     \ 
> --disable-static              \
> --with-curses                 \ # 指示可以从curses库里找到termcap库的功能，没有单独的termcap库。这样可以生成正确的readline.pc
> --docdir=/usr/share/doc/readline-8.2.13
```

构建，强制链接`lncursesw`

```
# make -j16 SHLIB_LIBS="-lncursesw"
```

**安装**

```
# make install
```

安装文档

```
# install -v -m644 doc/*.{ps,pdf,html,dvi} /usr/share/doc/readline-8.2.13
```

### 3.3.11 m4

**构建**

```
# ./configure --prefix=/usr
# make -j16
```

**安装**

```
# make install
```

### 3.3.12 bc

**构建**

```
# CC=gcc ./configure --prefix=/usr -G -O3 -r # -G省略一些测试项，-r使用readline
# make -j16
```

**测试**

```
# make test
```

**安装**

```
# make install
```

### 3.3.13 flex

**构建**

```
# ./configure --prefix=/usr \
> --docdir=/usr/share/doc/flex-2.6.4 \
> --disable-static
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
# ln -s flex /usr/bin/lex
# ln -s flex.1 /usr/share/man/man1/lex.1
```

### 3.3.14 tcl

**构建**

```
# SRCDIR=$(pwd)
# cd unix
# ./configure --prefix=/usr     \
> --mandir=/usr/share/man       \
> --disable-rpath                 # 不要把库搜索路径硬编码进二进制文件里
```

```
# make -j16
```

修改一下配置脚本，把里面源码路径改为安装路径，这些配置脚本后面会被其他使用`tcl`的包用到

```
# sed -e "s|$SRCDIR/unix|/usr/lib|"     \
> -e "s|$SRCDIR|/usr/include|"          \
> -i tclConfig.sh

# sed -e "s|$SRCDIR/unix/pkgs/tdbc1.1.10|/usr/lib/tdbc1.1.10|"  \
> -e "s|$SRCDIR/pkgs/tdbc1.1.10/generic|/usr/include|"          \
> -e "s|$SRCDIR/pkgs/tdbc1.1.10/library|/usr/lib/tcl8.6|"       \
> -e "s|$SRCDIR/pkgs/tdbc1.1.10|/usr/include|"                  \
> -i pkgs/tdbc1.1.10/tdbcConfig.sh

# sed -e "s|$SRCDIR/unix/pkgs/itcl4.3.2|/usr/lib/itcl4.3.2|"    \
> -e "s|$SRCDIR/pkgs/itcl4.3.2/generic|/usr/include|"           \
> -e "s|$SRCDIR/pkgs/itcl4.3.2|/usr/include|"                   \
> -i pkgs/itcl4.3.2/itclConfig.sh
```

```
# unset SRCDIR
```

**测试**

```
# make test
```

**安装**

```
# make install
```

将库改为可写，后续可以删除调试符号

```
# chmod u+w /usr/lib/libtcl8.6.so
```

安装头文件

```
# make install-private-headers
```

符号链接

```
# ln -sf tclsh8.6 /usr/bin/tclsh
```

重命名和`perl`冲突的头文件

```
# mv /usr/share/man/man3/{Thread,Tcl_Thread}.3
```

安装文档

```
# cd ..
# tar -xf ../tcl8.6.16-html.tar.gz --strip-components=1
# mkdir -p /usr/share/doc/tcl-8.6.16
# cp -r  ./html/* /usr/share/doc/tcl-8.6.16
```

### 3.3.15 expect

**构建**

先检查一下PTY是否正常工作，应当返回`ok`，否则需要检查是不是vfs是否正确挂载

```
# python3 -c 'from pty import spawn; spawn(["echo", "ok"])'
```

打补丁

```
# patch -Np1 -i ../expect-5.45.4-gcc14-1.patch
```

```
# ./configure --prefix=/usr         \
> --with-tcl=/usr/lib               \ # tclConfig.sh所在位置
> --enable-shared                   \
> --disable-rpath                   \
> --mandir=/usr/share/man           \
> --with-tclinclude=/usr/include      # tcl头文件
```

```
# make -j16
```

**测试**

```
# make test
```

**安装**

```
# make install
# ln -sf expect5.45.4/libexpect5.45.4.so /usr/lib
```

### 3.3.16 dejagnu

**构建**

```
# mkdir build
# cd build
# ../configure --prefix=/usr
# makeinfo --html --no-split -o doc/dejagnu.html ../doc/dejagnu.texi
# makeinfo --plaintext       -o doc/dejagnu.txt  ../doc/dejagnu.texi
```

**测试**

```
# make check
```

**安装**

```
# make install
# install -dm755  /usr/share/doc/dejagnu-1.6.3
# install -m644   doc/dejagnu.{html,txt} /usr/share/doc/dejagnu-1.6.3
```

### 3.3.17 pkgconf

**构建**

```
# ./configure --prefix=/usr             \
> --disable-static                      \
> --docdir=/usr/share/doc/pkgconf-2.3.0
# make -j16
```

**安装**

```
# make install
# ln -s pkgconf   /usr/bin/pkg-config
# ln -s pkgconf.1 /usr/share/man/man1/pkg-config.1
```

### 3.3.18 binutils

**构建**

```
# mkdir build
# cd build
# ../configure --prefix=/usr    \
> --sysconfdir=/etc             \
> --enable-ld=default           \ # 构建默认bfd链接器，安装为ld和ld.bfd
> --enable-plugins              \ # 开启插件支持
> --enable-shared               \
> --disable-werror              \
> --enable-64-bit-bfd           \
> --enable-new-dtags            \
> --with-system-zlib            \ # 使用已安装的zlib
> --enable-default-hash-style=gnu
```

```
# make -j16 tooldir=/usr
```

> 设定`tooldir`是为了强制安装到`/usr`，防止安装到`/usr/x86_64-pc-linux-gnu`，这是交叉工具链才会安装的地方

**测试**

```
# make -k check
```

检查是否有失败项目

```
# grep '^FAIL:' $(find -name '*.log')
```

**安装**

```
# make tooldir=/usr install
```

删除一些没有用的静态库

```
# rm -rf /usr/lib/lib{bfd,ctf,ctf-nobfd,gprofng,opcodes,sframe}.a /usr/share/doc/gprofng/
```

### 3.3.19 gmp

**构建**

GMP默认会检测主机CPU的特性并开启相应优化支持，例如使用较新的指令集。如果目标机CPU比构建机更老，尤其在AVX/SSE/FMA等指令支持有所不同时，建议加上`--host=none-linux-gnu`参数来兼容

```
# ./configure --prefix=/usr         \
> --enable-cxx                      \ # 开C++支持
> --disable-static                  \
> --docdir=/usr/share/doc/gmp-6.3.0
```

```
# make -j16
# make html
```

**测试**

```
# make check 2>&1 | tee gmp-check-log
# awk '/# PASS:/{total+=$3} ; END{print total}' gmp-check-log
```

> 确保至少通过199项测试

**安装**

```
# make install
# make install-html
```

### 3.3.20 mpfr

**构建**

```
# ./configure --prefix=/usr         \
> --disable-static                  \
> --enable-thread-safe              \
> --docdir=/usr/share/doc/mpfr-4.2.1
```

```
# make -j16
# make html
```

**测试**

```
# make check
```

**安装**

```
# make install
# make install-html
```

### 3.3.21 mpc

**构建**

```
# ./configure --prefix=/usr         \
> --disable-static                  \
> --docdir=/usr/share/doc/mpc-1.3.1
```

```
# make -j16
# make html
```

**测试**

```
# make check
```

**安装**

```
# make install
# make install-html
```

### 3.3.22 attr

**构建**

```
# ./configure --prefix=/usr     \
> --disable-static              \
> --sysconfdir=/etc             \
> --docdir=/usr/share/doc/attr-2.5.2
```

```
# make -j16
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.23 acl

**构建**

```
# ./configure --prefix=/usr     \
> --disable-static              \
> --docdir=/usr/share/doc/acl-2.3.2
```

```
# make -j16
```

**测试**

```
# make check
```

> 这里`test/cp.test`会fail是正常的，因为`coreutils`还没有重新编译为支持`acl`的

**安装**

```
# make install
```

### 3.3.24 libcap

**构建**

防止安装静态库，删除`libcap/Makefile`里面`install -m.*STA`的行

```
# sed -i '/install -m.*STA/d' libcap/Makefile
```

```
# make -j16 prefix=/usr lib=lib
```

**测试**

```
# make test
```

**安装**

```
# make prefix=/usr lib=lib install
```

### 3.3.25 libxcrypt

**构建**

```
# ./configure --prefix=/usr             \
> --enable-hashes=strong,glibc          \ # 包括加强的哈希算法以及兼容glibc libcrypt的哈希算法
> --enable-obsolete-api=no              \ # 禁用旧接口
> --disable-static                      \
> --disable-failure-tokens                # 禁用failure token特性，因为这是glibc平台。failure token在部分平台提供旧有哈希库的兼容
```

```
# make -j16
```

> 如果有使用闭源软件的需求，并且该软件会链接到该库且要求ABI Version 1，可能会有开`obsolete api`的需求。这种情况在最后安装完以后需要再执行如下命令

```
# ./configure --prefix=/usr         \
> --enable-hashes=strong,glibc      \
> --enable-obsolete-api=glibc       \
> --disable-static                  \
> --disable-failure-tokens
# cp -a --remove-destination .libs/libcrypt.so.1* /usr/lib
```

**测试**

```
# make check
```

**安装**

```
# make install
```

### 3.3.26 shadow

如果想要使用`pam`强制使用强密码，在构建`shadow`之前需要先构建安装`pam`，之后再构建安装`shadow`。在BLFS阶段会有讲述

**构建**

禁止安装`groups`以及对应man pages，从Makefile中删除，因为前面`coreutils`已经包含了这些内容。加上禁止一些其他的man page的安装，前面在安装`man-pages`包的时候已经安装过了

```
# sed -i 's/groups$(EXEEXT) //' src/Makefile.in
# find man -name Makefile.in -exec sed -i 's/groups\.1 / /'   {} \;
# find man -name Makefile.in -exec sed -i 's/getspnam\.3 / /' {} \;
# find man -name Makefile.in -exec sed -i 's/passwd\.5 / /'   {} \;
```

`shadow`如果不配置默认会用`crypt`加密密码。需要配置成`YESCRYPT`以支持8字符以上的密码

```
# sed 's:#ENCRYPT_METHOD DES:ENCRYPT_METHOD YESCRYPT:' -i etc/login.defs
```

将邮件路径从`/var/spool/mail`改到`/var/mail`

```
# sed 's:/var/spool/mail:/var/mail:' -i etc/login.defs
```

禁止将`/bin`和`/sbin`添加到`PATH`

```
# sed '/PATH=/{s@/sbin:@@;s@/bin:@@}' -i etc/login.defs
```

执行`configure`

```
# touch /usr/bin/passwd
# ./configure --sysconfdir=/etc     \
> --disable-static                  \
> --with-{b,yes}crypt               \ # 使用libxcrypt的bcrypt和yescrypt哈希算法，比传统SHA算法具备更高的安全性，不易通过GPU暴力破解
> --without-libbsd                  \ # 不要使用libbsd的readpassphrase，使用内置函数读取
> --with-group-name-max-length=32     # 组名最长允许32字节。用户名最长默认允许32字节
```

> 先创建`/usr/bin/passwd`是为了防止安装到错误的路径

```
# make -j16
```

**安装**

```
# make exec_prefix=/usr install
# make -C man install-man
```

**配置**

`shadow`包含了很多用于管理账户的命令，常用的有`passwd` `chsh` `groupadd` `groupmod` `login` `su` `useradd` `usermod`等

如果使用了`shadow`，确保一些需要密码验证的应用兼容`shadow`以及其密码

开启shadowed passwords

```
# pwconv
```

开启shadowed用户组密码

```
# grpconv
```

最后可以按需设定用户密码

```
# passwd root
```

> 创建新用户和组默认从`1000`开始分配新的ID。如果默认配置可以满足需求，到这里为止就可以结束了
>
> 如果默认的创建用户行为不满足需求，可以通过`/etc/default/useradd`配置添加新用户的默认行为。该配置文件必须使用以下命令创建

```
# useradd -D --gid 999
```

> 上述命令创建`/etc/default/useradd`，其中有参数`GROUP=999`表示从`999`开始分配新的GID，`CREATE_MAIL_SPOOL=yes`为每个新用户创建一个邮件目录，目录属于`mail`用户组并且权限`0660`。如果不想创建邮件文件，改成`no`就行

### 3.3.27 gcc

第3遍构建

**构建**

和前面一样把`lib64`改为`lib`

```
# sed '/m64=/s/lib64/lib/' -i.orig gcc/config/i386/t-linux64
```

创建`build`目录并在其中构建

```
# mkdir build
# cd build
# ../configure --prefix=/usr    \
> LD=ld                         \ # 使用最近安装的ld，不要使用交叉工具链的
> --enable-languages=c,c++      \
> --enable-default-pie          \ # 位置无关可执行文件。如果不开启，ASLR只会对动态库有效；开启后对可执行文件也有效
> --enable-default-ssp          \ # 开启加强的栈溢出攻击防护
> --enable-host-pie             \
> --disable-multilib            \
> --disable-bootstrap           \
> --disable-fixincludes         \ # 禁止自行修正系统头文件
> --with-system-zlib              # 使用系统zlib库
```

```
# make -j16
```

**测试**

虽然默认不限制栈大小，还是建议显式设定一下栈限制

```
# ulimit -s -H unlimited
```

删除一些会失败的测试

```
# sed -e '/cpython/d' -i ../gcc/testsuite/gcc.dg/plugin/plugin.exp
# sed -e 's/no-pic /&-no-pie /' -i ../gcc/testsuite/gcc.target/i386/pr113689-1.c
# sed -e 's/300000/(1|300000)/' -i ../libgomp/testsuite/libgomp.c-c++-common/pr109062.c
# sed -e 's/{ target nonpic } //' \
> -e '/GOTPCREL/d' -i ../gcc/testsuite/gcc.target/i386/fentryname3.c
```

使用前面创建的`tester`用户身份执行测试

```
# chown -R tester .
# su tester -c "PATH=$PATH make -k -j16 check"
```

查看结果

```
# ../contrib/test_summary | grep -A7 Summ
```

> 可以和`https://gcc.gnu.org/ml/gcc-testresults/`对比。`tsan`测试可能会fail，不影响

**安装**

```
# make install
```

把`/usr/lib/gcc/x86_64-pc-linux-gnu/14.2.0/include{,-fixed}`属主从`tester`改回`root`

```
# chown -R root:root \
> /usr/lib/gcc/x86_64-pc-linux-gnu/14.2.0/include{,-fixed}
```

创建`/usr/lib`符号链接

```
# ln -sr /usr/bin/cpp /usr/lib
```

man page符号链接。而`gcc`本体对应`cc`前面已经创建过所以这里不再创建

```
# ln -s gcc.1 /usr/share/man/man1/cc.1
```

LTO（Link Time Optimization）符号链接

```
# ln -sf ../../libexec/gcc/x86_64-pc-linux-gnu/14.2.0/liblto_plugin.so \
> /usr/lib/bfd-plugins/
```

移动一下`/usr/lib/*gdb.py`

```
# mkdir -p /usr/share/gdb/auto-load/usr/lib
# mv /usr/lib/*gdb.py /usr/share/gdb/auto-load/usr/lib
```

**检验**

试编译一下，用`readelf`看一下动态链接器路径

```
# echo 'int main(){}' > dummy.c
# cc dummy.c -v -Wl,--verbose &> dummy.log
# readelf -l a.out
```

从`log`里看一下是否使用了正确的start文件

```
# grep -E -o '/usr/lib.*/S?crt[1in].*succeeded' dummy.log
```

应该输出大致如下示例，确认找到所有3个`crt*.o`就行

```
/usr/lib/gcc/x86_64-pc-linux-gnu/14.2.0/../../../../lib/Scrt1.o succeeded
/usr/lib/gcc/x86_64-pc-linux-gnu/14.2.0/../../../../lib/crti.o succeeded
/usr/lib/gcc/x86_64-pc-linux-gnu/14.2.0/../../../../lib/crtn.o succeeded
```

从`log`里看一下确认`gcc`查找了正确的头文件

```
# grep -B4 '^ /usr/include' dummy.log
```

输出应该大致如下

```
#include <...> search starts here:
 /usr/lib/gcc/x86_64-pc-linux-gnu/14.2.0/include
 /usr/local/include
 /usr/lib/gcc/x86_64-pc-linux-gnu/14.2.0/include-fixed
 /usr/include
```

从`log`里看一下链接器查找库的路径是否正确

```
# grep 'SEARCH.*/usr/lib' dummy.log |sed 's|; |\n|g'
```

输出应该大致如下

```
SEARCH_DIR("/usr/x86_64-pc-linux-gnu/lib64")
SEARCH_DIR("/usr/local/lib64")
SEARCH_DIR("/lib64")
SEARCH_DIR("/usr/lib64")
SEARCH_DIR("/usr/x86_64-pc-linux-gnu/lib")
SEARCH_DIR("/usr/local/lib")
SEARCH_DIR("/lib")
SEARCH_DIR("/usr/lib");
```

从`log`里看一下是否使用了正确的`libc`

```
# grep "/lib.*/libc.so.6 " dummy.log
```

输出结果

```
attempt to open /usr/lib/libc.so.6 succeeded
```

从`log`里看一下是否使用了正确的动态链接器

```
# grep found dummy.log
```

输出结果

```
found ld-linux-x86-64.so.2 at /usr/lib/ld-linux-x86-64.so.2
```

检查无误后删除

```
# rm dummy.c dummy.log a.out
```

### 3.3.28 ncurses

**构建**

```
# ./configure --prefix=/usr                     \
> --mandir=/usr/share/man                       \
> --with-shared                                 \ # 构建安装动态库
> --without-debug                               \ # 不构建调试库
> --without-normal                              \ # 不构建静态库
> --with-cxx-shared                             \ # 构建安装c++ bindind动态库，不构建静态库
> --enable-pc-files                             \ # 为pkg-config生成安装.pc文件
> --with-pkg-config-libdir=/usr/lib/pkgconfig
```

```
# make -j16
```

> 如果一定要非宽字符版的支持，最后安装完以后可以再通过以下命令构建安装

```
# make distclean
# ./configure --prefix=/usr     \
> --with-shared                 \
> --without-normal              \
> --without-debug               \
> --without-cxx-binding         \
> --with-abi-version=5
# make sources libs
# cp -av lib/lib*.so.5* /usr/lib
```

**安装**

先临时安装到`dest`，再把`libncursesw.so.6.5`通过`install`安装到`/usr/lib`，而不是直接覆写。这在实际应用中有意义，可以防止正在使用`libncursesw`的进程失败。此外修改`curses.h`支持宽字符wchar

```
# make DESTDIR=$PWD/dest install
# install -vm755 dest/usr/lib/libncursesw.so.6.5 /usr/lib
# rm dest/usr/lib/libncursesw.so.6.5
# sed -e 's/^#if.*XOPEN.*$/#if 1/' \
> -i dest/usr/include/curses.h
# cp -a dest/* /
```

创建符号链接，诱导依旧还在使用非宽字符的软件使用宽字符版的库

```
for lib in ncurses form panel menu ; do
    ln -sfv lib${lib}w.so /usr/lib/lib${lib}.so
    ln -sfv ${lib}w.pc    /usr/lib/pkgconfig/${lib}.pc
done
```

创建`libcurses.so`符号链接到`libncursesw.so`

```
# ln -sf libncursesw.so /usr/lib/libcurses.so
```

安装文档

```
# cp -v -R doc -T /usr/share/doc/ncurses-6.5
```

### 3.3.29 sed

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.30 psmisc

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.31 gettext

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.32 bison

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.33 grep

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.34 bash

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.35 libtool

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.36 gdbm

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.37 gperf

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.38 expat

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.39 inetutils

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.40 less

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.41 perl

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.42 xml::parser

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.43 intltool

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.44 autoconf

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.45 automake

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.46 openssl

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.47 libelf from elfutils

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.48 libffi

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.49 python

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.50 flit-core

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.51 wheel

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.52 setuptools

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.53 ninja

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.54 meson

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.55 kmod

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.56 coreutils

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.57 check

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.58 diffutils

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.59 gawk

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.60 findutils

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.61 groff

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.62 grub

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.63 gzip

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.64 iproute2

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.65 kbd

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.66 libpipeline

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.67 make

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.68 patch

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.69 tar

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.70 texinfo

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.71 vim

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.72 markupsafe

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.73 jinja2

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.74 udev from systemd

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.75 man-db

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.76 procps-ng

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```
### 3.3.77 util-linux

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.78 e2fsprogs

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.79 sysklogd

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

### 3.3.80 sysvinit

**构建**

```
# 
```

**测试**

```
# 
```

**安装**

```
# 
```

## 4 LFS：系统配置

## 5 LFS：内核编译与UEFI启动引导

## 6 BLFS